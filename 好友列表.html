<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>好友列表</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Ma+Shan+Zheng&display=swap');

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #f5f3e8;
        min-height: 100vh;
        font-family: 'Noto Sans JP', 'Microsoft YaHei', sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      /* 外框包裹层 */
      .phone-shell {
        padding: 8px;
        background: #e8d5a3; /* 米黄色外壳 */
        border-radius: 40px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        display: inline-block;
      }

      .container {
        width: 255px; /* 调整为255px宽度 */
        height: 650px; /* 手机高度 */
        background: #ffffff; /* 机身本体纯白 */
        border-radius: 38px;
        box-shadow: inset 0 0 0 2px #d4c294; /* 内描边，呼应外壳 */
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: fadeInUp 0.8s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .status-bar {
        height: 30px;
        background: #f7f5e8;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        font-size: 13px;
        color: #8b7355;
        box-shadow: 0 1px 0 #e7e5d8;
      }

      .header {
        background: linear-gradient(135deg, #d4c294 0%, #c9b882 100%);
        color: #8b7355;
        padding: 25px;
        position: relative;
        text-align: center;
        border-bottom: 1px solid rgba(139, 115, 85, 0.2);
      }

      .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .header h1 {
        font-family: 'Ma Shan Zheng', cursive;
        font-size: clamp(24px, 4vw, 28px);
        font-weight: 700;
        letter-spacing: 2px;
        text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 20px rgba(212, 194, 148, 0.5);
        animation: glow 2s ease-in-out infinite alternate;
        position: relative;
        z-index: 1;
      }

      @keyframes glow {
        from {
          text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 20px rgba(212, 194, 148, 0.5);
        }
        to {
          text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 30px rgba(212, 194, 148, 0.7);
        }
      }

      .add-btn {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(212, 194, 148, 0.3);
        border: 1px solid rgba(212, 194, 148, 0.5);
        color: #8b7355;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        z-index: 2;
      }

      .add-btn:hover {
        background: rgba(212, 194, 148, 0.5);
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 15px rgba(212, 194, 148, 0.4);
      }

      .friends-list {
        padding: 5px;
        background: #faf9f4;
        flex: 1;
        overflow-y: auto;
        max-height: calc(650px - 36px - 95px); /* 减去状态栏和header高度 */
      }

      /* 自定义滚动条样式 */
      .friends-list::-webkit-scrollbar {
        width: 6px;
      }

      .friends-list::-webkit-scrollbar-track {
        background: rgba(212, 194, 148, 0.1);
        border-radius: 3px;
      }

      .friends-list::-webkit-scrollbar-thumb {
        background: rgba(212, 194, 148, 0.4);
        border-radius: 3px;
      }

      .friends-list::-webkit-scrollbar-thumb:hover {
        background: rgba(212, 194, 148, 0.6);
      }

      /* --- 修改部分：列表项样式 --- */
      .friend-item {
        display: flex;
        align-items: center;
        padding: 12px; /* 减小内边距 */
        margin-bottom: 8px; /* 减小外边距 */
        border-radius: 12px; /* 减小圆角 */
        cursor: pointer;
        transition: all 0.3s ease;
        background: #ffffff;
        border: 1px solid rgba(212, 194, 148, 0.2);
        box-shadow: 0 2px 8px rgba(212, 194, 148, 0.1);
        position: relative;
        overflow: hidden;
      }

      .friend-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(212, 194, 148, 0.1), transparent);
        transition: left 0.5s;
      }

      .friend-item:hover::before {
        left: 100%;
      }

      .friend-item:hover {
        background: #f9f7f0;
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 8px 25px rgba(212, 194, 148, 0.2);
        border-color: rgba(212, 194, 148, 0.4);
      }

      .friend-avatar {
        width: 45px; /* 减小头像宽度 */
        height: 45px; /* 减小头像高度 */
        border-radius: 50%;
        background: linear-gradient(135deg, #d4c294 0%, #c9b882 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #8b7355;
        font-weight: bold;
        margin-right: 12px; /* 减小右边距 */
        font-size: 16px; /* 减小头像内字体大小 */
        text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.2);
        box-shadow: 0 4px 15px rgba(212, 194, 148, 0.3);
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
        flex-shrink: 0; /* 防止头像被压缩 */
      }

      .friend-item:hover .friend-avatar {
        transform: scale(1.1) rotate(5deg);
        box-shadow: 0 6px 20px rgba(212, 194, 148, 0.4);
      }

      .friend-info {
        flex: 1;
        position: relative;
        z-index: 1;
        overflow: hidden; /* 防止文字溢出 */
      }

      .friend-name {
        font-size: 15px; /* 减小名字体大小 */
        font-weight: 500;
        color: #8b7355;
        margin-bottom: 4px; /* 减小间距 */
        text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.1);
        letter-spacing: 0.5px;
        white-space: nowrap; /* 不换行 */
        text-overflow: ellipsis; /* 溢出显示省略号 */
        overflow: hidden;
      }

      .friend-type {
        font-size: 12px; /* 减小类型字体大小 */
        color: rgba(139, 115, 85, 0.7);
        font-weight: 300;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }
      /* --- 修改结束 --- */

      .group-badge {
        background: rgba(212, 194, 148, 0.8);
        color: #8b7355;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        margin-left: 10px;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(212, 194, 148, 0.5);
        font-weight: 400;
        text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.1);
      }

      .pinned-badge {
        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        color: white;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 10px;
        margin-left: 8px;
        font-weight: 500;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
      }

      .friend-item.pinned {
        background: linear-gradient(135deg, #fff9e6, #fff5d6);
        border-color: rgba(255, 193, 7, 0.3);
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
      }

      .friend-item.pinned:hover {
        background: linear-gradient(135deg, #fff7e0, #fff2cc);
        border-color: rgba(255, 193, 7, 0.5);
      }

      .friend-actions {
        display: flex;
        gap: 8px;
        margin-left: auto;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .friend-item:hover .friend-actions {
        opacity: 1;
      }

      .action-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
        backdrop-filter: blur(5px);
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      .action-btn:hover {
        transform: scale(1.1);
      }

      .action-btn:active {
        transform: scale(0.95);
      }

      .pin-btn {
        background: rgba(255, 193, 7, 0.8);
        color: white;
      }
      .pin-btn:hover {
        background: rgba(255, 193, 7, 1);
      }
      .pin-btn.pinned {
        background: rgba(255, 107, 107, 0.8);
      }
      .pin-btn.pinned:hover {
        background: rgba(255, 107, 107, 1);
      }

      .delete-btn {
        background: rgba(255, 107, 107, 0.8);
        color: white;
      }
      .delete-btn:hover {
        background: rgba(255, 107, 107, 1);
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
      }

      /* --- 优化部分：统一弹窗样式 --- */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      }

      .modal-content {
        background: white;
        padding: 25px;
        border-radius: 15px;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.4s ease-out;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          transform: translateY(-30px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 15px;
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 18px;
        color: #333;
      }

      .close-btn {
        border: none;
        background: transparent;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        padding: 0;
        line-height: 1;
        transition: color 0.2s;
      }
      .close-btn:hover {
        color: #333;
      }
      .modal-body {
        overflow-y: auto;
        padding-right: 10px;
        margin-right: -10px;
      }
      /* --- 优化结束 --- */

      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: 500;
      }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }
      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }
      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
      }
      .btn-primary {
        background: #667eea;
        color: white;
      }
      .btn-primary:hover {
        background: #5a6fd8;
      }
      .btn-secondary {
        background: #e9ecef;
        color: #6c757d;
      }
      .btn-secondary:hover {
        background: #dee2e6;
      }

      /* 导入/导出区域样式 */
      .import-export-section {
        margin-bottom: 15px;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
      }
      .import-export-section h3 {
        margin: 0 0 10px 0;
        color: #8b7355;
        font-size: 16px;
      }
      .import-export-section p {
        margin: 0 0 15px 0;
        color: #666;
        font-size: 14px;
      }
      .divider {
        height: 1px;
        background: linear-gradient(to right, transparent, #d4c294, transparent);
        margin: 20px 0;
      }

      /* 按钮样式 */
      .submit-btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        background: #667eea;
        color: white;
      }
      .submit-btn:hover {
        background: #5a6fd8;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
      }
      .submit-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .submit-btn:disabled:hover {
        background: #ccc;
        transform: none;
        box-shadow: none;
      }

      /* 文件选择 */
      #selectedFileName {
        min-height: 16px;
        font-style: italic;
      }
      #selectedFileName:empty::before {
        content: '未选择文件';
        color: #999;
      }

      /* JSON预览 */
      #jsonPreview {
        resize: vertical;
        min-height: 100px;
        max-height: 300px;
      }

      input[type='radio'] {
        accent-color: #d4c294;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }
      .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="phone-shell">
      <div class="container">
        <div class="status-bar">
          <div>9:41</div>
          <div>📶 🔋</div>
        </div>
        <div class="header">
          <h1>好友列表</h1>
          <button class="add-btn" onclick="openAddModal()">+</button>
          <button class="add-btn" onclick="showDebugInfo()" style="right: 65px; font-size: 14px" title="调试信息">
            ℹ️
          </button>
          <button
            class="add-btn"
            onclick="showImportExportModal()"
            style="right: 105px; font-size: 12px"
            title="导入/导出好友"
          >
            📁
          </button>
        </div>

        <div class="friends-list" id="friendsList">
          <div class="empty-state">
            <i>👥</i>
            <p>暂无好友，点击右上角添加好友或群聊</p>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="addModal">
      <div class="modal-content">
        <div id="typeSelection">
          <div class="modal-header">
            <h2>添加好友/群聊</h2>
            <button class="close-btn" onclick="closeAddModal()">×</button>
          </div>
          <p style="text-align: center; color: #666; margin-bottom: 20px">请选择要添加的类型</p>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="selectType('friend')">👤 添加好友</button>
            <button class="btn btn-primary" onclick="selectType('group')">👥 添加群聊</button>
          </div>
        </div>

        <div id="friendForm" style="display: none">
          <div class="modal-header">
            <h2>添加好友</h2>
            <button class="close-btn" onclick="closeAddModal()">×</button>
          </div>
          <div class="form-group">
            <label for="friendName">好友姓名</label>
            <input type="text" id="friendName" placeholder="请输入好友姓名" />
          </div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="backToTypeSelection()">返回</button>
            <button class="btn btn-primary" onclick="addFriend()">添加好友</button>
          </div>
        </div>

        <div id="groupForm" style="display: none">
          <div class="modal-header">
            <h2>添加群聊</h2>
            <button class="close-btn" onclick="closeAddModal()">×</button>
          </div>
          <div class="form-group">
            <label for="groupName">群聊名称</label>
            <input type="text" id="groupName" placeholder="请输入群聊名称" />
          </div>
          <div class="form-group">
            <label for="groupMembers">群成员</label>
            <textarea id="groupMembers" placeholder="请输入群成员，用逗号隔开&#10;例如：张三,李四,王五"></textarea>
          </div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="backToTypeSelection()">返回</button>
            <button class="btn btn-primary" onclick="addGroup()">添加群聊</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="importExportModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>📁 导入/导出好友列表</h2>
          <button class="close-btn" onclick="closeImportExportModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="import-export-section">
            <h3>📤 导出好友列表</h3>
            <p>将当前角色的好友列表导出为JSON文件</p>
            <button class="submit-btn" onclick="exportFriends()">📥 导出为JSON文件</button>
          </div>

          <div class="divider"></div>

          <div class="import-export-section">
            <h3>📥 导入好友列表</h3>
            <p>从JSON文件导入好友列表到当前角色</p>

            <div>
              <input
                type="file"
                id="importFileInput"
                accept=".json"
                style="display: none"
                onchange="handleFileSelect(event)"
              />
              <button
                class="submit-btn"
                onclick="document.getElementById('importFileInput').click()"
                style="margin-bottom: 10px"
              >
                📁 选择JSON文件
              </button>
              <div id="selectedFileName" style="font-size: 12px; color: #666; text-align: center"></div>
            </div>

            <div style="margin-top: 15px">
              <label style="display: flex; align-items: center; margin-bottom: 10px; font-size: 14px">
                <input type="radio" name="importMode" value="replace" checked style="margin-right: 8px" />
                <span>替换现有好友列表</span>
              </label>
              <label style="display: flex; align-items: center; font-size: 14px">
                <input type="radio" name="importMode" value="merge" style="margin-right: 8px" />
                <span>合并到现有好友列表 (跳过重复)</span>
              </label>
            </div>

            <div style="margin-top: 15px">
              <button class="submit-btn" onclick="importFriends()" id="importBtn" disabled>
                🚀 导入好友列表
              </button>
            </div>
          </div>

          <div class="import-export-section" id="jsonPreviewSection" style="display: none">
            <h3>📋 JSON预览</h3>
            <textarea
              id="jsonPreview"
              readonly
              style="
                width: 100%;
                font-family: monospace;
                font-size: 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 8px;
                background: #f9f9f9;
              "
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==================== 角色卡独立存储系统 ====================
      // 替换这个函数 -> 获取当前角色信息（修正版）
      function getCurrentCharacterInfo() {
        try {
          // 检查是否能连接到SillyTavern的主程序环境，以及角色是否已加载
          if (typeof parent === 'undefined' || parent.this_chid === undefined) {
            console.warn('无法连接到SillyTavern主程序或角色未加载，将使用默认角色。');
            
            // 如果连接失败，尝试从URL参数等其他地方获取信息作为备用方案
            const urlParams = new URLSearchParams(window.location.search);
            const charIdFromUrl = urlParams.get('character') || urlParams.get('char');
            if (charIdFromUrl) {
              return { id: charIdFromUrl, name: `角色 ${charIdFromUrl}`, source: 'url' };
            }
            // 如果都失败，才使用默认角色
            return { id: 'default', name: '默认角色', source: 'default' };
          }

          // --- 主要获取逻辑 ---
          // 直接从SillyTavern的全局变量获取数据
          const charId = parent.this_chid;
          let charName = '未知角色';

          // 最佳方式: 通过角色ID从角色列表中获取名字
          if (parent.characters && parent.characters[charId]) {
            // .name 适用于角色书条目, .data.name 适用于角色卡
            charName = parent.characters[charId].name || parent.characters[charId].data?.name || `角色 ${charId}`;
          }
          // 后备方式: 从当前聊天上下文获取名字 (name2 是角色的名字)
          else if (parent.name2) {
            charName = parent.name2;
          }

          console.log('成功从SillyTavern获取角色信息:', { id: charId, name: charName });
          return {
            id: charId.toString(),
            name: charName,
            source: 'sillytavern_globals', // 来源标记为ST全局变量
          };

        } catch (error) {
          console.error('获取角色信息时发生错误，将使用默认角色:', error);
          return { id: 'default', name: '默认角色', source: 'default' };
        }
      }
      
      // 生成角色专用的存储键名
      function getFriendsStorageKey() {
        const charInfo = getCurrentCharacterInfo();
        // 使用更具体的键名格式，确保不同角色完全隔离
        return `tavern_friends_${charInfo.source}_${charInfo.id}`;
      }

      // 保存当前角色ID到localStorage，用于角色切换检测
      function saveCurrentCharacterId() {
        const charInfo = getCurrentCharacterInfo();
        localStorage.setItem('lastUsedCharacter', charInfo.id);
        console.log('保存当前角色ID:', charInfo.id);
      }

      // 从角色专用存储加载好友列表
      function loadFriends() {
        try {
          const storageKey = getFriendsStorageKey();
          const charInfo = getCurrentCharacterInfo();

          console.log(`为角色 "${charInfo.name}" 加载好友列表，存储键: ${storageKey}`);

          // 优先从SillyTavern extension_settings读取
          let friends = [];
          if (typeof parent !== 'undefined' && parent.extension_settings) {
            friends = parent.extension_settings[storageKey] || [];
          } else {
            // 回退到localStorage
            friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
          }

          // 如果当前角色没有好友数据，检查是否需要迁移旧数据
          if (friends.length === 0) {
            const migrated = migrateOldFriendsData();
            if (migrated) {
              // 重新加载迁移后的数据
              if (typeof parent !== 'undefined' && parent.extension_settings) {
                friends = parent.extension_settings[storageKey] || [];
              } else {
                friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
              }
            }
          }

          displayFriends(friends);

          // 在标题中显示当前角色
          updateHeaderWithCharacter(charInfo);
        } catch (error) {
          console.error('加载好友列表失败:', error);
          displayFriends([]);
        }
      }

      // 保存好友列表到角色专用存储
      function saveFriends(friends) {
        try {
          const storageKey = getFriendsStorageKey();
          const charInfo = getCurrentCharacterInfo();

          console.log(`为角色 "${charInfo.name}" 保存好友列表，存储键: ${storageKey}，好友数量: ${friends.length}`);

          // 优先保存到SillyTavern extension_settings
          if (typeof parent !== 'undefined' && parent.extension_settings) {
            parent.extension_settings[storageKey] = JSON.parse(JSON.stringify(friends));
            // 触发SillyTavern的设置保存
            if (typeof parent.saveSettingsDebounced === 'function') {
              parent.saveSettingsDebounced();
            }
          }

          // 同时保存到localStorage作为备份
          localStorage.setItem(storageKey, JSON.stringify(friends));
        } catch (error) {
          console.error('保存好友列表失败:', error);
        }
      }

      // 更新标题显示当前角色
      function updateHeaderWithCharacter(charInfo) {
        const header = document.querySelector('.header h1');
        if (header) {
          header.innerHTML = `
                  <div style="display: flex; flex-direction: column; align-items: center;">
                    <div style="font-size: 18px;">好友列表</div>
                    <div style="font-size: 12px; color: #8b7355; margin-top: 2px;">
                      ${charInfo.name}
                    </div>
                  </div>
                `;
        }
      }

      // 数据迁移：将旧的全局好友列表迁移到当前角色
      function migrateOldFriendsData() {
        try {
          const oldFriends = JSON.parse(localStorage.getItem('friendsList') || '[]');
          if (oldFriends.length > 0) {
            const charInfo = getCurrentCharacterInfo();
            const storageKey = getFriendsStorageKey();

            // 检查当前角色是否已有好友数据
            let currentFriends = [];
            if (typeof parent !== 'undefined' && parent.extension_settings) {
              currentFriends = parent.extension_settings[storageKey] || [];
            } else {
              currentFriends = JSON.parse(localStorage.getItem(storageKey) || '[]');
            }

            // 如果当前角色没有好友数据，询问是否迁移
            if (currentFriends.length === 0) {
              const shouldMigrate = confirm(
                `检测到旧版本的好友列表数据（${oldFriends.length}个好友）。\n` +
                  `是否要将这些好友迁移到当前角色 "${charInfo.name}" 的好友列表中？\n\n` +
                  `点击"确定"迁移，点击"取消"保持当前状态。`,
              );

              if (shouldMigrate) {
                saveFriends(oldFriends);
                console.log(`已将 ${oldFriends.length} 个好友迁移到角色 "${charInfo.name}"`);

                // 询问是否清除旧数据
                const shouldClearOld = confirm(
                  `好友数据迁移完成！\n\n` + `是否要清除旧版本的全局好友列表数据？\n` + `（建议清除，避免数据混乱）`,
                );

                if (shouldClearOld) {
                  localStorage.removeItem('friendsList');
                  console.log('已清除旧版本的全局好友列表数据');
                }

                return true; // 表示进行了迁移
              }
            }
          }
        } catch (error) {
          console.error('数据迁移失败:', error);
        }
        return false; // 表示没有进行迁移
      }

      // 显示好友列表
      function displayFriends(friends) {
        const friendsList = document.getElementById('friendsList');

        if (friends.length === 0) {
          friendsList.innerHTML = `
                        <div class="empty-state">
                            <i>👥</i>
                            <p>暂无好友，点击右上角添加好友或群聊</p>
                        </div>
                    `;
          return;
        }

        // 按置顶状态排序，置顶的在前面
        const sortedFriends = friends.sort((a, b) => {
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          return 0;
        });

        friendsList.innerHTML = sortedFriends
          .map(
            (friend, index) => `
                <div class="friend-item ${friend.pinned ? 'pinned' : ''}" onclick="startChat('${friend.name}', '${
              friend.type
            }', '${friend.members || ''}')">
                    <div class="friend-avatar">
                        ${friend.type === 'group' ? '👥' : friend.name.charAt(0)}
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">
                            ${friend.name}
                            ${friend.type === 'group' ? '<span class="group-badge">群聊</span>' : ''}
                            ${friend.pinned ? '<span class="pinned-badge">📌</span>' : ''}
                        </div>
                        <div class="friend-type">
                            ${friend.type === 'group' ? `成员: ${friend.members}` : '好友'}
                        </div>
                    </div>
                    <div class="friend-actions">
                        <button class="action-btn pin-btn ${friend.pinned ? 'pinned' : ''}"
                                onclick="handlePinClick(event, ${index})"
                                title="${friend.pinned ? '取消置顶' : '置顶'}">
                            ${friend.pinned ? '📌' : '📍'}
                        </button>
                        <button class="action-btn delete-btn"
                                onclick="handleDeleteClick(event, ${index})"
                                title="删除好友">
                            🗑️
                        </button>
                    </div>
                </div>
              `,
          )
          .join('');
      }

      // 打开添加模态框
      function openAddModal() {
        document.getElementById('addModal').style.display = 'flex';
        showTypeSelection();
      }

      // 关闭添加模态框
      function closeAddModal() {
        document.getElementById('addModal').style.display = 'none';
        resetForms();
      }

      // 显示类型选择界面
      function showTypeSelection() {
        document.getElementById('typeSelection').style.display = 'block';
        document.getElementById('friendForm').style.display = 'none';
        document.getElementById('groupForm').style.display = 'none';
      }

      // 选择类型（好友或群聊）
      function selectType(type) {
        document.getElementById('typeSelection').style.display = 'none';

        if (type === 'friend') {
          document.getElementById('friendForm').style.display = 'block';
          document.getElementById('friendName').focus();
        } else if (type === 'group') {
          document.getElementById('groupForm').style.display = 'block';
          document.getElementById('groupName').focus();
        }
      }

      // 返回类型选择
      function backToTypeSelection() {
        resetForms();
        showTypeSelection();
      }

      // 重置表单
      function resetForms() {
        document.getElementById('friendName').value = '';
        document.getElementById('groupName').value = '';
        document.getElementById('groupMembers').value = '';
      }

      // 添加好友
      function addFriend() {
        const name = document.getElementById('friendName').value.trim();

        if (!name) {
          alert('请输入好友姓名');
          return;
        }

        // 使用角色专用存储加载好友列表
        const storageKey = getFriendsStorageKey();
        let friends = [];
        if (typeof parent !== 'undefined' && parent.extension_settings) {
          friends = parent.extension_settings[storageKey] || [];
        } else {
          friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
        }

        // 检查是否已存在
        if (friends.some(friend => friend.name === name)) {
          alert('该好友已存在');
          return;
        }

        const newFriend = {
          name: name,
          type: 'friend',
          members: null,
          addTime: new Date().toISOString(),
        };

        friends.push(newFriend);
        saveFriends(friends); // 使用新的保存函数

        displayFriends(friends);
        closeAddModal();

        const charInfo = getCurrentCharacterInfo();
        // alert(`好友 "${name}" 已添加到 "${charInfo.name}" 的好友列表！`);
      }

      // 添加群聊
      function addGroup() {
        const name = document.getElementById('groupName').value.trim();
        const members = document.getElementById('groupMembers').value.trim();

        if (!name) {
          alert('请输入群聊名称');
          return;
        }

        if (!members) {
          alert('请输入群成员');
          return;
        }

        // 使用角色专用存储加载好友列表
        const storageKey = getFriendsStorageKey();
        let friends = [];
        if (typeof parent !== 'undefined' && parent.extension_settings) {
          friends = parent.extension_settings[storageKey] || [];
        } else {
          friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
        }

        // 检查是否已存在
        if (friends.some(friend => friend.name === name)) {
          alert('该群聊已存在');
          return;
        }

        const newGroup = {
          name: name,
          type: 'group',
          members: members,
          addTime: new Date().toISOString(),
        };

        friends.push(newGroup);
        saveFriends(friends); // 使用新的保存函数

        displayFriends(friends);
        closeAddModal();

        const charInfo = getCurrentCharacterInfo();
        // alert(`群聊 "${name}" 已添加到 "${charInfo.name}" 的好友列表！`);
      }

      // 开始聊天
      function startChat(name, type, members) {
        if (typeof parent.triggerSlash === 'function') {
          if (type === 'group') {
            const message = `/send <群成员：${members}>\n【和${name}的聊天】\n<qunliao>\n</qunliao>`;
            parent.triggerSlash(message);
          } else {
            const message = `/send 【和${name}的聊天】\n<shouji>\n</shouji>`;
            parent.triggerSlash(message);
          }
        } else {
          // 如果triggerSlash不可用，显示消息内容
          if (type === 'group') {
            console.log(`<群成员：${members}>\n【和${name}的聊天】\n<qunliao>\n</qunliao>`);
            alert(`群聊消息：<群成员：${members}>\n【和${name}的聊天】\n<qunliao>\n</qunliao>`);
          } else {
            console.log(`【和${name}的聊天】\n<shouji>\n</shouji>`);
            alert(`好友消息：【和${name}的聊天】\n<shouji>\n</shouji>`);
          }
        }
      }

      // 点击模态框外部关闭
      document.getElementById('addModal').addEventListener('click', function (e) {
        if (e.target === this) {
          closeAddModal();
        }
      });
      document.getElementById('importExportModal').addEventListener('click', function (e) {
        if (e.target === this) {
          closeImportExportModal();
        }
      });

      // 回车键添加好友
      document.getElementById('friendName').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          addFriend();
        }
      });

      // 回车键添加群聊（群聊名称输入框）
      document.getElementById('groupName').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          document.getElementById('groupMembers').focus();
        }
      });

      // 切换置顶状态
      function togglePin(index) {
        // 使用角色专用存储加载好友列表
        const storageKey = getFriendsStorageKey();
        let friends = [];
        if (typeof parent !== 'undefined' && parent.extension_settings) {
          friends = parent.extension_settings[storageKey] || [];
        } else {
          friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
        }

        friends[index].pinned = !friends[index].pinned;
        saveFriends(friends); // 使用新的保存函数
        displayFriends(friends);
      }

      // 处理置顶按钮点击
      function handlePinClick(event, index) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();

        console.log('置顶按钮被点击，索引:', index);
        togglePin(index);
      }

      // 处理删除按钮点击
      function handleDeleteClick(event, index) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();

        console.log('删除按钮被点击，索引:', index);
        deleteFriend(index);
      }

      // 删除好友（改进版本）
      function deleteFriend(index) {
        try {
          // 获取当前好友列表
          const storageKey = getFriendsStorageKey();
          let friends = [];
          if (typeof parent !== 'undefined' && parent.extension_settings) {
            friends = parent.extension_settings[storageKey] || [];
          } else {
            friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
          }

          // 检查索引是否有效
          if (index < 0 || index >= friends.length) {
            console.error('删除失败：无效的索引', index);
            alert('删除失败：好友不存在');
            return;
          }

          const friendToDelete = friends[index];
          const charInfo = getCurrentCharacterInfo();

          // 确认删除
          const confirmMessage = `确定要删除${friendToDelete.type === 'group' ? '群聊' : '好友'} "${
            friendToDelete.name
          }" 吗？\n\n这将从 "${charInfo.name}" 的好友列表中永久移除。`;

          if (confirm(confirmMessage)) {
            console.log(`删除${friendToDelete.type === 'group' ? '群聊' : '好友'}:`, friendToDelete.name);

            // 从数组中删除
            friends.splice(index, 1);

            // 保存更新后的列表
            saveFriends(friends);

            // 重新显示列表
            displayFriends(friends);

            console.log('删除成功，剩余好友数量:', friends.length);
          }
        } catch (error) {
          console.error('删除好友时发生错误:', error);
          alert('删除失败，请重试');
        }
      }

      // 角色切换检测（改进版本）
      let currentCharacterId = null;
      let lastCheckTime = 0;

      function checkCharacterChange() {
        try {
          const now = Date.now();
          // 避免过于频繁的检查
          if (now - lastCheckTime < 1000) return;
          lastCheckTime = now;

          const charInfo = getCurrentCharacterInfo();
          const newCharId = charInfo.id;

          if (currentCharacterId !== newCharId) {
            console.log(`🔄 角色切换检测: "${currentCharacterId}" -> "${newCharId}"`);
            console.log('新角色信息:', charInfo);

            currentCharacterId = newCharId;
            saveCurrentCharacterId(); // 保存新的角色ID

            // 重新加载好友列表
            setTimeout(() => {
              loadFriends();
            }, 100);
          }
        } catch (error) {
          console.error('角色切换检测失败:', error);
        }
      }

      // 定期检查角色是否切换（每1.5秒检查一次）
      setInterval(checkCharacterChange, 1500);

      // 监听SillyTavern的各种角色切换事件
      if (typeof parent !== 'undefined') {
        // 方法1: 监听eventSource事件
        if (parent.eventSource && typeof parent.eventSource.on === 'function') {
          parent.eventSource.on('character_selected', () => {
            console.log('📡 收到character_selected事件');
            setTimeout(() => {
              checkCharacterChange();
              loadFriends();
            }, 200);
          });
        }

        // 方法2: 监听DOM变化（角色名称变化）
        if (parent.document) {
          const observer = new MutationObserver(() => {
            checkCharacterChange();
          });

          // 观察可能包含角色信息的元素
          const targetSelectors = ['#character_name', '.character-name', '#name1'];
          targetSelectors.forEach(selector => {
            const element = parent.document.querySelector(selector);
            if (element) {
              observer.observe(element, { childList: true, subtree: true, characterData: true });
            }
          });
        }

        // 方法3: 监听this_chid变化
        let lastThisChid = parent.this_chid;
        setInterval(() => {
          if (parent.this_chid !== lastThisChid) {
            console.log('📡 检测到this_chid变化:', lastThisChid, '->', parent.this_chid);
            lastThisChid = parent.this_chid;
            checkCharacterChange();
          }
        }, 500);
      }

      // 显示调试信息
      function showDebugInfo() {
        const charInfo = getCurrentCharacterInfo();
        const storageKey = getFriendsStorageKey();

        let friends = [];
        let storageSource = '';

        if (typeof parent !== 'undefined' && parent.extension_settings) {
          friends = parent.extension_settings[storageKey] || [];
          storageSource = 'SillyTavern extension_settings';
        } else {
          friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
          storageSource = 'localStorage';
        }

        const oldFriends = JSON.parse(localStorage.getItem('friendsList') || '[]');

        // 获取SillyTavern的详细信息
        let sillyTavernInfo = '未连接到SillyTavern';
        if (typeof parent !== 'undefined') {
          sillyTavernInfo = `
• this_chid: ${parent.this_chid}
• name1: ${parent.name1 || '未设置'}
• characters数量: ${parent.characters ? Object.keys(parent.characters).length : 0}
• extension_settings可用: ${parent.extension_settings ? '是' : '否'}`;
        }

        const debugInfo = `
=== 好友列表调试信息 ===

当前角色信息:
• ID: ${charInfo.id}
• 名称: ${charInfo.name}
• 来源: ${charInfo.source}

SillyTavern连接状态:
${sillyTavernInfo}

存储信息:
• 存储键: ${storageKey}
• 存储位置: ${storageSource}
• 当前好友数量: ${friends.length}

角色切换监控:
• 当前监控的角色ID: ${currentCharacterId}
• 最后检查时间: ${new Date(lastCheckTime).toLocaleTimeString()}

旧版本数据:
• 全局好友列表: ${oldFriends.length} 个好友

当前角色好友列表:
${
  friends.length > 0
    ? friends.map((f, i) => `${i + 1}. ${f.name} (${f.type === 'group' ? '群聊' : '好友'})`).join('\n')
    : '(无好友)'
}

${
  oldFriends.length > 0
    ? `\n旧版本好友列表:\n${oldFriends
        .map((f, i) => `${i + 1}. ${f.name} (${f.type === 'group' ? '群聊' : '好友'})`)
        .join('\n')}`
    : ''
}

存储键名示例:
• 当前角色: ${storageKey}
• 其他角色: tavern_friends_sillytavern_chid_123
• 默认角色: tavern_friends_default_default
            `.trim();

        alert(debugInfo);
      }

      // ==================== 导入/导出功能 ====================

      let selectedImportFile = null;

      // 显示导入/导出模态框
      function showImportExportModal() {
        document.getElementById('importExportModal').style.display = 'flex';

        // 重置状态
        selectedImportFile = null;
        document.getElementById('selectedFileName').textContent = '';
        document.getElementById('importBtn').disabled = true;
        document.getElementById('jsonPreviewSection').style.display = 'none';

        // 重置单选按钮
        document.querySelector('input[name="importMode"][value="replace"]').checked = true;
      }

      // 关闭导入/导出模态框
      function closeImportExportModal() {
        document.getElementById('importExportModal').style.display = 'none';
      }

      // 导出好友列表
      function exportFriends() {
        try {
          const charInfo = getCurrentCharacterInfo();
          const storageKey = getFriendsStorageKey();

          // 获取当前好友列表
          let friends = [];
          if (typeof parent !== 'undefined' && parent.extension_settings) {
            friends = parent.extension_settings[storageKey] || [];
          } else {
            friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
          }

          // 创建导出数据
          const exportData = {
            version: '1.0',
            exportTime: new Date().toISOString(),
            character: {
              id: charInfo.id,
              name: charInfo.name,
              source: charInfo.source,
            },
            friendsCount: friends.length,
            friends: friends,
          };

          // 创建JSON字符串
          const jsonString = JSON.stringify(exportData, null, 2);

          // 创建下载链接
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);

          // 生成文件名
          const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
          const fileName = `好友列表_${charInfo.name}_${timestamp}.json`;

          // 下载文件
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          alert(`✅ 导出成功！\n\n文件名: ${fileName}\n好友数量: ${friends.length}\n角色: ${charInfo.name}`);

          console.log('导出好友列表成功:', {
            fileName,
            friendsCount: friends.length,
            character: charInfo.name,
          });
        } catch (error) {
          console.error('导出好友列表失败:', error);
          alert('❌ 导出失败: ' + error.message);
        }
      }

      // 处理文件选择
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) {
          selectedImportFile = null;
          document.getElementById('selectedFileName').textContent = '';
          document.getElementById('importBtn').disabled = true;
          document.getElementById('jsonPreviewSection').style.display = 'none';
          return;
        }

        if (!file.name.toLowerCase().endsWith('.json')) {
          alert('请选择JSON格式的文件');
          event.target.value = '';
          return;
        }

        selectedImportFile = file;
        document.getElementById('selectedFileName').textContent = file.name;
        document.getElementById('importBtn').disabled = false;

        // 读取并预览文件内容
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const jsonData = JSON.parse(e.target.result);
            document.getElementById('jsonPreview').value = JSON.stringify(jsonData, null, 2);
            document.getElementById('jsonPreviewSection').style.display = 'block';
          } catch (error) {
            console.error('JSON解析失败:', error);
            document.getElementById('jsonPreview').value = '文件格式错误，无法预览';
            document.getElementById('jsonPreviewSection').style.display = 'block';
          }
        };
        reader.readAsText(file);
      }

      // 导入好友列表
      function importFriends() {
        if (!selectedImportFile) {
          alert('请先选择要导入的JSON文件');
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            // 解析JSON数据
            const importData = JSON.parse(e.target.result);

            // 验证数据格式
            if (!validateImportData(importData)) {
              return;
            }

            const importFriends = importData.friends || [];
            if (importFriends.length === 0) {
              alert('❌ 导入失败: 文件中没有好友数据');
              return;
            }

            // 获取导入模式
            const importMode = document.querySelector('input[name="importMode"]:checked').value;
            const charInfo = getCurrentCharacterInfo();

            // 获取当前好友列表
            const storageKey = getFriendsStorageKey();
            let currentFriends = [];
            if (typeof parent !== 'undefined' && parent.extension_settings) {
              currentFriends = parent.extension_settings[storageKey] || [];
            } else {
              currentFriends = JSON.parse(localStorage.getItem(storageKey) || '[]');
            }

            let finalFriends = [];
            let importedCount = 0;
            let skippedCount = 0;

            if (importMode === 'replace') {
              // 替换模式：直接使用导入的好友列表
              finalFriends = importFriends.map(friend => ({
                ...friend,
                addTime: friend.addTime || new Date().toISOString(),
              }));
              importedCount = finalFriends.length;
            } else if (importMode === 'merge') {
              // 合并模式：合并到现有列表，跳过重复
              finalFriends = [...currentFriends];

              for (const importFriend of importFriends) {
                // 检查是否已存在（按名称和类型）
                const exists = finalFriends.some(
                  existing => existing.name === importFriend.name && existing.type === importFriend.type,
                );

                if (!exists) {
                  finalFriends.push({
                    ...importFriend,
                    addTime: importFriend.addTime || new Date().toISOString(),
                  });
                  importedCount++;
                } else {
                  skippedCount++;
                }
              }
            }

            // 保存更新后的好友列表
            saveFriends(finalFriends);

            // 刷新显示
            displayFriends(finalFriends);

            // 关闭模态框
            closeImportExportModal();

            // 显示导入结果
            let resultMessage = `✅ 导入完成！\n\n`;
            resultMessage += `角色: ${charInfo.name}\n`;
            resultMessage += `导入模式: ${importMode === 'replace' ? '替换' : '合并'}\n`;
            resultMessage += `成功导入: ${importedCount} 个条目\n`;
            if (skippedCount > 0) {
              resultMessage += `跳过重复: ${skippedCount} 个条目\n`;
            }
            resultMessage += `当前总数: ${finalFriends.length} 个条目`;

            alert(resultMessage);

            console.log('导入好友列表成功:', {
              importMode,
              importedCount,
              skippedCount,
              totalCount: finalFriends.length,
              character: charInfo.name,
            });
          } catch (error) {
            console.error('导入好友列表失败:', error);
            alert('❌ 导入失败: ' + error.message);
          }
        };

        reader.readAsText(selectedImportFile);
      }

      // 验证导入数据格式
      function validateImportData(data) {
        try {
          // 检查基本结构
          if (!data || typeof data !== 'object') {
            alert('❌ 导入失败: 文件格式不正确');
            return false;
          }

          // 检查是否有friends数组
          if (!Array.isArray(data.friends)) {
            alert('❌ 导入失败: 文件中缺少好友数据');
            return false;
          }

          // 验证每个好友的数据格式
          for (let i = 0; i < data.friends.length; i++) {
            const friend = data.friends[i];

            if (!friend.name || typeof friend.name !== 'string') {
              alert(`❌ 导入失败: 第${i + 1}个好友缺少有效的名称`);
              return false;
            }

            if (!friend.type || !['friend', 'group'].includes(friend.type)) {
              alert(`❌ 导入失败: 第${i + 1}个好友的类型无效`);
              return false;
            }
          }

          // 显示导入预览信息
          const friendCount = data.friends.filter(f => f.type === 'friend').length;
          const groupCount = data.friends.filter(f => f.type === 'group').length;

          const previewMessage =
            `📋 导入预览\n\n` +
            `文件版本: ${data.version || '未知'}\n` +
            `导出时间: ${data.exportTime ? new Date(data.exportTime).toLocaleString('zh-CN') : '未知'}\n` +
            `原角色: ${data.character?.name || '未知'}\n` +
            `好友数量: ${friendCount} 个\n` +
            `群聊数量: ${groupCount} 个\n` +
            `总计: ${data.friends.length} 个\n\n` +
            `确定要导入这些数据吗？`;

          return confirm(previewMessage);
        } catch (error) {
          console.error('验证导入数据失败:', error);
          alert('❌ 导入失败: 数据验证出错');
          return false;
        }
      }

      // 页面加载时初始化
      window.addEventListener('load', () => {
        console.log('🚀 好友列表页面加载完成，开始初始化...');

        // 等待一小段时间确保SillyTavern完全加载
        setTimeout(() => {
          const charInfo = getCurrentCharacterInfo();
          console.log('📋 初始化角色信息:', charInfo);

          currentCharacterId = charInfo.id;
          saveCurrentCharacterId();

          // 加载好友列表
          loadFriends();

          // 开始角色切换监控
          console.log('🔍 开始角色切换监控...');
        }, 500);
      });

      // 页面可见性变化时重新检查角色
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          console.log('📱 页面重新可见，检查角色是否切换...');
          setTimeout(checkCharacterChange, 100);
        }
      });
    </script>
  </body>
</html>
