<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¥½å‹åˆ—è¡¨</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Ma+Shan+Zheng&display=swap');

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #f0f2f5; /* æ•´ä½“èƒŒæ™¯æ”¹ä¸ºæµ…ç°è‰² */
        min-height: 100vh;
        font-family: 'Noto Sans JP', 'Microsoft YaHei', sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      /* å¤–æ¡†åŒ…è£¹å±‚ */
      .phone-shell {
        padding: 12px; /* å¤–å£³åšåº¦å˜è–„ */
        background: #cccccc; /* å¤–å£³é¢œè‰²æ”¹ä¸ºç°è‰² */
        border-radius: 40px; /* åœ†è§’å¾®è°ƒ */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: inline-block;
      }

      .container {
        width: 260px; /* å®½åº¦å†æ¬¡å˜å° */
        height: 750px; /* å¢åŠ æ‰‹æœºé«˜åº¦ */
        background: #ffffff;
        border-radius: 30px; /* åœ†è§’å¾®è°ƒ */
        box-shadow: inset 0 0 0 1px #cccccc; /* å†…æè¾¹å˜ç»†ï¼Œé¢œè‰²æ”¹å˜ */
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: fadeInUp 0.8s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .status-bar {
        height: 20px;
        background: #f7f7f7; /* çŠ¶æ€æ é¢œè‰²è°ƒæ•´ */
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 10px;
        font-size: 8px;
        color: #555555; /* æ–‡æœ¬é¢œè‰²è°ƒæ•´ */
        box-shadow: 0 1px 0 #e9e9e9; /* é˜´å½±é¢œè‰²è°ƒæ•´ */
      }

      .header {
        background: linear-gradient(135deg, #e9e9e9 0%, #d9d9d9 100%); /* å¤´éƒ¨èƒŒæ™¯æ”¹ä¸ºç°è‰²æ¸å˜ */
        color: #555555; /* æ–‡æœ¬é¢œè‰²è°ƒæ•´ */
        padding: 15px;
        position: relative;
        text-align: center;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08); /* è¾¹æ¡†é¢œè‰²è°ƒæ•´ */
      }

      .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.2) 50%, transparent 70%);
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .header h1 {
        font-family: 'Ma Shan Zheng', cursive;
        font-size: clamp(24px, 4vw, 28px);
        font-weight: 700;
        letter-spacing: 2px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); /* é˜´å½±è°ƒæ•´ */
        animation: glow 2s ease-in-out infinite alternate;
        position: relative;
        z-index: 1;
      }

      @keyframes glow {
        from {
          text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        to {
          text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.15);
        }
      }

      .add-btn {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(200, 200, 200, 0.3); /* æŒ‰é’®é¢œè‰²è°ƒæ•´ */
        border: 1px solid rgba(200, 200, 200, 0.5); /* æŒ‰é’®è¾¹æ¡†é¢œè‰²è°ƒæ•´ */
        color: #555555;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        z-index: 2;
      }

      .add-btn:hover {
        background: rgba(200, 200, 200, 0.5);
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .friends-list {
        padding: 8px; /* å†…è¾¹è·å‡å° */
        background: #f7f7f7; /* èƒŒæ™¯è‰²è°ƒæ•´ */
        flex: 1;
        overflow-y: auto;
        max-height: calc(750px - 36px - 95px); /* å‡å»çŠ¶æ€æ å’Œheaderé«˜åº¦ */
      }

      /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
      .friends-list::-webkit-scrollbar {
        width: 6px;
      }

      .friends-list::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 3px;
      }

      .friends-list::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
      }

      .friends-list::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
      }

      .friend-item {
        display: flex;
        align-items: center;
        padding: 6px; /* å†…è¾¹è·å‡å° */
        margin-bottom: 6px; /* å¤–è¾¹è·å‡å° */
        border-radius: 6px; /* åœ†è§’å¾®è°ƒ */
        cursor: pointer;
        transition: all 0.3s ease;
        background: #ffffff;
        border: 1px solid #e0e0e0; /* è¾¹æ¡†å˜ç»†å˜ç° */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* é˜´å½±è°ƒæ•´ */
        position: relative;
        overflow: hidden;
      }

      .friend-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.03), transparent);
        transition: left 0.5s;
      }

      .friend-item:hover::before {
        left: 100%;
      }

      .friend-item:hover {
        background: #f0f0f0; /* æ‚¬æµ®èƒŒæ™¯è‰²è°ƒæ•´ */
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); /* æ‚¬æµ®é˜´å½±è°ƒæ•´ */
        border-color: #d0d0d0; /* æ‚¬æµ®è¾¹æ¡†é¢œè‰²è°ƒæ•´ */
      }

      .friend-avatar {
        width: 30px; /* å¤´åƒå˜å° */
        height: 30px; /* å¤´åƒå˜å° */
        border-radius: 50%;
        background: linear-gradient(135deg, #e0e0e0 0%, #cccccc 100%); /* å¤´åƒèƒŒæ™¯è‰²è°ƒæ•´ */
        display: flex;
        align-items: center;
        justify-content: center;
        color: #555555; /* å¤´åƒæ–‡å­—é¢œè‰²è°ƒæ•´ */
        font-weight: bold;
        margin-right: 9px; /* å³è¾¹è·å‡å° */
        font-size: 14px; /* å­—ä½“å¤§å°è°ƒæ•´ */
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
      }

      .friend-item:hover .friend-avatar {
        transform: scale(1.1) rotate(5deg);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .friend-info {
        flex: 1;
        position: relative;
        z-index: 1;
        min-width: 0; /* é˜²æ­¢æ–‡å­—è¿‡é•¿æ—¶æ’‘å¼€å®¹å™¨ */
      }

      .friend-name {
        font-size: 13px; /* å­—ä½“å¤§å°è°ƒæ•´ */
        font-weight: 500;
        color: #333333; /* é¢œè‰²è°ƒæ•´ */
        margin-bottom: 4px; /* è¾¹è·è°ƒæ•´ */
        text-shadow: none;
        letter-spacing: 0.5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .friend-type {
        font-size: 13px; /* å­—ä½“å¤§å°è°ƒæ•´ */
        color: #777777; /* é¢œè‰²è°ƒæ•´ */
        font-weight: 300;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .group-badge {
        background: rgba(200, 200, 200, 0.8); /* é¢œè‰²è°ƒæ•´ */
        color: #555555; /* é¢œè‰²è°ƒæ•´ */
        padding: 3px 7px;
        border-radius: 12px;
        font-size: 10px;
        margin-left: 8px;
        border: 1px solid rgba(200, 200, 200, 0.5); /* é¢œè‰²è°ƒæ•´ */
        font-weight: 400;
        text-shadow: none;
      }

      .pinned-badge {
        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        color: white;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 10px;
        margin-left: 8px;
        font-weight: 500;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
      }

      .friend-item.pinned {
        background: #f7f8fa;
        border-color: #a7c5eb;
        box-shadow: 0 2px 8px rgba(167, 197, 235, 0.3);
      }

      .friend-item.pinned:hover {
        background: #f0f4f8;
        border-color: #8daed9;
      }

      .friend-actions {
        display: flex;
        gap: 8px;
        margin-left: auto;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .friend-item:hover .friend-actions {
        opacity: 1;
      }

      .action-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
        backdrop-filter: blur(5px);
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      .action-btn:hover {
        transform: scale(1.1);
      }

      .action-btn:active {
        transform: scale(0.95);
      }

      .pin-btn {
        background: rgba(100, 149, 237, 0.8);
        color: white;
      }

      .pin-btn:hover {
        background: rgba(100, 149, 237, 1);
        transform: scale(1.1);
      }

      .pin-btn.pinned {
        background: rgba(255, 107, 107, 0.8);
      }

      .pin-btn.pinned:hover {
        background: rgba(255, 107, 107, 1);
      }

      .delete-btn {
        background: rgba(255, 107, 107, 0.8);
        color: white;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      .delete-btn:hover {
        background: rgba(255, 107, 107, 1);
        transform: scale(1.15);
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
      }

      .delete-btn:active {
        transform: scale(0.95);
        background: rgba(220, 90, 90, 1);
      }

      /* é€šç”¨æ¨¡æ€æ¡†æ ·å¼ (æ·»åŠ å¥½å‹) */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
      }

      .modal h2 {
        margin-bottom: 20px;
        color: #333;
        text-align: center;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: 500;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5a6fd8;
      }

      .btn-secondary {
        background: #e9ecef;
        color: #6c757d;
      }

      .btn-secondary:hover {
        background: #dee2e6;
      }

      /* ==================== å¯¼å…¥/å¯¼å‡ºæ¨¡æ€æ¡†æ ·å¼ (æ–°å¢) ==================== */
      #importExportOverlay {
        display: none; /* é»˜è®¤éšè— */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1001; /* æ¯”æ™®é€šæ¨¡æ€æ¡†å±‚çº§æ›´é«˜ */
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      /* å¯¼å…¥/å¯¼å‡ºæ¨¡æ€æ¡†çš„ç‰¹å®šæ ·å¼ */
      #importExportOverlay .modal {
        display: flex;
        flex-direction: column;
        position: relative;
        top: auto;
        left: auto;
        transform: none;
        background: white;
        padding: 0;
        border-radius: 12px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      #importExportOverlay .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #e5e5e5;
      }

      #importExportOverlay .modal-header h2 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 500;
      }

      #importExportOverlay .close-btn {
        background: transparent;
        border: 0;
        font-size: 1.5rem;
        line-height: 1;
        color: #888;
        cursor: pointer;
        padding: 0;
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      #importExportOverlay .close-btn:hover {
        opacity: 1;
      }

      #importExportOverlay .modal-content {
        position: static;
        transform: none;
        width: auto;
        max-width: none;
        padding: 20px;
        border-radius: 0;
        overflow-y: auto;
      }

      .import-export-section {
        margin-bottom: 15px;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
      }

      .import-export-section h3 {
        margin: 0 0 10px 0;
        color: #555555;
        font-size: 16px;
      }

      .import-export-section p {
        margin: 0 0 15px 0;
        color: #666;
        font-size: 14px;
      }

      .divider {
        height: 1px;
        background: linear-gradient(to right, transparent, #cccccc, transparent);
        margin: 20px 0;
      }

      #selectedFileName {
        min-height: 16px;
        font-style: italic;
      }
      #selectedFileName:empty::before {
        content: 'æœªé€‰æ‹©æ–‡ä»¶';
        color: #999;
      }

      #jsonPreview {
        resize: vertical;
        min-height: 100px;
        max-height: 300px;
      }

      .submit-btn {
        background-color: #6c757d;
        color: white;
      }

      input[type='radio'] {
        accent-color: #888888;
      }
      .submit-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .submit-btn:disabled:hover {
        background: #ccc;
        transform: none;
      }

      /* ================================================================ */

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
      }

      /* ä¸»ç•Œé¢åº”ç”¨å›¾æ ‡æ ·å¼ */
      .apps-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .app-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        max-width: 220px;
        justify-items: center;
      }

      .app-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 15px;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
      }

      .app-item:hover {
        transform: translateY(-5px) scale(1.05);
        background: rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .app-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      .app-item:hover .app-icon {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      .friends-icon {
        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      }

      .bilibili-icon {
        background: linear-gradient(135deg, #00a1d6, #00c4cc);
      }

      .store-icon {
        background: linear-gradient(135deg, #fd79a8, #fdcb6e);
      }

      .wb-icon {
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      }

      .settings-icon {
        background: linear-gradient(135deg, #74b9ff, #0984e3);
      }

      .app-name {
        font-size: 12px;
        font-weight: 500;
        color: #333;
        text-align: center;
        margin-top: 5px;
      }

      /* è¿”å›æŒ‰é’®æ ·å¼ */
      .back-btn {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(200, 200, 200, 0.3);
        border: 1px solid rgba(200, 200, 200, 0.5);
        color: #555555;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        z-index: 2;
      }

      .back-btn:hover {
        background: rgba(200, 200, 200, 0.5);
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      /* Bç«™ç•Œé¢æ ·å¼ */
      .bilibili-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 10;
      }

      .bilibili-content-full {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
      }

      /* è¿·ä½ æ§åˆ¶æ æ ·å¼ */
      .bilibili-mini-controls {
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        height: 35px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        z-index: 1000;
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .mini-btn {
        background: transparent;
        border: none;
        color: white;
        font-size: 16px;
        cursor: pointer;
        padding: 5px 8px;
        border-radius: 50%;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 30px;
        height: 30px;
      }

      .mini-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
      }

      .mini-btn:active {
        transform: scale(0.95);
      }

      .back-mini-btn {
        font-size: 18px;
        font-weight: bold;
      }

      .fullscreen-mini-btn {
        font-size: 14px;
      }

      .refresh-mini-btn {
        font-size: 14px;
      }

      /* å…¨å±æ¨¡å¼æ ·å¼ */
      .fullscreen-mode {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999 !important;
        background: white;
        margin: 0 !important;
        padding: 0 !important;
      }

      .fullscreen-mode .phone-shell {
        padding: 0 !important;
        background: transparent !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        width: 100vw !important;
        height: 100vh !important;
      }

      .fullscreen-mode .container {
        width: 100vw !important;
        height: 100vh !important;
        border-radius: 0 !important;
        box-shadow: none !important;
      }

      .fullscreen-mode .bilibili-screen {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 1 !important;
      }

      .fullscreen-mode .bilibili-mini-controls {
        top: 20px;
        left: 20px;
        right: 20px;
      }
    </style>
  </head>
  <body>
    <div class="phone-shell">
      <div class="container">
        <div class="status-bar">
          <div>9:41</div>
          <div>ğŸ“¶ ğŸ“¶ ğŸ“¶ ğŸ”‹</div>
        </div>
        <!-- ä¸»ç•Œé¢ -->
        <div class="main-screen" id="mainScreen">
          <div class="header">
            <h1>ä¸»ç•Œé¢</h1>
            <button class="add-btn" onclick="showDebugInfo()" style="right: 20px; font-size: 14px" title="è°ƒè¯•ä¿¡æ¯">
              â„¹ï¸
            </button>
          </div>

          <!-- åº”ç”¨å›¾æ ‡åŒºåŸŸ -->
          <div class="apps-container">
            <div class="app-grid">
              <!-- å¥½å‹åˆ—è¡¨åº”ç”¨ -->
              <div class="app-item" onclick="openFriendsApp()">
                <div class="app-icon friends-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="30px" height="30px">
                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" fill="#6c5ce7" />
                    <path
                      d="M20 10a3 3 0 11-6 0 3 3 0 016 0zM17 14a6 6 0 016 6h-3a3 3 0 00-3-3z"
                      fill="#6c5ce7"
                      opacity="0.7"
                    />
                  </svg>
                </div>
                <div class="app-name">å¥½å‹åˆ—è¡¨</div>
              </div>

              <!-- Bç«™åº”ç”¨ -->
              <div class="app-item" onclick="openBilibili()">
                <div class="app-icon bilibili-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="30px" height="30px">
                    <path
                      d="M17.813 4.653h.854c1.51.054 2.769.578 3.773 1.574 1.004.995 1.524 2.249 1.56 3.76v7.36c-.036 1.51-.556 2.769-1.56 3.773s-2.262 1.524-3.773 1.56H5.333c-1.51-.036-2.769-.556-3.773-1.56S.036 18.858 0 17.347v-7.36c.036-1.511.556-2.765 1.56-3.76 1.004-.996 2.262-1.52 3.773-1.574h.774l-1.174-1.12a1.234 1.234 0 0 1-.373-.906c0-.356.124-.658.373-.907l.027-.027c.267-.249.573-.373.92-.373.347 0 .653.124.92.373L9.653 4.44c.071.071.134.142.187.213h4.267a.836.836 0 0 1 .16-.213l2.853-2.747c.267-.249.573-.373.92-.373.347 0 .662.151.929.4.267.249.391.551.391.907 0 .356-.124.657-.373.906l-1.174 1.12zM5.333 7.24c-.746.018-1.373.276-1.88.773-.506.498-.769 1.13-.789 1.894v7.52c.02.764.283 1.395.789 1.893.507.498 1.134.756 1.88.773h13.334c.746-.017 1.373-.275 1.88-.773.506-.498.769-1.129.789-1.893v-7.52c-.02-.765-.283-1.396-.789-1.894-.507-.497-1.134-.755-1.88-.773H5.333zM8 11.107c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373zm8 0c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373z"
                    />
                  </svg>
                </div>
                <div class="app-name">å“”å“©å“”å“©</div>
              </div>

              <!-- å•†åº—åº”ç”¨ -->
              <div class="app-item" onclick="openStore()">
                <div class="app-icon store-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="30px" height="30px">
                    <path
                      d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM10 6a2 2 0 0 1 4 0v1h-4V6zm8 13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V9h2v1a1 1 0 0 0 2 0V9h4v1a1 1 0 0 0 2 0V9h2v10z"
                    />
                  </svg>
                </div>
                <div class="app-name">åº”ç”¨å•†åº—</div>
              </div>

              <!-- å¾®åšåº”ç”¨ -->
              <div class="app-item" onclick="openwb()">
                <div class="app-icon wb-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="30px" height="30px">
                    <path
                      d="M20.194 14.197c0 3.362-3.53 6.086-7.885 6.086-4.354 0-7.885-2.724-7.885-6.086 0-3.361 3.531-6.085 7.885-6.085 4.355 0 7.885 2.724 7.885 6.085zm-7.885 4.567c3.096 0 5.606-1.456 5.606-3.252 0-1.795-2.51-3.251-5.606-3.251s-5.606 1.456-5.606 3.251c0 1.796 2.51 3.252 5.606 3.252zm2.804-3.252c0 .896-.896 1.622-2.001 1.622s-2.001-.726-2.001-1.622.896-1.622 2.001-1.622 2.001.726 2.001 1.622zm-3.202-.811c0 .448-.362.811-.809.811s-.809-.363-.809-.811.362-.811.809-.811.809.363.809.811z"
                    />
                    <path
                      d="M18.5 2.5c-1.933 0-3.5 1.567-3.5 3.5s1.567 3.5 3.5 3.5 3.5-1.567 3.5-3.5-1.567-3.5-3.5-3.5zm0 5.5c-1.103 0-2-.897-2-2s.897-2 2-2 2 .897 2 2-.897 2-2 2z"
                    />
                    <path d="M16 4.5c-.828 0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5 1.5-.672 1.5-1.5-.672-1.5-1.5-1.5z" />
                  </svg>
                </div>
                <div class="app-name">å¾®åš</div>
              </div>

              <!-- è®¾ç½®åº”ç”¨ -->
              <div class="app-item" onclick="openSettings()">
                <div class="app-icon settings-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="30px" height="30px">
                    <path
                      d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"
                    />
                  </svg>
                </div>
                <div class="app-name">è®¾ç½®</div>
              </div>
            </div>
          </div>
        </div>

        <!-- å¥½å‹åˆ—è¡¨ç•Œé¢ -->
        <div class="friends-screen" id="friendsScreen" style="display: none">
          <div class="header">
            <button class="back-btn" onclick="backToMain()">â†</button>
            <h1>å¥½å‹åˆ—è¡¨</h1>
            <button class="add-btn" onclick="openAddModal()">+</button>
            <button class="add-btn" onclick="showDebugInfo()" style="right: 65px; font-size: 14px" title="è°ƒè¯•ä¿¡æ¯">
              â„¹ï¸
            </button>
            <button
              class="add-btn"
              onclick="showImportExportModal()"
              style="right: 105px; font-size: 12px"
              title="å¯¼å…¥/å¯¼å‡ºå¥½å‹"
            >
              ğŸ“
            </button>
          </div>

          <div class="friends-list" id="friendsList">
            <div class="empty-state">
              <i>ğŸ‘¥</i>
              <p>æš‚æ— å¥½å‹ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ å¥½å‹æˆ–ç¾¤èŠ</p>
            </div>
          </div>
        </div>

        <!-- Bç«™ç•Œé¢ -->
        <div class="bilibili-screen" id="bilibiliScreen" style="display: none">
          <!-- è¿·ä½ æ§åˆ¶æ  -->
          <div class="bilibili-mini-controls">
            <button class="mini-btn back-mini-btn" onclick="backToMain()" title="è¿”å›">â†</button>
            <button class="mini-btn" onclick="openBilibiliLogin()" title="å¤–éƒ¨ç™»å½•">ğŸ”‘</button>
            <button
              class="mini-btn fullscreen-mini-btn"
              onclick="toggleFullscreen()"
              title="å…¨å±/é€€å‡ºå…¨å±"
              id="fullscreenBtn"
            >
              â›¶
            </button>
            <button class="mini-btn refresh-mini-btn" onclick="refreshBilibili()" title="åˆ·æ–°">ğŸ”„</button>
          </div>

          <div class="bilibili-content-full">
            <!-- Bç«™ç½‘é¡µå†…å®¹ -->
            <iframe
              id="bilibiliFrame"
              src="https://www.bilibili.com"
              style="width: 100%; height: 100%; border: none; background: white"
              sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-presentation allow-top-navigation-by-user-activation allow-storage-access-by-user-activation"
              loading="lazy"
              allowfullscreen
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; storage-access"
              referrerpolicy="no-referrer-when-downgrade"
            >
            </iframe>
          </div>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ å¥½å‹/ç¾¤èŠæ¨¡æ€æ¡† -->
    <div class="modal" id="addModal">
      <div class="modal-content">
        <!-- ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©ç±»å‹ -->
        <div id="typeSelection">
          <h2>æ·»åŠ å¥½å‹/ç¾¤èŠ</h2>
          <p style="text-align: center; color: #666; margin-bottom: 20px">è¯·é€‰æ‹©è¦æ·»åŠ çš„ç±»å‹</p>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="selectType('friend')">ğŸ‘¤ æ·»åŠ å¥½å‹</button>
            <button class="btn btn-primary" onclick="selectType('group')">ğŸ‘¥ æ·»åŠ ç¾¤èŠ</button>
          </div>
          <div style="text-align: center; margin-top: 15px">
            <button class="btn btn-secondary" onclick="closeAddModal()">å–æ¶ˆ</button>
          </div>
        </div>

        <!-- ç¬¬äºŒæ­¥ï¼šæ·»åŠ å¥½å‹ -->
        <div id="friendForm" style="display: none">
          <h2>æ·»åŠ å¥½å‹</h2>
          <div class="form-group">
            <label for="friendName">å¥½å‹å§“å</label>
            <input type="text" id="friendName" placeholder="è¯·è¾“å…¥å¥½å‹å§“å" />
          </div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="backToTypeSelection()">è¿”å›</button>
            <button class="btn btn-primary" onclick="addFriend()">æ·»åŠ å¥½å‹</button>
          </div>
        </div>

        <!-- ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ ç¾¤èŠ -->
        <div id="groupForm" style="display: none">
          <h2>æ·»åŠ ç¾¤èŠ</h2>
          <div class="form-group">
            <label for="groupName">ç¾¤èŠåç§°</label>
            <input type="text" id="groupName" placeholder="è¯·è¾“å…¥ç¾¤èŠåç§°" />
          </div>
          <div class="form-group">
            <label for="groupMembers">ç¾¤æˆå‘˜</label>
            <textarea id="groupMembers" placeholder="è¯·è¾“å…¥ç¾¤æˆå‘˜ï¼Œç”¨é€—å·éš”å¼€&#10;ä¾‹å¦‚ï¼šå¼ ä¸‰,æå››,ç‹äº”"></textarea>
          </div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="backToTypeSelection()">è¿”å›</button>
            <button class="btn btn-primary" onclick="addGroup()">æ·»åŠ ç¾¤èŠ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- å¯¼å…¥/å¯¼å‡ºæ¨¡æ€æ¡† -->
    <div id="importExportOverlay">
      <div class="modal">
        <div class="modal-header">
          <h2>ğŸ“ å¯¼å…¥/å¯¼å‡ºå¥½å‹åˆ—è¡¨</h2>
          <button class="close-btn" onclick="closeImportExportModal()">Ã—</button>
        </div>
        <div class="modal-content">
          <!-- å¯¼å‡ºåŒºåŸŸ -->
          <div class="import-export-section">
            <h3>ğŸ“¤ å¯¼å‡ºå¥½å‹åˆ—è¡¨</h3>
            <p>å°†å½“å‰è§’è‰²çš„å¥½å‹åˆ—è¡¨å¯¼å‡ºä¸ºJSONæ–‡ä»¶</p>
            <div style="margin: 15px 0">
              <button class="btn submit-btn" onclick="exportFriends()" style="width: 100%">ğŸ“¥ å¯¼å‡ºä¸ºJSONæ–‡ä»¶</button>
            </div>
          </div>

          <div class="divider"></div>

          <!-- è¿œç¨‹ä¸–ç•Œä¹¦å¯¼å…¥åŒºåŸŸ -->
          <div class="import-export-section">
            <h3>ğŸŒ è¿œç¨‹ä¸–ç•Œä¹¦å¯¼å…¥</h3>
            <p>ä½¿ç”¨é¢„è®¾åœ°å€å¯¼å…¥ä¸–ç•Œä¹¦åˆ°å½“å‰è§’è‰²ä¸»ä¸–ç•Œä¹¦</p>

            <div style="margin: 15px 0">
              <button class="btn submit-btn" onclick="importRemoteWorldbook()" style="width: 100%; margin-bottom: 10px">
                ğŸŒ å¯¼å…¥è¿œç¨‹ä¸–ç•Œä¹¦
              </button>
              <div style="font-size: 12px; color: #666; text-align: center">é“¾æ¥å·²éšè—ï¼ˆä»…æœ¬åœ°ä¿å­˜ï¼Œå¯éšæ—¶æ›´æ”¹ï¼‰ã€‚</div>
            </div>

            <!-- è‡ªåŠ¨æ›´æ–°è®¾ç½® -->
            <div style="margin: 15px 0">
              <label style="display: flex; align-items: center; margin-bottom: 10px">
                <input type="checkbox" id="autoUpdateWorldbook" style="margin-right: 8px" />
                <span>å¯ç”¨è‡ªåŠ¨æ›´æ–°ï¼ˆæ¯24å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼‰</span>
              </label>
              <div style="font-size: 12px; color: #666">å¯ç”¨åä¼šå®šæœŸæ£€æŸ¥è¿œç¨‹ä¸–ç•Œä¹¦æ›´æ–°å¹¶è‡ªåŠ¨åˆå¹¶åˆ°ä¸»ä¸–ç•Œä¹¦</div>
            </div>
          </div>

          <div class="divider"></div>

          <!-- å¯¼å…¥åŒºåŸŸ -->
          <div class="import-export-section">
            <h3>ğŸ“¥ å¯¼å…¥å¥½å‹åˆ—è¡¨</h3>
            <p>ä»JSONæ–‡ä»¶å¯¼å…¥å¥½å‹åˆ—è¡¨åˆ°å½“å‰è§’è‰²</p>

            <!-- æ–‡ä»¶é€‰æ‹© -->
            <div style="margin: 15px 0">
              <input
                type="file"
                id="importFileInput"
                accept=".json"
                style="display: none"
                onchange="handleFileSelect(event)"
              />
              <button
                class="btn submit-btn"
                onclick="document.getElementById('importFileInput').click()"
                style="width: 100%; margin-bottom: 10px"
              >
                ğŸ“ é€‰æ‹©JSONæ–‡ä»¶
              </button>
              <div id="selectedFileName" style="font-size: 12px; color: #666; text-align: center"></div>
            </div>

            <!-- å¯¼å…¥é€‰é¡¹ -->
            <div style="margin: 15px 0">
              <label style="display: flex; align-items: center; margin-bottom: 10px">
                <input type="radio" name="importMode" value="replace" checked style="margin-right: 8px" />
                <span>æ›¿æ¢ç°æœ‰å¥½å‹åˆ—è¡¨</span>
              </label>
              <label style="display: flex; align-items: center">
                <input type="radio" name="importMode" value="merge" style="margin-right: 8px" />
                <span>åˆå¹¶åˆ°ç°æœ‰å¥½å‹åˆ—è¡¨ï¼ˆè·³è¿‡é‡å¤ï¼‰</span>
              </label>
            </div>

            <!-- å¯¼å…¥æŒ‰é’® -->
            <div style="margin: 15px 0">
              <button class="btn submit-btn" onclick="importFriends()" style="width: 100%" id="importBtn" disabled>
                ğŸ“¥ å¯¼å…¥å¥½å‹åˆ—è¡¨
              </button>
            </div>
          </div>

          <!-- JSONé¢„è§ˆåŒºåŸŸ -->
          <div class="import-export-section" id="jsonPreviewSection" style="display: none">
            <h3>ğŸ“‹ JSONé¢„è§ˆ</h3>
            <textarea
              id="jsonPreview"
              readonly
              style="
                width: 100%;
                height: 150px;
                font-family: monospace;
                font-size: 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 8px;
                background: #f9f9f9;
              "
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==================== è§’è‰²å¡ç‹¬ç«‹å­˜å‚¨ç³»ç»Ÿ ====================

      // è·å–å½“å‰è§’è‰²ä¿¡æ¯ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
      function getCurrentCharacterInfo() {
        try {
          // æ–¹æ³•1: ä»SillyTavernçš„å…¨å±€å˜é‡è·å–å½“å‰è§’è‰²ID
          if (typeof parent !== 'undefined' && parent.this_chid !== undefined) {
            const charId = parent.this_chid;
            let charName = 'æœªçŸ¥è§’è‰²';

            // å°è¯•è·å–è§’è‰²åç§°
            if (parent.characters && parent.characters[charId]) {
              charName = parent.characters[charId].name || parent.characters[charId].data?.name || `è§’è‰²${charId}`;
            } else if (parent.name1) {
              charName = parent.name1; // å½“å‰èŠå¤©ä¸­çš„è§’è‰²å
            }

            console.log('ä»SillyTavernè·å–è§’è‰²ä¿¡æ¯:', { id: charId, name: charName });
            return {
              id: charId.toString(),
              name: charName,
              source: 'sillytavern_chid',
            };
          }

          // æ–¹æ³•2: ä»SillyTavernçš„context APIè·å–
          if (typeof parent !== 'undefined' && parent.getContext) {
            const context = parent.getContext();
            if (context && context.characterId) {
              console.log('ä»context APIè·å–è§’è‰²ä¿¡æ¯:', context);
              return {
                id: context.characterId.toString(),
                name: context.name || context.characterId,
                source: 'sillytavern_context',
              };
            }
          }

          // æ–¹æ³•3: ä»URLå‚æ•°è·å–è§’è‰²ä¿¡æ¯
          const urlParams = new URLSearchParams(window.location.search);
          const charId = urlParams.get('character') || urlParams.get('char') || urlParams.get('id');
          if (charId) {
            console.log('ä»URLå‚æ•°è·å–è§’è‰²ä¿¡æ¯:', charId);
            return {
              id: charId,
              name: charId,
              source: 'url',
            };
          }

          // æ–¹æ³•4: ä»localStorageè·å–æœ€åä½¿ç”¨çš„è§’è‰²
          const lastCharId = localStorage.getItem('lastUsedCharacter');
          if (lastCharId) {
            console.log('ä»localStorageè·å–æœ€åä½¿ç”¨çš„è§’è‰²:', lastCharId);
            return {
              id: lastCharId,
              name: `è§’è‰²${lastCharId}`,
              source: 'localStorage',
            };
          }

          // é»˜è®¤è§’è‰²
          console.log('ä½¿ç”¨é»˜è®¤è§’è‰²');
          return {
            id: 'default',
            name: 'é»˜è®¤è§’è‰²',
            source: 'default',
          };
        } catch (error) {
          console.warn('è·å–è§’è‰²ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è§’è‰²:', error);
          return {
            id: 'default',
            name: 'é»˜è®¤è§’è‰²',
            source: 'default',
          };
        }
      }

      // ç”Ÿæˆè§’è‰²ä¸“ç”¨çš„å­˜å‚¨é”®å
      function getFriendsStorageKey() {
        const charInfo = getCurrentCharacterInfo();
        // ä½¿ç”¨æ›´å…·ä½“çš„é”®åæ ¼å¼ï¼Œç¡®ä¿ä¸åŒè§’è‰²å®Œå…¨éš”ç¦»
        return `tavern_friends_${charInfo.source}_${charInfo.id}`;
      }

      // ä¿å­˜å½“å‰è§’è‰²IDåˆ°localStorageï¼Œç”¨äºè§’è‰²åˆ‡æ¢æ£€æµ‹
      function saveCurrentCharacterId() {
        const charInfo = getCurrentCharacterInfo();
        localStorage.setItem('lastUsedCharacter', charInfo.id);
        console.log('ä¿å­˜å½“å‰è§’è‰²ID:', charInfo.id);
      }

      // ä»è§’è‰²ä¸“ç”¨å­˜å‚¨åŠ è½½å¥½å‹åˆ—è¡¨
      function loadFriends() {
        try {
          const storageKey = getFriendsStorageKey();
          const charInfo = getCurrentCharacterInfo();

          console.log(`ä¸ºè§’è‰² "${charInfo.name}" åŠ è½½å¥½å‹åˆ—è¡¨ï¼Œå­˜å‚¨é”®: ${storageKey}`);

          // ä¼˜å…ˆä»SillyTavern extension_settingsè¯»å–
          let friends = [];
          if (typeof parent !== 'undefined' && parent.extension_settings) {
            friends = parent.extension_settings[storageKey] || [];
          } else {
            // å›é€€åˆ°localStorage
            friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
          }

          // å¦‚æœå½“å‰è§’è‰²æ²¡æœ‰å¥½å‹æ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦è¿ç§»æ—§æ•°æ®
          if (friends.length === 0) {
            const migrated = migrateOldFriendsData();
            if (migrated) {
              // é‡æ–°åŠ è½½è¿ç§»åçš„æ•°æ®
              if (typeof parent !== 'undefined' && parent.extension_settings) {
                friends = parent.extension_settings[storageKey] || [];
              } else {
                friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
              }
            }
          }

          displayFriends(friends);

          // åœ¨æ ‡é¢˜ä¸­æ˜¾ç¤ºå½“å‰è§’è‰²
          updateHeaderWithCharacter(charInfo);
        } catch (error) {
          console.error('åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
          displayFriends([]);
        }
      }

      // ä¿å­˜å¥½å‹åˆ—è¡¨åˆ°è§’è‰²ä¸“ç”¨å­˜å‚¨
      function saveFriends(friends) {
        try {
          const storageKey = getFriendsStorageKey();
          const charInfo = getCurrentCharacterInfo();

          console.log(`ä¸ºè§’è‰² "${charInfo.name}" ä¿å­˜å¥½å‹åˆ—è¡¨ï¼Œå­˜å‚¨é”®: ${storageKey}ï¼Œå¥½å‹æ•°é‡: ${friends.length}`);

          // ä¼˜å…ˆä¿å­˜åˆ°SillyTavern extension_settings
          if (typeof parent !== 'undefined' && parent.extension_settings) {
            parent.extension_settings[storageKey] = JSON.parse(JSON.stringify(friends));
            // è§¦å‘SillyTavernçš„è®¾ç½®ä¿å­˜
            if (typeof parent.saveSettingsDebounced === 'function') {
              parent.saveSettingsDebounced();
            }
          }

          // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
          localStorage.setItem(storageKey, JSON.stringify(friends));
        } catch (error) {
          console.error('ä¿å­˜å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
        }
      }

      // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºå½“å‰è§’è‰²
      function updateHeaderWithCharacter(charInfo) {
        const header = document.querySelector('.header h1');
        if (header) {
          header.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div style="font-size: 18px;">å¥½å‹åˆ—è¡¨</div>
              <div style="font-size: 12px; color: #555555; margin-top: 2px;">
                ${charInfo.name}
              </div>
            </div>
          `;
        }
      }

      // æ•°æ®è¿ç§»ï¼šå°†æ—§çš„å…¨å±€å¥½å‹åˆ—è¡¨è¿ç§»åˆ°å½“å‰è§’è‰²
      function migrateOldFriendsData() {
        try {
          const oldFriends = JSON.parse(localStorage.getItem('friendsList') || '[]');
          if (oldFriends.length > 0) {
            const charInfo = getCurrentCharacterInfo();
            const storageKey = getFriendsStorageKey();

            // æ£€æŸ¥å½“å‰è§’è‰²æ˜¯å¦å·²æœ‰å¥½å‹æ•°æ®
            let currentFriends = [];
            if (typeof parent !== 'undefined' && parent.extension_settings) {
              currentFriends = parent.extension_settings[storageKey] || [];
            } else {
              currentFriends = JSON.parse(localStorage.getItem(storageKey) || '[]');
            }

            // å¦‚æœå½“å‰è§’è‰²æ²¡æœ‰å¥½å‹æ•°æ®ï¼Œè¯¢é—®æ˜¯å¦è¿ç§»
            if (currentFriends.length === 0) {
              const shouldMigrate = confirm(
                `æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬çš„å¥½å‹åˆ—è¡¨æ•°æ®ï¼ˆ${oldFriends.length}ä¸ªå¥½å‹ï¼‰ã€‚\n` +
                  `æ˜¯å¦è¦å°†è¿™äº›å¥½å‹è¿ç§»åˆ°å½“å‰è§’è‰² "${charInfo.name}" çš„å¥½å‹åˆ—è¡¨ä¸­ï¼Ÿ\n\n` +
                  `ç‚¹å‡»"ç¡®å®š"è¿ç§»ï¼Œç‚¹å‡»"å–æ¶ˆ"ä¿æŒå½“å‰çŠ¶æ€ã€‚`,
              );

              if (shouldMigrate) {
                saveFriends(oldFriends);
                console.log(`å·²å°† ${oldFriends.length} ä¸ªå¥½å‹è¿ç§»åˆ°è§’è‰² "${charInfo.name}"`);

                // è¯¢é—®æ˜¯å¦æ¸…é™¤æ—§æ•°æ®
                const shouldClearOld = confirm(
                  `å¥½å‹æ•°æ®è¿ç§»å®Œæˆï¼\n\n` + `æ˜¯å¦è¦æ¸…é™¤æ—§ç‰ˆæœ¬çš„å…¨å±€å¥½å‹åˆ—è¡¨æ•°æ®ï¼Ÿ\n` + `ï¼ˆå»ºè®®æ¸…é™¤ï¼Œé¿å…æ•°æ®æ··ä¹±ï¼‰`,
                );

                if (shouldClearOld) {
                  localStorage.removeItem('friendsList');
                  console.log('å·²æ¸…é™¤æ—§ç‰ˆæœ¬çš„å…¨å±€å¥½å‹åˆ—è¡¨æ•°æ®');
                }

                return true; // è¡¨ç¤ºè¿›è¡Œäº†è¿ç§»
              }
            }
          }
        } catch (error) {
          console.error('æ•°æ®è¿ç§»å¤±è´¥:', error);
        }
        return false; // è¡¨ç¤ºæ²¡æœ‰è¿›è¡Œè¿ç§»
      }

      // æ˜¾ç¤ºå¥½å‹åˆ—è¡¨
      function displayFriends(friends) {
        const friendsList = document.getElementById('friendsList');

        if (friends.length === 0) {
          friendsList.innerHTML = `
                    <div class="empty-state">
                        <i>ğŸ‘¥</i>
                        <p>æš‚æ— å¥½å‹ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ å¥½å‹æˆ–ç¾¤èŠ</p>
                    </div>
                `;
          return;
        }

        // æŒ‰ç½®é¡¶çŠ¶æ€æ’åºï¼Œç½®é¡¶çš„åœ¨å‰é¢
        const sortedFriends = friends.sort((a, b) => {
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          return 0;
        });

        friendsList.innerHTML = sortedFriends
          .map(
            (friend, index) => `
                <div class="friend-item ${friend.pinned ? 'pinned' : ''}" onclick="startChat('${friend.name}', '${
              friend.type
            }', '${friend.members || ''}')">
                    <div class="friend-avatar">
                        ${friend.type === 'group' ? 'ğŸ‘¥' : friend.name.charAt(0)}
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">
                            ${friend.name}
                            ${friend.type === 'group' ? '<span class="group-badge">ç¾¤èŠ</span>' : ''}
                            ${friend.pinned ? '<span class="pinned-badge">ğŸ“Œ</span>' : ''}
                        </div>
                        <div class="friend-type">
                            ${friend.type === 'group' ? `æˆå‘˜: ${friend.members}` : 'å¥½å‹'}
                        </div>
                    </div>
                    <div class="friend-actions">
                        <button class="action-btn pin-btn ${friend.pinned ? 'pinned' : ''}"
                                onclick="handlePinClick(event, ${index})"
                                title="${friend.pinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}">
                            ${friend.pinned ? 'ğŸ“Œ' : 'ğŸ“'}
                        </button>
                        <button class="action-btn delete-btn"
                                onclick="handleDeleteClick(event, ${index})"
                                title="åˆ é™¤å¥½å‹">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `,
          )
          .join('');
      }

      // æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
      function openAddModal() {
        document.getElementById('addModal').style.display = 'block';
        showTypeSelection();
      }

      // å…³é—­æ·»åŠ æ¨¡æ€æ¡†
      function closeAddModal() {
        document.getElementById('addModal').style.display = 'none';
        resetForms();
      }

      // æ˜¾ç¤ºç±»å‹é€‰æ‹©ç•Œé¢
      function showTypeSelection() {
        document.getElementById('typeSelection').style.display = 'block';
        document.getElementById('friendForm').style.display = 'none';
        document.getElementById('groupForm').style.display = 'none';
      }

      // é€‰æ‹©ç±»å‹ï¼ˆå¥½å‹æˆ–ç¾¤èŠï¼‰
      function selectType(type) {
        document.getElementById('typeSelection').style.display = 'none';

        if (type === 'friend') {
          document.getElementById('friendForm').style.display = 'block';
          document.getElementById('friendName').focus();
        } else if (type === 'group') {
          document.getElementById('groupForm').style.display = 'block';
          document.getElementById('groupName').focus();
        }
      }

      // è¿”å›ç±»å‹é€‰æ‹©
      function backToTypeSelection() {
        resetForms();
        showTypeSelection();
      }

      // é‡ç½®è¡¨å•
      function resetForms() {
        document.getElementById('friendName').value = '';
        document.getElementById('groupName').value = '';
        document.getElementById('groupMembers').value = '';
      }

      // æ·»åŠ å¥½å‹
      function addFriend() {
        const name = document.getElementById('friendName').value.trim();

        if (!name) {
          alert('è¯·è¾“å…¥å¥½å‹å§“å');
          return;
        }

        // ä½¿ç”¨è§’è‰²ä¸“ç”¨å­˜å‚¨åŠ è½½å¥½å‹åˆ—è¡¨
        const storageKey = getFriendsStorageKey();
        let friends = [];
        if (typeof parent !== 'undefined' && parent.extension_settings) {
          friends = parent.extension_settings[storageKey] || [];
        } else {
          friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
        }

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        if (friends.some(friend => friend.name === name)) {
          alert('è¯¥å¥½å‹å·²å­˜åœ¨');
          return;
        }

        const newFriend = {
          name: name,
          type: 'friend',
          members: null,
          addTime: new Date().toISOString(),
        };

        friends.push(newFriend);
        saveFriends(friends); // ä½¿ç”¨æ–°çš„ä¿å­˜å‡½æ•°

        displayFriends(friends);
        closeAddModal();

        const charInfo = getCurrentCharacterInfo();
        alert(`å¥½å‹ "${name}" å·²æ·»åŠ åˆ° "${charInfo.name}" çš„å¥½å‹åˆ—è¡¨ï¼`);
      }

      // æ·»åŠ ç¾¤èŠ
      function addGroup() {
        const name = document.getElementById('groupName').value.trim();
        const members = document.getElementById('groupMembers').value.trim();

        if (!name) {
          alert('è¯·è¾“å…¥ç¾¤èŠåç§°');
          return;
        }

        if (!members) {
          alert('è¯·è¾“å…¥ç¾¤æˆå‘˜');
          return;
        }

        // ä½¿ç”¨è§’è‰²ä¸“ç”¨å­˜å‚¨åŠ è½½å¥½å‹åˆ—è¡¨
        const storageKey = getFriendsStorageKey();
        let friends = [];
        if (typeof parent !== 'undefined' && parent.extension_settings) {
          friends = parent.extension_settings[storageKey] || [];
        } else {
          friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
        }

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        if (friends.some(friend => friend.name === name)) {
          alert('è¯¥ç¾¤èŠå·²å­˜åœ¨');
          return;
        }

        const newGroup = {
          name: name,
          type: 'group',
          members: members,
          addTime: new Date().toISOString(),
        };

        friends.push(newGroup);
        saveFriends(friends); // ä½¿ç”¨æ–°çš„ä¿å­˜å‡½æ•°

        displayFriends(friends);
        closeAddModal();

        const charInfo = getCurrentCharacterInfo();
        alert(`ç¾¤èŠ "${name}" å·²æ·»åŠ åˆ° "${charInfo.name}" çš„å¥½å‹åˆ—è¡¨ï¼`);
      }

      // å¼€å§‹èŠå¤©
      function startChat(name, type, members) {
        if (typeof triggerSlash === 'function') {
          if (type === 'group') {
            const message = `/send <ç¾¤æˆå‘˜ï¼š${members}>
ã€å’Œ${name}çš„èŠå¤©ã€‘
<qunliao>
</qunliao>`;
            triggerSlash(message);
          } else {
            const message = `/send ã€å’Œ${name}çš„èŠå¤©ã€‘
<shouji>
</shouji>`;
            triggerSlash(message);
          }
        } else {
          // å¦‚æœtriggerSlashä¸å¯ç”¨ï¼Œæ˜¾ç¤ºæ¶ˆæ¯å†…å®¹
          if (type === 'group') {
            console.log(`<ç¾¤æˆå‘˜ï¼š${members}>
ã€å’Œ${name}çš„èŠå¤©ã€‘
<qunliao>
</qunliao>`);
            alert(`ç¾¤èŠæ¶ˆæ¯ï¼š<ç¾¤æˆå‘˜ï¼š${members}>
ã€å’Œ${name}çš„èŠå¤©ã€‘
<qunliao>
</qunliao>`);
          } else {
            console.log(`ã€å’Œ${name}çš„èŠå¤©ã€‘
<shouji>
</shouji>`);
            alert(`å¥½å‹æ¶ˆæ¯ï¼šã€å’Œ${name}çš„èŠå¤©ã€‘
<shouji>
</shouji>`);
          }
        }
      }

      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      document.getElementById('addModal').addEventListener('click', function (e) {
        if (e.target === this) {
          closeAddModal();
        }
      });

      // å›è½¦é”®æ·»åŠ å¥½å‹
      document.getElementById('friendName').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          addFriend();
        }
      });

      // å›è½¦é”®æ·»åŠ ç¾¤èŠï¼ˆç¾¤èŠåç§°è¾“å…¥æ¡†ï¼‰
      document.getElementById('groupName').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          document.getElementById('groupMembers').focus();
        }
      });

      // åˆ‡æ¢ç½®é¡¶çŠ¶æ€
      function togglePin(index) {
        // ä½¿ç”¨è§’è‰²ä¸“ç”¨å­˜å‚¨åŠ è½½å¥½å‹åˆ—è¡¨
        const storageKey = getFriendsStorageKey();
        let friends = [];
        if (typeof parent !== 'undefined' && parent.extension_settings) {
          friends = parent.extension_settings[storageKey] || [];
        } else {
          friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
        }

        friends[index].pinned = !friends[index].pinned;
        saveFriends(friends); // ä½¿ç”¨æ–°çš„ä¿å­˜å‡½æ•°
        displayFriends(friends);
      }

      // å¤„ç†ç½®é¡¶æŒ‰é’®ç‚¹å‡»
      function handlePinClick(event, index) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();

        console.log('ç½®é¡¶æŒ‰é’®è¢«ç‚¹å‡»ï¼Œç´¢å¼•:', index);
        togglePin(index);
      }

      // å¤„ç†åˆ é™¤æŒ‰é’®ç‚¹å‡»
      function handleDeleteClick(event, index) {
        event.preventDefault();
        event.stopPropagation();
        event.stopImmediatePropagation();

        console.log('åˆ é™¤æŒ‰é’®è¢«ç‚¹å‡»ï¼Œç´¢å¼•:', index);
        deleteFriend(index);
      }

      // åˆ é™¤å¥½å‹ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
      function deleteFriend(index) {
        try {
          // è·å–å½“å‰å¥½å‹åˆ—è¡¨
          const storageKey = getFriendsStorageKey();
          let friends = [];
          if (typeof parent !== 'undefined' && parent.extension_settings) {
            friends = parent.extension_settings[storageKey] || [];
          } else {
            friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
          }

          // æ£€æŸ¥ç´¢å¼•æ˜¯å¦æœ‰æ•ˆ
          if (index < 0 || index >= friends.length) {
            console.error('åˆ é™¤å¤±è´¥ï¼šæ— æ•ˆçš„ç´¢å¼•', index);
            alert('åˆ é™¤å¤±è´¥ï¼šå¥½å‹ä¸å­˜åœ¨');
            return;
          }

          const friendToDelete = friends[index];
          const charInfo = getCurrentCharacterInfo();

          // ç¡®è®¤åˆ é™¤
          const confirmMessage = `ç¡®å®šè¦åˆ é™¤${friendToDelete.type === 'group' ? 'ç¾¤èŠ' : 'å¥½å‹'} "${
            friendToDelete.name
          }" å—ï¼Ÿ\n\nè¿™å°†ä» "${charInfo.name}" çš„å¥½å‹åˆ—è¡¨ä¸­æ°¸ä¹…ç§»é™¤ã€‚`;

          if (confirm(confirmMessage)) {
            console.log(`åˆ é™¤${friendToDelete.type === 'group' ? 'ç¾¤èŠ' : 'å¥½å‹'}:`, friendToDelete.name);

            // ä»æ•°ç»„ä¸­åˆ é™¤
            friends.splice(index, 1);

            // ä¿å­˜æ›´æ–°åçš„åˆ—è¡¨
            saveFriends(friends);

            // é‡æ–°æ˜¾ç¤ºåˆ—è¡¨
            displayFriends(friends);

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert(
              `å·²ä» "${charInfo.name}" çš„å¥½å‹åˆ—è¡¨ä¸­åˆ é™¤${friendToDelete.type === 'group' ? 'ç¾¤èŠ' : 'å¥½å‹'} "${
                friendToDelete.name
              }"`,
            );

            console.log('åˆ é™¤æˆåŠŸï¼Œå‰©ä½™å¥½å‹æ•°é‡:', friends.length);
          }
        } catch (error) {
          console.error('åˆ é™¤å¥½å‹æ—¶å‘ç”Ÿé”™è¯¯:', error);
          alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      }

      // è§’è‰²åˆ‡æ¢æ£€æµ‹ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
      let currentCharacterId = null;
      let lastCheckTime = 0;

      function checkCharacterChange() {
        try {
          const now = Date.now();
          // é¿å…è¿‡äºé¢‘ç¹çš„æ£€æŸ¥
          if (now - lastCheckTime < 1000) return;
          lastCheckTime = now;

          const charInfo = getCurrentCharacterInfo();
          const newCharId = charInfo.id;

          if (currentCharacterId !== newCharId) {
            console.log(`ğŸ”„ è§’è‰²åˆ‡æ¢æ£€æµ‹: "${currentCharacterId}" -> "${newCharId}"`);
            console.log('æ–°è§’è‰²ä¿¡æ¯:', charInfo);

            currentCharacterId = newCharId;
            saveCurrentCharacterId(); // ä¿å­˜æ–°çš„è§’è‰²ID

            // é‡æ–°åŠ è½½å¥½å‹åˆ—è¡¨
            setTimeout(() => {
              loadFriends();
            }, 100);
          }
        } catch (error) {
          console.error('è§’è‰²åˆ‡æ¢æ£€æµ‹å¤±è´¥:', error);
        }
      }

      // å®šæœŸæ£€æŸ¥è§’è‰²æ˜¯å¦åˆ‡æ¢ï¼ˆæ¯1.5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
      setInterval(checkCharacterChange, 1500);

      // ç›‘å¬SillyTavernçš„å„ç§è§’è‰²åˆ‡æ¢äº‹ä»¶
      if (typeof parent !== 'undefined') {
        // æ–¹æ³•1: ç›‘å¬eventSourceäº‹ä»¶
        if (parent.eventSource && typeof parent.eventSource.on === 'function') {
          parent.eventSource.on('character_selected', () => {
            console.log('ğŸ“¡ æ”¶åˆ°character_selectedäº‹ä»¶');
            setTimeout(() => {
              checkCharacterChange();
              loadFriends();
            }, 200);
          });
        }

        // æ–¹æ³•2: ç›‘å¬DOMå˜åŒ–ï¼ˆè§’è‰²åç§°å˜åŒ–ï¼‰
        if (parent.document) {
          const observer = new MutationObserver(() => {
            checkCharacterChange();
          });

          // è§‚å¯Ÿå¯èƒ½åŒ…å«è§’è‰²ä¿¡æ¯çš„å…ƒç´ 
          const targetSelectors = ['#character_name', '.character-name', '#name1'];
          targetSelectors.forEach(selector => {
            const element = parent.document.querySelector(selector);
            if (element) {
              observer.observe(element, { childList: true, subtree: true, characterData: true });
            }
          });
        }

        // æ–¹æ³•3: ç›‘å¬this_chidå˜åŒ–
        let lastThisChid = parent.this_chid;
        setInterval(() => {
          if (parent.this_chid !== lastThisChid) {
            console.log('ğŸ“¡ æ£€æµ‹åˆ°this_chidå˜åŒ–:', lastThisChid, '->', parent.this_chid);
            lastThisChid = parent.this_chid;
            checkCharacterChange();
          }
        }, 500);
      }

      // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
      function showDebugInfo() {
        const charInfo = getCurrentCharacterInfo();
        const storageKey = getFriendsStorageKey();

        let friends = [];
        let storageSource = '';

        if (typeof parent !== 'undefined' && parent.extension_settings) {
          friends = parent.extension_settings[storageKey] || [];
          storageSource = 'SillyTavern extension_settings';
        } else {
          friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
          storageSource = 'localStorage';
        }

        const oldFriends = JSON.parse(localStorage.getItem('friendsList') || '[]');

        // è·å–SillyTavernçš„è¯¦ç»†ä¿¡æ¯
        let sillyTavernInfo = 'æœªè¿æ¥åˆ°SillyTavern';
        if (typeof parent !== 'undefined') {
          sillyTavernInfo = `
â€¢ this_chid: ${parent.this_chid}
â€¢ name1: ${parent.name1 || 'æœªè®¾ç½®'}
â€¢ charactersæ•°é‡: ${parent.characters ? Object.keys(parent.characters).length : 0}
â€¢ extension_settingså¯ç”¨: ${parent.extension_settings ? 'æ˜¯' : 'å¦'}`;
        }

        const debugInfo = `
=== å¥½å‹åˆ—è¡¨è°ƒè¯•ä¿¡æ¯ ===

å½“å‰è§’è‰²ä¿¡æ¯:
â€¢ ID: ${charInfo.id}
â€¢ åç§°: ${charInfo.name}
â€¢ æ¥æº: ${charInfo.source}

SillyTavernè¿æ¥çŠ¶æ€:
${sillyTavernInfo}

å­˜å‚¨ä¿¡æ¯:
â€¢ å­˜å‚¨é”®: ${storageKey}
â€¢ å­˜å‚¨ä½ç½®: ${storageSource}
â€¢ å½“å‰å¥½å‹æ•°é‡: ${friends.length}

è§’è‰²åˆ‡æ¢ç›‘æ§:
â€¢ å½“å‰ç›‘æ§çš„è§’è‰²ID: ${currentCharacterId}
â€¢ æœ€åæ£€æŸ¥æ—¶é—´: ${new Date(lastCheckTime).toLocaleTimeString()}

æ—§ç‰ˆæœ¬æ•°æ®:
â€¢ å…¨å±€å¥½å‹åˆ—è¡¨: ${oldFriends.length} ä¸ªå¥½å‹

å½“å‰è§’è‰²å¥½å‹åˆ—è¡¨:
${
  friends.length > 0
    ? friends.map((f, i) => `${i + 1}. ${f.name} (${f.type === 'group' ? 'ç¾¤èŠ' : 'å¥½å‹'})`).join('\n')
    : '(æ— å¥½å‹)'
}

${
  oldFriends.length > 0
    ? `\næ—§ç‰ˆæœ¬å¥½å‹åˆ—è¡¨:\n${oldFriends
        .map((f, i) => `${i + 1}. ${f.name} (${f.type === 'group' ? 'ç¾¤èŠ' : 'å¥½å‹'})`)
        .join('\n')}`
    : ''
}

å­˜å‚¨é”®åç¤ºä¾‹:
â€¢ å½“å‰è§’è‰²: ${storageKey}
â€¢ å…¶ä»–è§’è‰²: tavern_friends_sillytavern_chid_123
â€¢ é»˜è®¤è§’è‰²: tavern_friends_default_default
        `.trim();

        alert(debugInfo);
      }

      // ==================== å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½ ====================

      let selectedImportFile = null;
      let autoUpdateInterval = null;

      // æ˜¾ç¤ºå¯¼å…¥/å¯¼å‡ºæ¨¡æ€æ¡†
      function showImportExportModal() {
        document.getElementById('importExportOverlay').style.display = 'flex';

        // é‡ç½®çŠ¶æ€
        selectedImportFile = null;
        document.getElementById('selectedFileName').textContent = '';
        document.getElementById('importBtn').disabled = true;
        document.getElementById('jsonPreviewSection').style.display = 'none';

        // é‡ç½®å•é€‰æŒ‰é’®
        document.querySelector('input[name="importMode"][value="replace"]').checked = true;

        // åŠ è½½è‡ªåŠ¨æ›´æ–°è®¾ç½®
        loadAutoUpdateSetting();
      }

      // å…³é—­å¯¼å…¥/å¯¼å‡ºæ¨¡æ€æ¡†
      function closeImportExportModal() {
        document.getElementById('importExportOverlay').style.display = 'none';
      }

      // å¯¼å‡ºå¥½å‹åˆ—è¡¨
      function exportFriends() {
        try {
          const charInfo = getCurrentCharacterInfo();
          const storageKey = getFriendsStorageKey();

          // è·å–å½“å‰å¥½å‹åˆ—è¡¨
          let friends = [];
          if (typeof parent !== 'undefined' && parent.extension_settings) {
            friends = parent.extension_settings[storageKey] || [];
          } else {
            friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
          }

          // åˆ›å»ºå¯¼å‡ºæ•°æ®
          const exportData = {
            version: '1.0',
            exportTime: new Date().toISOString(),
            character: {
              id: charInfo.id,
              name: charInfo.name,
              source: charInfo.source,
            },
            friendsCount: friends.length,
            friends: friends,
          };

          // åˆ›å»ºJSONå­—ç¬¦ä¸²
          const jsonString = JSON.stringify(exportData, null, 2);

          // åˆ›å»ºä¸‹è½½é“¾æ¥
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);

          // ç”Ÿæˆæ–‡ä»¶å
          const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
          const fileName = `å¥½å‹åˆ—è¡¨_${charInfo.name}_${timestamp}.json`;

          // ä¸‹è½½æ–‡ä»¶
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          alert(`âœ… å¯¼å‡ºæˆåŠŸï¼\n\næ–‡ä»¶å: ${fileName}\nå¥½å‹æ•°é‡: ${friends.length}\nè§’è‰²: ${charInfo.name}`);

          console.log('å¯¼å‡ºå¥½å‹åˆ—è¡¨æˆåŠŸ:', {
            fileName,
            friendsCount: friends.length,
            character: charInfo.name,
          });
        } catch (error) {
          console.error('å¯¼å‡ºå¥½å‹åˆ—è¡¨å¤±è´¥:', error);
          alert('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message);
        }
      }

      // å¤„ç†æ–‡ä»¶é€‰æ‹©
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) {
          selectedImportFile = null;
          document.getElementById('selectedFileName').textContent = '';
          document.getElementById('importBtn').disabled = true;
          document.getElementById('jsonPreviewSection').style.display = 'none';
          return;
        }

        if (!file.name.toLowerCase().endsWith('.json')) {
          alert('è¯·é€‰æ‹©JSONæ ¼å¼çš„æ–‡ä»¶');
          event.target.value = '';
          return;
        }

        selectedImportFile = file;
        document.getElementById('selectedFileName').textContent = file.name;
        document.getElementById('importBtn').disabled = false;

        // è¯»å–å¹¶é¢„è§ˆæ–‡ä»¶å†…å®¹
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const jsonData = JSON.parse(e.target.result);
            document.getElementById('jsonPreview').value = JSON.stringify(jsonData, null, 2);
            document.getElementById('jsonPreviewSection').style.display = 'block';
          } catch (error) {
            console.error('JSONè§£æå¤±è´¥:', error);
            document.getElementById('jsonPreview').value = 'æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæ— æ³•é¢„è§ˆ';
            document.getElementById('jsonPreviewSection').style.display = 'block';
          }
        };
        reader.readAsText(file);
      }

      // å¯¼å…¥å¥½å‹åˆ—è¡¨
      function importFriends() {
        if (!selectedImportFile) {
          alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥çš„JSONæ–‡ä»¶');
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            // è§£æJSONæ•°æ®
            const importData = JSON.parse(e.target.result);

            // éªŒè¯æ•°æ®æ ¼å¼
            if (!validateImportData(importData)) {
              return;
            }

            const importFriends = importData.friends || [];
            if (importFriends.length === 0) {
              alert('âŒ å¯¼å…¥å¤±è´¥: æ–‡ä»¶ä¸­æ²¡æœ‰å¥½å‹æ•°æ®');
              return;
            }

            // è·å–å¯¼å…¥æ¨¡å¼
            const importMode = document.querySelector('input[name="importMode"]:checked').value;
            const charInfo = getCurrentCharacterInfo();

            // è·å–å½“å‰å¥½å‹åˆ—è¡¨
            const storageKey = getFriendsStorageKey();
            let currentFriends = [];
            if (typeof parent !== 'undefined' && parent.extension_settings) {
              currentFriends = parent.extension_settings[storageKey] || [];
            } else {
              currentFriends = JSON.parse(localStorage.getItem(storageKey) || '[]');
            }

            let finalFriends = [];
            let importedCount = 0;
            let skippedCount = 0;

            if (importMode === 'replace') {
              // æ›¿æ¢æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨å¯¼å…¥çš„å¥½å‹åˆ—è¡¨
              finalFriends = importFriends.map(friend => ({
                ...friend,
                addTime: friend.addTime || new Date().toISOString(),
              }));
              importedCount = finalFriends.length;
            } else if (importMode === 'merge') {
              // åˆå¹¶æ¨¡å¼ï¼šåˆå¹¶åˆ°ç°æœ‰åˆ—è¡¨ï¼Œè·³è¿‡é‡å¤
              finalFriends = [...currentFriends];

              for (const importFriend of importFriends) {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆæŒ‰åç§°å’Œç±»å‹ï¼‰
                const exists = finalFriends.some(
                  existing => existing.name === importFriend.name && existing.type === importFriend.type,
                );

                if (!exists) {
                  finalFriends.push({
                    ...importFriend,
                    addTime: importFriend.addTime || new Date().toISOString(),
                  });
                  importedCount++;
                } else {
                  skippedCount++;
                }
              }
            }

            // ä¿å­˜æ›´æ–°åçš„å¥½å‹åˆ—è¡¨
            saveFriends(finalFriends);

            // åˆ·æ–°æ˜¾ç¤º
            displayFriends(finalFriends);

            // å…³é—­æ¨¡æ€æ¡†
            closeImportExportModal();

            // æ˜¾ç¤ºå¯¼å…¥ç»“æœ
            let resultMessage = `âœ… å¯¼å…¥å®Œæˆï¼\n\n`;
            resultMessage += `è§’è‰²: ${charInfo.name}\n`;
            resultMessage += `å¯¼å…¥æ¨¡å¼: ${importMode === 'replace' ? 'æ›¿æ¢' : 'åˆå¹¶'}\n`;
            resultMessage += `æˆåŠŸå¯¼å…¥: ${importedCount} ä¸ªå¥½å‹\n`;
            if (skippedCount > 0) {
              resultMessage += `è·³è¿‡é‡å¤: ${skippedCount} ä¸ªå¥½å‹\n`;
            }
            resultMessage += `å½“å‰æ€»æ•°: ${finalFriends.length} ä¸ªå¥½å‹`;

            alert(resultMessage);

            console.log('å¯¼å…¥å¥½å‹åˆ—è¡¨æˆåŠŸ:', {
              importMode,
              importedCount,
              skippedCount,
              totalCount: finalFriends.length,
              character: charInfo.name,
            });
          } catch (error) {
            console.error('å¯¼å…¥å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
            alert('âŒ å¯¼å…¥å¤±è´¥: ' + error.message);
          }
        };

        reader.readAsText(selectedImportFile);
      }

      // éªŒè¯å¯¼å…¥æ•°æ®æ ¼å¼
      function validateImportData(data) {
        try {
          // æ£€æŸ¥åŸºæœ¬ç»“æ„
          if (!data || typeof data !== 'object') {
            alert('âŒ å¯¼å…¥å¤±è´¥: æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
            return false;
          }

          // æ£€æŸ¥æ˜¯å¦æœ‰friendsæ•°ç»„
          if (!Array.isArray(data.friends)) {
            alert('âŒ å¯¼å…¥å¤±è´¥: æ–‡ä»¶ä¸­ç¼ºå°‘å¥½å‹æ•°æ®');
            return false;
          }

          // éªŒè¯æ¯ä¸ªå¥½å‹çš„æ•°æ®æ ¼å¼
          for (let i = 0; i < data.friends.length; i++) {
            const friend = data.friends[i];

            if (!friend.name || typeof friend.name !== 'string') {
              alert(`âŒ å¯¼å…¥å¤±è´¥: ç¬¬${i + 1}ä¸ªå¥½å‹ç¼ºå°‘æœ‰æ•ˆçš„åç§°`);
              return false;
            }

            if (!friend.type || !['friend', 'group'].includes(friend.type)) {
              alert(`âŒ å¯¼å…¥å¤±è´¥: ç¬¬${i + 1}ä¸ªå¥½å‹çš„ç±»å‹æ— æ•ˆ`);
              return false;
            }
          }

          // æ˜¾ç¤ºå¯¼å…¥é¢„è§ˆä¿¡æ¯
          const friendCount = data.friends.filter(f => f.type === 'friend').length;
          const groupCount = data.friends.filter(f => f.type === 'group').length;

          const previewMessage =
            `ğŸ“‹ å¯¼å…¥é¢„è§ˆ\n\n` +
            `æ–‡ä»¶ç‰ˆæœ¬: ${data.version || 'æœªçŸ¥'}\n` +
            `å¯¼å‡ºæ—¶é—´: ${data.exportTime ? new Date(data.exportTime).toLocaleString('zh-CN') : 'æœªçŸ¥'}\n` +
            `åŸè§’è‰²: ${data.character?.name || 'æœªçŸ¥'}\n` +
            `å¥½å‹æ•°é‡: ${friendCount} ä¸ª\n` +
            `ç¾¤èŠæ•°é‡: ${groupCount} ä¸ª\n` +
            `æ€»è®¡: ${data.friends.length} ä¸ª\n\n` +
            `ç¡®å®šè¦å¯¼å…¥è¿™äº›æ•°æ®å—ï¼Ÿ`;

          return confirm(previewMessage);
        } catch (error) {
          console.error('éªŒè¯å¯¼å…¥æ•°æ®å¤±è´¥:', error);
          alert('âŒ å¯¼å…¥å¤±è´¥: æ•°æ®éªŒè¯å‡ºé”™');
          return false;
        }
      }

      // ==================== è¿œç¨‹ä¸–ç•Œä¹¦å¯¼å…¥åŠŸèƒ½ ====================

      // è¿œç¨‹ä¸–ç•Œä¹¦å¯¼å…¥
      async function importRemoteWorldbook() {
        const url = getDefaultRemoteWorldbookUrl();
        if (!url) {
          alert('æœªé…ç½®è¿œç¨‹ä¸–ç•Œä¹¦åœ°å€');
          return;
        }

        try {
          console.log('å¼€å§‹å¯¼å…¥è¿œç¨‹ä¸–ç•Œä¹¦:', url);

          // è·å–è¿œç¨‹JSONå†…å®¹
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const worldbookData = await response.json();
          console.log('è¿œç¨‹ä¸–ç•Œä¹¦æ•°æ®:', worldbookData);

          // éªŒè¯æ•°æ®æ ¼å¼
          if (!worldbookData.entries || typeof worldbookData.entries !== 'object') {
            throw new Error('æ— æ•ˆçš„ä¸–ç•Œä¹¦æ ¼å¼ï¼šç¼ºå°‘entrieså­—æ®µ');
          }

          await processWorldbookImport(worldbookData, url);
        } catch (error) {
          console.error('è¿œç¨‹ä¸–ç•Œä¹¦å¯¼å…¥å¤±è´¥:', error);
          alert(`âŒ å¯¼å…¥å¤±è´¥: ${error.message}`);
        }
      }

      // å¤„ç†ä¸–ç•Œä¹¦å¯¼å…¥
      async function processWorldbookImport(worldbookData, sourceUrl) {
        try {
          const TH = parent?.TavernHelper;
          const ST = parent?.SillyTavern?.getContext?.();

          if (!TH || !ST) {
            throw new Error('æœªæ£€æµ‹åˆ° TavernHelper æˆ– SillyTavern ä¸Šä¸‹æ–‡ï¼ˆéœ€è¦JS-Slash-Runneræ‰©å±•ï¼‰');
          }

          // ä¸´æ—¶ä¸–ç•Œä¹¦åç§°
          const tempWbName = `è¿œç¨‹ä¸–ç•Œä¹¦_${Date.now()}`;
          const worldbookJson = JSON.stringify(worldbookData);

          // 1. å¯¼å…¥ä¸ºä¸´æ—¶ä¸–ç•Œä¹¦
          if (typeof importRawWorldbook === 'function') {
            await importRawWorldbook(`${tempWbName}.json`, worldbookJson);
          } else {
            throw new Error('æœªæ£€æµ‹åˆ° importRawWorldbook å‡½æ•°ï¼ˆéœ€è¦JS-Slash-Runneræ‰©å±•ï¼‰');
          }

          // 2. è·å–å½“å‰è§’è‰²ä¸»ä¸–ç•Œä¹¦
          const charWb = TH.getCharWorldbookNames('current');
          let primaryName = charWb.primary;

          if (!primaryName) {
            // è‹¥è§’è‰²æ²¡æœ‰ç»‘å®šä¸»ä¸–ç•Œä¹¦ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªå¹¶ç»‘å®šåˆ°å½“å‰èŠå¤©/è§’è‰²
            const fallbackName = `èŠå¤©çŸ¥è¯†ä¹¦_${Date.now()}`;
            await TH.createWorldbook(fallbackName);
            // ç»‘å®šåˆ°å½“å‰èŠå¤©ä½œä¸ºä¸»ä¸–ç•Œä¹¦
            await TH.rebindChatWorldbook('current', fallbackName);
            primaryName = fallbackName;
            console.log('å·²åˆ›å»ºå¹¶ç»‘å®šä¸»ä¸–ç•Œä¹¦:', primaryName);
          }

          // 3. è¯»å–ä¸´æ—¶ä¸–ç•Œä¹¦æ¡ç›®å¹¶è¿½åŠ åˆ°ä¸»ä¸–ç•Œä¹¦
          const toAppend = await TH.getWorldbook(tempWbName);
          if (toAppend && toAppend.length > 0) {
            await TH.createWorldbookEntries(primaryName, toAppend, { render: 'debounced' });
            console.log(`å·²è¿½åŠ  ${toAppend.length} ä¸ªä¸–ç•Œä¹¦æ¡ç›®åˆ°ä¸»ä¸–ç•Œä¹¦: ${primaryName}`);
          }

          // 4. æ¸…ç†ä¸´æ—¶ä¸–ç•Œä¹¦
          await TH.deleteWorldbook(tempWbName);

          // 5. ä¿å­˜å¯¼å…¥è®°å½•
          saveRemoteWorldbookInfo(sourceUrl, worldbookData);

          const entryCount = toAppend ? toAppend.length : 0;
          const versionInfo = worldbookData.version ? ` (ç‰ˆæœ¬: ${worldbookData.version})` : '';

          alert(
            `âœ… è¿œç¨‹ä¸–ç•Œä¹¦å¯¼å…¥æˆåŠŸï¼\n\n` +
              `æ¥æº: ${worldbookData.name || 'æœªçŸ¥'}${versionInfo}\n` +
              `å¯¼å…¥æ¡ç›®: ${entryCount} ä¸ª\n` +
              `ç›®æ ‡ä¸–ç•Œä¹¦: ${primaryName}\n` +
              `URL: ${sourceUrl}`,
          );
        } catch (error) {
          console.error('ä¸–ç•Œä¹¦å¤„ç†å¤±è´¥:', error);
          throw error;
        }
      }

      // ä¿å­˜è¿œç¨‹ä¸–ç•Œä¹¦ä¿¡æ¯
      function saveRemoteWorldbookInfo(url, data) {
        const charInfo = getCurrentCharacterInfo();
        const key = getFriendsStorageKey() + '_remote_worldbook';

        const info = {
          url: url,
          lastUpdated: new Date().toISOString(),
          version: data.version || '1.0.0',
          name: data.name || 'è¿œç¨‹ä¸–ç•Œä¹¦',
          author: data.author || 'æœªçŸ¥',
          entryCount: Object.keys(data.entries || {}).length,
        };

        if (typeof parent !== 'undefined' && parent.extension_settings) {
          parent.extension_settings[key] = info;
          if (typeof parent.saveSettingsDebounced === 'function') {
            parent.saveSettingsDebounced();
          }
        }
        localStorage.setItem(key, JSON.stringify(info));
      }

      // é»˜è®¤è¿œç¨‹ä¸–ç•Œä¹¦URLï¼ˆéšè—ï¼‰
      function getDefaultRemoteWorldbookUrl() {
        const key = getFriendsStorageKey() + '_remote_worldbook';
        let info = null;
        if (typeof parent !== 'undefined' && parent.extension_settings) {
          info = parent.extension_settings[key] || null;
        } else {
          info = JSON.parse(localStorage.getItem(key) || 'null');
        }
        // ä¼˜å…ˆç”¨å·²ä¿å­˜çš„URLï¼Œå¦åˆ™ä½¿ç”¨å†…ç½®é»˜è®¤
        return info?.url || 'https://raw.githubusercontent.com/kencuo/lorebook/main/åŒå±‚æ‰‹æœºä¸–ç•Œä¹¦.json';
      }

      // è·å–è¿œç¨‹ä¸–ç•Œä¹¦ä¿¡æ¯
      function getRemoteWorldbookInfo() {
        const key = getFriendsStorageKey() + '_remote_worldbook';

        if (typeof parent !== 'undefined' && parent.extension_settings) {
          return parent.extension_settings[key] || null;
        }
        return JSON.parse(localStorage.getItem(key) || 'null');
      }

      // æ£€æŸ¥è¿œç¨‹ä¸–ç•Œä¹¦æ›´æ–°
      async function checkRemoteWorldbookUpdate() {
        const info = getRemoteWorldbookInfo();
        if (!info || !info.url) return;

        try {
          console.log('æ£€æŸ¥è¿œç¨‹ä¸–ç•Œä¹¦æ›´æ–°:', info.url);

          const response = await fetch(info.url);
          if (!response.ok) return;

          const remoteData = await response.json();
          const remoteVersion = remoteData.version || '1.0.0';
          const localVersion = info.version || '1.0.0';

          // ç®€å•ç‰ˆæœ¬æ¯”è¾ƒï¼ˆæ•°å­—ç‰ˆæœ¬å·ï¼‰
          if (compareVersions(remoteVersion, localVersion) > 0) {
            const shouldUpdate = confirm(
              `ğŸ”„ å‘ç°è¿œç¨‹ä¸–ç•Œä¹¦æ›´æ–°\n\n` +
                `è¿œç¨‹ç‰ˆæœ¬: ${remoteVersion}\n` +
                `æœ¬åœ°ç‰ˆæœ¬: ${localVersion}\n` +
                `æ›´æ–°æ—¶é—´: ${remoteData.lastUpdated || 'æœªçŸ¥'}\n\n` +
                `æ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ`,
            );

            if (shouldUpdate) {
              await processWorldbookImport(remoteData, info.url);
            }
          } else {
            console.log('è¿œç¨‹ä¸–ç•Œä¹¦å·²æ˜¯æœ€æ–°ç‰ˆæœ¬');
          }
        } catch (error) {
          console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error);
        }
      }

      // ç‰ˆæœ¬æ¯”è¾ƒå‡½æ•°
      function compareVersions(version1, version2) {
        const v1parts = version1.split('.').map(Number);
        const v2parts = version2.split('.').map(Number);

        for (let i = 0; i < Math.max(v1parts.length, v2parts.length); i++) {
          const v1 = v1parts[i] || 0;
          const v2 = v2parts[i] || 0;

          if (v1 > v2) return 1;
          if (v1 < v2) return -1;
        }
        return 0;
      }

      // å¯åŠ¨/åœæ­¢è‡ªåŠ¨æ›´æ–°
      function toggleAutoUpdate() {
        const isEnabled = document.getElementById('autoUpdateWorldbook').checked;

        if (isEnabled) {
          // å¯åŠ¨è‡ªåŠ¨æ›´æ–°ï¼ˆæ¯24å°æ—¶ï¼‰
          autoUpdateInterval = setInterval(checkRemoteWorldbookUpdate, 24 * 60 * 60 * 1000);
          console.log('å·²å¯åŠ¨è¿œç¨‹ä¸–ç•Œä¹¦è‡ªåŠ¨æ›´æ–°æ£€æŸ¥');

          // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
          setTimeout(checkRemoteWorldbookUpdate, 5000);
        } else {
          // åœæ­¢è‡ªåŠ¨æ›´æ–°
          if (autoUpdateInterval) {
            clearInterval(autoUpdateInterval);
            autoUpdateInterval = null;
            console.log('å·²åœæ­¢è¿œç¨‹ä¸–ç•Œä¹¦è‡ªåŠ¨æ›´æ–°æ£€æŸ¥');
          }
        }

        // ä¿å­˜è®¾ç½®
        const key = getFriendsStorageKey() + '_auto_update';
        const setting = { enabled: isEnabled };

        if (typeof parent !== 'undefined' && parent.extension_settings) {
          parent.extension_settings[key] = setting;
          if (typeof parent.saveSettingsDebounced === 'function') {
            parent.saveSettingsDebounced();
          }
        }
        localStorage.setItem(key, JSON.stringify(setting));
      }

      // åŠ è½½è‡ªåŠ¨æ›´æ–°è®¾ç½®
      function loadAutoUpdateSetting() {
        const key = getFriendsStorageKey() + '_auto_update';
        let setting = null;

        if (typeof parent !== 'undefined' && parent.extension_settings) {
          setting = parent.extension_settings[key];
        } else {
          setting = JSON.parse(localStorage.getItem(key) || 'null');
        }

        if (setting && setting.enabled) {
          document.getElementById('autoUpdateWorldbook').checked = true;
          toggleAutoUpdate();
        }
      }

      // ==================== ç•Œé¢åˆ‡æ¢åŠŸèƒ½ ====================

      // æ‰“å¼€å¥½å‹åˆ—è¡¨åº”ç”¨
      function openFriendsApp() {
        document.getElementById('mainScreen').style.display = 'none';
        document.getElementById('friendsScreen').style.display = 'block';
      }

      // è¿”å›ä¸»ç•Œé¢
      function backToMain() {
        // éšè—æ‰€æœ‰å­ç•Œé¢
        document.getElementById('friendsScreen').style.display = 'none';
        document.getElementById('bilibiliScreen').style.display = 'none';
        // æ˜¾ç¤ºä¸»ç•Œé¢
        document.getElementById('mainScreen').style.display = 'block';
      }

      // æ‰“å¼€Bç«™
      function openBilibili() {
        document.getElementById('mainScreen').style.display = 'none';
        document.getElementById('bilibiliScreen').style.display = 'block';

        // ä¼˜åŒ–bilibiliåŠ è½½
        const iframe = document.getElementById('bilibiliFrame');
        if (iframe) {
          // æ£€æµ‹ç”¨æˆ·è®¾å¤‡ç±»å‹ï¼Œç§»åŠ¨è®¾å¤‡ä½¿ç”¨ç§»åŠ¨ç‰ˆ
          const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
          const preferredUrl = isMobile ? 'https://m.bilibili.com' : 'https://www.bilibili.com';

          // å¦‚æœå½“å‰URLä¸æ˜¯é¦–é€‰URLï¼Œåˆ™åˆ‡æ¢
          if (!iframe.src.includes(preferredUrl.replace('https://', ''))) {
            iframe.src = preferredUrl;
            console.log('ğŸ¬ åŠ è½½bilibili:', preferredUrl);
          }
        }
      }

      // æ‰“å¼€åº”ç”¨å•†åº—
      function openStore() {
        alert('åº”ç”¨å•†åº—åŠŸèƒ½å¼€å‘ä¸­...\n\nè¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šåº”ç”¨ï¼');
      }

      // æ‰“å¼€å¾®åš
      function openwb() {
        if (typeof triggerSlash === 'function') {
          const message = `<wb>
</wb>`;
          triggerSlash(message);
        } else {
          // å¦‚æœtriggerSlashä¸å¯ç”¨ï¼Œæ˜¾ç¤ºæ¶ˆæ¯å†…å®¹
          console.log(`<wb>
</wb>`);
          alert(`å¾®åšæ¶ˆæ¯ï¼š<wb>
</wb>`);
        }
      }

      // æ‰“å¼€è®¾ç½®
      function openSettings() {
        alert('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...\n\nè¿™é‡Œå¯ä»¥é…ç½®å„ç§é€‰é¡¹ï¼');
      }

      // CookieåŒæ­¥å’Œä»£ç†æ–¹æ¡ˆ
      let proxyServerRunning = false;
      let cookieSyncInterval = null;

      // å¯åŠ¨æœ¬åœ°ä»£ç†æœåŠ¡å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
      async function startProxyServer() {
        try {
          // æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°ä»£ç†æœåŠ¡å™¨
          const response = await fetch('http://localhost:8888/proxy/status', {
            method: 'GET',
            mode: 'cors',
          });

          if (response.ok) {
            proxyServerRunning = true;
            console.log('ğŸš€ æœ¬åœ°ä»£ç†æœåŠ¡å™¨å·²å¯åŠ¨');
            return true;
          }
        } catch (error) {
          console.log('âš ï¸ æœ¬åœ°ä»£ç†æœåŠ¡å™¨æœªè¿è¡Œï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
        }
        return false;
      }

      // CookieåŒæ­¥æœºåˆ¶
      function syncCookiesFromMainWindow() {
        try {
          // å°è¯•ä»ä¸»çª—å£è·å–bilibili cookies
          if (window.parent && window.parent !== window) {
            const parentCookies = window.parent.document.cookie;
            const bilibiliCookies = parentCookies
              .split(';')
              .filter(cookie => cookie.includes('bilibili') || cookie.includes('SESSDATA'))
              .join(';');

            if (bilibiliCookies) {
              console.log('ğŸª åŒæ­¥åˆ°bilibili cookies');
              // è®¾ç½®åˆ°å½“å‰åŸŸ
              document.cookie = bilibiliCookies + '; SameSite=None; Secure';
            }
          }
        } catch (error) {
          console.log('CookieåŒæ­¥å¤±è´¥:', error);
        }
      }

      // å¤–éƒ¨ç™»å½•bilibili
      function openBilibiliLogin() {
        const loginOptions = [
          {
            name: 'ğŸ”§ å¯ç”¨ä»£ç†æ¨¡å¼',
            action: async () => {
              const proxyAvailable = await startProxyServer();
              if (proxyAvailable) {
                const iframe = document.getElementById('bilibiliFrame');
                if (iframe) {
                  iframe.src = 'http://localhost:8888/proxy/bilibili';
                  alert('âœ… ä»£ç†æ¨¡å¼å·²å¯ç”¨ï¼ç°åœ¨åº”è¯¥å¯ä»¥æ­£å¸¸ç™»å½•å’Œè§‚çœ‹è§†é¢‘äº†ã€‚');
                }
              } else {
                alert('âŒ ä»£ç†æœåŠ¡å™¨æœªè¿è¡Œã€‚è¯·å…ˆå¯åŠ¨æœ¬åœ°ä»£ç†æœåŠ¡å™¨ã€‚');
                showProxySetupInstructions();
              }
            },
          },
          {
            name: 'ğŸª CookieåŒæ­¥ç™»å½•',
            action: () => {
              window.open('https://passport.bilibili.com/login', '_blank');
              setTimeout(() => {
                if (confirm('ç™»å½•å®Œæˆåï¼Œç‚¹å‡»"ç¡®å®š"åŒæ­¥Cookie')) {
                  syncCookiesFromMainWindow();
                  refreshBilibili();
                  // å¯åŠ¨å®šæœŸåŒæ­¥
                  if (cookieSyncInterval) clearInterval(cookieSyncInterval);
                  cookieSyncInterval = setInterval(syncCookiesFromMainWindow, 30000);
                }
              }, 3000);
            },
          },
          {
            name: 'ğŸŒ åœ¨æ–°æ ‡ç­¾é¡µç™»å½•',
            action: () => {
              window.open('https://passport.bilibili.com/login', '_blank');
              setTimeout(() => {
                if (confirm('ç™»å½•å®Œæˆåï¼Œç‚¹å‡»"ç¡®å®š"åˆ·æ–°bilibilié¡µé¢')) {
                  refreshBilibili();
                }
              }, 3000);
            },
          },
          {
            name: 'ğŸ“± ç§»åŠ¨ç«¯ç™»å½•',
            action: () => {
              window.open('https://m.bilibili.com', '_blank');
              setTimeout(() => {
                if (confirm('ç™»å½•å®Œæˆåï¼Œç‚¹å‡»"ç¡®å®š"åˆ‡æ¢åˆ°ç§»åŠ¨ç‰ˆ')) {
                  const iframe = document.getElementById('bilibiliFrame');
                  if (iframe) {
                    iframe.src = 'https://m.bilibili.com';
                  }
                }
              }, 3000);
            },
          },
          {
            name: 'ğŸ”„ ç›´æ¥åˆ·æ–°',
            action: () => refreshBilibili(),
          },
        ];

        const choice = prompt(
          'ğŸ”‘ Bilibiliç™»å½•é€‰é¡¹ï¼š\n\n' +
            '1 - å¯ç”¨ä»£ç†æ¨¡å¼ï¼ˆæ¨èï¼Œéœ€è¦æœ¬åœ°ä»£ç†ï¼‰\n' +
            '2 - CookieåŒæ­¥ç™»å½•ï¼ˆå®éªŒæ€§ï¼‰\n' +
            '3 - åœ¨æ–°æ ‡ç­¾é¡µç™»å½•\n' +
            '4 - ç§»åŠ¨ç«¯ç™»å½•\n' +
            '5 - ç›´æ¥åˆ·æ–°\n\n' +
            'è¯·è¾“å…¥é€‰é¡¹æ•°å­— (1-5):',
        );

        const optionIndex = parseInt(choice) - 1;
        if (optionIndex >= 0 && optionIndex < loginOptions.length) {
          loginOptions[optionIndex].action();
        }
      }

      // æ˜¾ç¤ºä»£ç†æœåŠ¡å™¨è®¾ç½®è¯´æ˜
      function showProxySetupInstructions() {
        const instructions = `
ğŸ”§ æœ¬åœ°ä»£ç†æœåŠ¡å™¨è®¾ç½®è¯´æ˜

ä¸ºäº†å®Œç¾è§£å†³SameSite Cookieé—®é¢˜ï¼Œæ‚¨éœ€è¦å¯åŠ¨ä¸€ä¸ªæœ¬åœ°ä»£ç†æœåŠ¡å™¨ï¼š

æ–¹æ³•1: ä½¿ç”¨Node.js (æ¨è)
1. å®‰è£…Node.js
2. åˆ›å»ºproxy-server.jsæ–‡ä»¶
3. è¿è¡Œ: node proxy-server.js

æ–¹æ³•2: ä½¿ç”¨Python
1. å®‰è£…Python
2. è¿è¡Œ: python -m http.server 8888

æ–¹æ³•3: ä½¿ç”¨æµè§ˆå™¨æ‰©å±•
- å®‰è£…CORSè§£é™¤æ‰©å±•
- å¯ç”¨"Access-Control-Allow-Origin: *"

ä»£ç†æœåŠ¡å™¨ä»£ç ç¤ºä¾‹å·²å¤åˆ¶åˆ°æ§åˆ¶å°ï¼Œè¯·æŸ¥çœ‹ï¼
        `;

        alert(instructions);

        // è¾“å‡ºä»£ç†æœåŠ¡å™¨ä»£ç åˆ°æ§åˆ¶å°
        console.log(`
// proxy-server.js - Node.jsä»£ç†æœåŠ¡å™¨
const express = require('express');
const { createProxyMiddleware } = require('http-proxy-middleware');
const cors = require('cors');

const app = express();
app.use(cors());

// Bilibiliä»£ç†
app.use('/proxy/bilibili', createProxyMiddleware({
  target: 'https://www.bilibili.com',
  changeOrigin: true,
  pathRewrite: {
    '^/proxy/bilibili': ''
  },
  onProxyReq: (proxyReq, req, res) => {
    // ä¿®æ”¹è¯·æ±‚å¤´ä»¥ç»•è¿‡é™åˆ¶
    proxyReq.setHeader('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36');
    proxyReq.setHeader('Referer', 'https://www.bilibili.com');
  },
  onProxyRes: (proxyRes, req, res) => {
    // ä¿®æ”¹å“åº”å¤´
    proxyRes.headers['X-Frame-Options'] = 'ALLOWALL';
    proxyRes.headers['Content-Security-Policy'] = '';
    delete proxyRes.headers['x-frame-options'];
  }
}));

app.get('/proxy/status', (req, res) => {
  res.json({ status: 'running', message: 'Proxy server is active' });
});

app.listen(8888, () => {
  console.log('ğŸš€ ä»£ç†æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:8888');
});
        `);
      }

      // é«˜çº§Cookieç®¡ç†
      function advancedCookieManagement() {
        try {
          // è®¾ç½®SameSite=Noneçš„cookies
          const cookiesToSet = ['SESSDATA', 'bili_jct', 'DedeUserID', 'DedeUserID__ckMd5', 'sid'];

          cookiesToSet.forEach(cookieName => {
            const cookieValue = getCookieValue(cookieName);
            if (cookieValue) {
              document.cookie = `${cookieName}=${cookieValue}; SameSite=None; Secure; Domain=.bilibili.com; Path=/`;
            }
          });

          console.log('ğŸª é«˜çº§Cookieç®¡ç†å®Œæˆ');
        } catch (error) {
          console.error('Cookieç®¡ç†å¤±è´¥:', error);
        }
      }

      // è·å–Cookieå€¼
      function getCookieValue(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
      }

      // åˆ·æ–°Bç«™
      function refreshBilibili() {
        const iframe = document.getElementById('bilibiliFrame');
        if (iframe) {
          // å°è¯•ä¸åŒçš„bilibilié“¾æ¥ä»¥æé«˜å…¼å®¹æ€§
          const bilibiliUrls = [
            proxyServerRunning ? 'http://localhost:8888/proxy/bilibili' : 'https://www.bilibili.com',
            'https://m.bilibili.com', // ç§»åŠ¨ç«¯ç‰ˆæœ¬ï¼Œé€šå¸¸é™åˆ¶è¾ƒå°‘
            'https://www.bilibili.com/video/', // è§†é¢‘é¡µé¢
            'https://space.bilibili.com', // ä¸ªäººç©ºé—´
          ];

          // è·å–å½“å‰URLå¹¶åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª
          const currentSrc = iframe.src;
          let nextUrlIndex = 0;

          for (let i = 0; i < bilibiliUrls.length; i++) {
            if (
              currentSrc.includes(bilibiliUrls[i].replace('https://', '').replace('http://localhost:8888/proxy/', ''))
            ) {
              nextUrlIndex = (i + 1) % bilibiliUrls.length;
              break;
            }
          }

          iframe.src = bilibiliUrls[nextUrlIndex];
          console.log('ğŸ”„ åˆ‡æ¢åˆ°bilibilié“¾æ¥:', bilibiliUrls[nextUrlIndex]);

          // åº”ç”¨é«˜çº§Cookieç®¡ç†
          setTimeout(advancedCookieManagement, 2000);
        }
      }

      // å…¨å±åˆ‡æ¢åŠŸèƒ½
      let isFullscreen = false;

      function toggleFullscreen() {
        const body = document.body;
        const fullscreenBtn = document.getElementById('fullscreenBtn');

        if (!isFullscreen) {
          // è¿›å…¥å…¨å±æ¨¡å¼
          body.classList.add('fullscreen-mode');
          fullscreenBtn.innerHTML = 'â›¶'; // é€€å‡ºå…¨å±å›¾æ ‡
          fullscreenBtn.title = 'é€€å‡ºå…¨å±';
          isFullscreen = true;

          // å°è¯•ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿå…¨å±API
          if (body.requestFullscreen) {
            body.requestFullscreen().catch(err => {
              console.log('æ— æ³•è¿›å…¥æµè§ˆå™¨å…¨å±æ¨¡å¼:', err);
            });
          } else if (body.webkitRequestFullscreen) {
            body.webkitRequestFullscreen();
          } else if (body.msRequestFullscreen) {
            body.msRequestFullscreen();
          }
        } else {
          // é€€å‡ºå…¨å±æ¨¡å¼
          body.classList.remove('fullscreen-mode');
          fullscreenBtn.innerHTML = 'â›¶'; // å…¨å±å›¾æ ‡
          fullscreenBtn.title = 'å…¨å±';
          isFullscreen = false;

          // é€€å‡ºæµè§ˆå™¨åŸç”Ÿå…¨å±
          if (document.exitFullscreen) {
            document.exitFullscreen().catch(err => {
              console.log('æ— æ³•é€€å‡ºæµè§ˆå™¨å…¨å±æ¨¡å¼:', err);
            });
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        }
      }

      // ç›‘å¬æµè§ˆå™¨å…¨å±çŠ¶æ€å˜åŒ–
      document.addEventListener('fullscreenchange', handleFullscreenChange);
      document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
      document.addEventListener('msfullscreenchange', handleFullscreenChange);

      function handleFullscreenChange() {
        const isInFullscreen = !!(
          document.fullscreenElement ||
          document.webkitFullscreenElement ||
          document.msFullscreenElement
        );

        if (!isInFullscreen && isFullscreen) {
          // æµè§ˆå™¨é€€å‡ºäº†å…¨å±ï¼ŒåŒæ­¥æˆ‘ä»¬çš„çŠ¶æ€
          const body = document.body;
          const fullscreenBtn = document.getElementById('fullscreenBtn');

          body.classList.remove('fullscreen-mode');
          fullscreenBtn.innerHTML = 'â›¶';
          fullscreenBtn.title = 'å…¨å±';
          isFullscreen = false;
        }
      }

      // ESCé”®é€€å‡ºå…¨å±
      document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' && isFullscreen) {
          toggleFullscreen();
        }
      });

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.addEventListener('load', () => {
        console.log('ğŸš€ å¥½å‹åˆ—è¡¨é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

        // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿SillyTavernå®Œå…¨åŠ è½½
        setTimeout(() => {
          const charInfo = getCurrentCharacterInfo();
          console.log('ğŸ“‹ åˆå§‹åŒ–è§’è‰²ä¿¡æ¯:', charInfo);

          currentCharacterId = charInfo.id;
          saveCurrentCharacterId();

          // åŠ è½½å¥½å‹åˆ—è¡¨
          loadFriends();

          // å¼€å§‹è§’è‰²åˆ‡æ¢ç›‘æ§
          console.log('ğŸ” å¼€å§‹è§’è‰²åˆ‡æ¢ç›‘æ§...');

          // ç»‘å®šè‡ªåŠ¨æ›´æ–°å¤é€‰æ¡†äº‹ä»¶
          document.getElementById('autoUpdateWorldbook')?.addEventListener('change', toggleAutoUpdate);
        }, 500);
      });

      // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶é‡æ–°æ£€æŸ¥è§’è‰²
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          console.log('ğŸ“± é¡µé¢é‡æ–°å¯è§ï¼Œæ£€æŸ¥è§’è‰²æ˜¯å¦åˆ‡æ¢...');
          setTimeout(checkCharacterChange, 100);
        }
      });
    </script>
  </body>
</html>
