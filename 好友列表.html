<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¥½å‹åˆ—è¡¨</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Ma+Shan+Zheng&display=swap');

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #f5f3e8;
        min-height: 100vh;
        font-family: 'Noto Sans JP', 'Microsoft YaHei', sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      /* å¤–æ¡†åŒ…è£¹å±‚ */
      .phone-shell {
        padding: 8px;
        background: #e8d5a3; /* ç±³é»„è‰²å¤–å£³ */
        border-radius: 40px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        display: inline-block;
      }

      .container {
        width: 255px; /* è°ƒæ•´ä¸º255pxå®½åº¦ */
        height: 650px; /* æ‰‹æœºé«˜åº¦ */
        background: #ffffff; /* æœºèº«æœ¬ä½“çº¯ç™½ */
        border-radius: 38px;
        box-shadow: inset 0 0 0 2px #d4c294; /* å†…æè¾¹ï¼Œå‘¼åº”å¤–å£³ */
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: fadeInUp 0.8s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .status-bar {
        height: 30px;
        background: #f7f5e8;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        font-size: 13px;
        color: #8b7355;
        box-shadow: 0 1px 0 #e7e5d8;
      }

      .header {
        background: linear-gradient(135deg, #d4c294 0%, #c9b882 100%);
        color: #8b7355;
        padding: 25px;
        position: relative;
        text-align: center;
        border-bottom: 1px solid rgba(139, 115, 85, 0.2);
      }

      .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .header h1 {
        font-family: 'Ma Shan Zheng', cursive;
        font-size: clamp(24px, 4vw, 28px);
        font-weight: 700;
        letter-spacing: 2px;
        text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 20px rgba(212, 194, 148, 0.5);
        animation: glow 2s ease-in-out infinite alternate;
        position: relative;
        z-index: 1;
      }

      @keyframes glow {
        from {
          text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 20px rgba(212, 194, 148, 0.5);
        }
        to {
          text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 30px rgba(212, 194, 148, 0.7);
        }
      }

      .add-btn {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(212, 194, 148, 0.3);
        border: 1px solid rgba(212, 194, 148, 0.5);
        color: #8b7355;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        z-index: 2;
      }

      .add-btn:hover {
        background: rgba(212, 194, 148, 0.5);
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 15px rgba(212, 194, 148, 0.4);
      }

      .friends-list {
        padding: 5px;
        background: #faf9f4;
        flex: 1;
        overflow-y: auto;
        max-height: calc(650px - 30px - 95px); /* å‡å»çŠ¶æ€æ å’Œheaderé«˜åº¦ */
      }

      .friends-list::-webkit-scrollbar {
        width: 6px;
      }

      .friends-list::-webkit-scrollbar-track {
        background: rgba(212, 194, 148, 0.1);
        border-radius: 3px;
      }

      .friends-list::-webkit-scrollbar-thumb {
        background: rgba(212, 194, 148, 0.4);
        border-radius: 3px;
      }

      .friends-list::-webkit-scrollbar-thumb:hover {
        background: rgba(212, 194, 148, 0.6);
      }

      .friend-item {
        display: flex;
        align-items: center;
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #ffffff;
        border: 1px solid rgba(212, 194, 148, 0.2);
        box-shadow: 0 2px 8px rgba(212, 194, 148, 0.1);
        position: relative;
        overflow: hidden;
      }

      .friend-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(212, 194, 148, 0.1), transparent);
        transition: left 0.5s;
      }

      .friend-item:hover::before {
        left: 100%;
      }

      .friend-item:hover {
        background: #f9f7f0;
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 8px 25px rgba(212, 194, 148, 0.2);
        border-color: rgba(212, 194, 148, 0.4);
      }

      .friend-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #d4c294 0%, #c9b882 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #8b7355;
        font-weight: bold;
        margin-right: 12px;
        font-size: 16px;
        text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.2);
        box-shadow: 0 4px 15px rgba(212, 194, 148, 0.3);
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
        flex-shrink: 0;
      }

      .friend-item:hover .friend-avatar {
        transform: scale(1.1) rotate(5deg);
        box-shadow: 0 6px 20px rgba(212, 194, 148, 0.4);
      }

      .friend-info {
        flex: 1;
        position: relative;
        z-index: 1;
        overflow: hidden;
      }

      .friend-name {
        font-size: 15px;
        font-weight: 500;
        color: #8b7355;
        margin-bottom: 4px;
        text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.1);
        letter-spacing: 0.5px;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }

      .friend-type {
        font-size: 12px;
        color: rgba(139, 115, 85, 0.7);
        font-weight: 300;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }

      .group-badge {
        background: rgba(212, 194, 148, 0.8);
        color: #8b7355;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        margin-left: 10px;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(212, 194, 148, 0.5);
        font-weight: 400;
        text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.1);
      }

      .pinned-badge {
        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        color: white;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 10px;
        margin-left: 8px;
        font-weight: 500;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
      }

      .friend-item.pinned {
        background: linear-gradient(135deg, #fff9e6, #fff5d6);
        border-color: rgba(255, 193, 7, 0.3);
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
      }

      .friend-item.pinned:hover {
        background: linear-gradient(135deg, #fff7e0, #fff2cc);
        border-color: rgba(255, 193, 7, 0.5);
      }

      .friend-actions {
        display: flex;
        gap: 8px;
        margin-left: auto;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .friend-item:hover .friend-actions {
        opacity: 1;
      }

      .action-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
        backdrop-filter: blur(5px);
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      .action-btn:hover {
        transform: scale(1.1);
      }

      .action-btn:active {
        transform: scale(0.95);
      }

      .pin-btn {
        background: rgba(255, 193, 7, 0.8);
        color: white;
      }
      .pin-btn:hover {
        background: rgba(255, 193, 7, 1);
      }
      .pin-btn.pinned {
        background: rgba(255, 107, 107, 0.8);
      }
      .pin-btn.pinned:hover {
        background: rgba(255, 107, 107, 1);
      }

      .delete-btn {
        background: rgba(255, 107, 107, 0.8);
        color: white;
      }
      .delete-btn:hover {
        background: rgba(255, 107, 107, 1);
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      }

      .modal-content {
        background: white;
        padding: 25px;
        border-radius: 15px;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.4s ease-out;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          transform: translateY(-30px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 15px;
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 18px;
        color: #333;
      }

      .close-btn {
        border: none;
        background: transparent;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        padding: 0;
        line-height: 1;
        transition: color 0.2s;
      }
      .close-btn:hover {
        color: #333;
      }
      .modal-body {
        overflow-y: auto;
        padding-right: 10px;
        margin-right: -10px;
      }

      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: 500;
      }
      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }
      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }
      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
      }
      .btn-primary {
        background: #667eea;
        color: white;
      }
      .btn-primary:hover {
        background: #5a6fd8;
      }
      .btn-secondary {
        background: #e9ecef;
        color: #6c757d;
      }
      .btn-secondary:hover {
        background: #dee2e6;
      }

      .import-export-section {
        margin-bottom: 15px;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
      }
      .import-export-section h3 {
        margin: 0 0 10px 0;
        color: #8b7355;
        font-size: 16px;
      }
      .import-export-section p {
        margin: 0 0 15px 0;
        color: #666;
        font-size: 14px;
      }
      .divider {
        height: 1px;
        background: linear-gradient(to right, transparent, #d4c294, transparent);
        margin: 20px 0;
      }

      .submit-btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        background: #667eea;
        color: white;
      }
      .submit-btn:hover {
        background: #5a6fd8;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
      }
      .submit-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .submit-btn:disabled:hover {
        background: #ccc;
        transform: none;
        box-shadow: none;
      }

      #selectedFileName {
        min-height: 16px;
        font-style: italic;
      }
      #selectedFileName:empty::before {
        content: 'æœªé€‰æ‹©æ–‡ä»¶';
        color: #999;
      }

      #jsonPreview {
        resize: vertical;
        min-height: 100px;
        max-height: 300px;
      }

      input[type='radio'] {
        accent-color: #d4c294;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }
      .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="phone-shell">
      <div class="container">
        <div class="status-bar">
          <div>9:41</div>
          <div>ğŸ“¶ ğŸ”‹</div>
        </div>
        <div class="header">
          <h1>å¥½å‹åˆ—è¡¨</h1>
          <button class="add-btn" onclick="openAddModal()">+</button>
          <button class="add-btn" onclick="showDebugInfo()" style="right: 65px; font-size: 14px" title="è°ƒè¯•ä¿¡æ¯">
            â„¹ï¸
          </button>
          <button
            class="add-btn"
            onclick="showImportExportModal()"
            style="right: 105px; font-size: 12px"
            title="å¯¼å…¥/å¯¼å‡ºå¥½å‹"
          >
            ğŸ“
          </button>
        </div>

        <div class="friends-list" id="friendsList">
          <div class="empty-state">
            <i>ğŸ‘¥</i>
            <p>æ­£åœ¨è¿æ¥SillyTavern...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="addModal">
      <div class="modal-content">
        <div id="typeSelection">
          <div class="modal-header">
            <h2>æ·»åŠ å¥½å‹/ç¾¤èŠ</h2>
            <button class="close-btn" onclick="closeAddModal()">Ã—</button>
          </div>
          <p style="text-align: center; color: #666; margin-bottom: 20px">è¯·é€‰æ‹©è¦æ·»åŠ çš„ç±»å‹</p>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="selectType('friend')">ğŸ‘¤ æ·»åŠ å¥½å‹</button>
            <button class="btn btn-primary" onclick="selectType('group')">ğŸ‘¥ æ·»åŠ ç¾¤èŠ</button>
          </div>
        </div>

        <div id="friendForm" style="display: none">
          <div class="modal-header">
            <h2>æ·»åŠ å¥½å‹</h2>
            <button class="close-btn" onclick="closeAddModal()">Ã—</button>
          </div>
          <div class="form-group">
            <label for="friendName">å¥½å‹å§“å</label>
            <input type="text" id="friendName" placeholder="è¯·è¾“å…¥å¥½å‹å§“å" />
          </div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="backToTypeSelection()">è¿”å›</button>
            <button class="btn btn-primary" onclick="addFriend()">æ·»åŠ å¥½å‹</button>
          </div>
        </div>

        <div id="groupForm" style="display: none">
          <div class="modal-header">
            <h2>æ·»åŠ ç¾¤èŠ</h2>
            <button class="close-btn" onclick="closeAddModal()">Ã—</button>
          </div>
          <div class="form-group">
            <label for="groupName">ç¾¤èŠåç§°</label>
            <input type="text" id="groupName" placeholder="è¯·è¾“å…¥ç¾¤èŠåç§°" />
          </div>
          <div class="form-group">
            <label for="groupMembers">ç¾¤æˆå‘˜</label>
            <textarea id="groupMembers" placeholder="è¯·è¾“å…¥ç¾¤æˆå‘˜ï¼Œç”¨é€—å·éš”å¼€&#10;ä¾‹å¦‚ï¼šå¼ ä¸‰,æå››,ç‹äº”"></textarea>
          </div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="backToTypeSelection()">è¿”å›</button>
            <button class="btn btn-primary" onclick="addGroup()">æ·»åŠ ç¾¤èŠ</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="importExportModal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ğŸ“ å¯¼å…¥/å¯¼å‡ºå¥½å‹åˆ—è¡¨</h2>
          <button class="close-btn" onclick="closeImportExportModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="import-export-section">
            <h3>ğŸ“¤ å¯¼å‡ºå¥½å‹åˆ—è¡¨</h3>
            <p>å°†å½“å‰è§’è‰²çš„å¥½å‹åˆ—è¡¨å¯¼å‡ºä¸ºJSONæ–‡ä»¶</p>
            <button class="submit-btn" onclick="exportFriends()">ğŸ“¥ å¯¼å‡ºä¸ºJSONæ–‡ä»¶</button>
          </div>

          <div class="divider"></div>

          <div class="import-export-section">
            <h3>ğŸ“¥ å¯¼å…¥å¥½å‹åˆ—è¡¨</h3>
            <p>ä»JSONæ–‡ä»¶å¯¼å…¥å¥½å‹åˆ—è¡¨åˆ°å½“å‰è§’è‰²</p>

            <div>
              <input
                type="file"
                id="importFileInput"
                accept=".json"
                style="display: none"
                onchange="handleFileSelect(event)"
              />
              <button
                class="submit-btn"
                onclick="document.getElementById('importFileInput').click()"
                style="margin-bottom: 10px"
              >
                ğŸ“ é€‰æ‹©JSONæ–‡ä»¶
              </button>
              <div id="selectedFileName" style="font-size: 12px; color: #666; text-align: center"></div>
            </div>

            <div style="margin-top: 15px">
              <label style="display: flex; align-items: center; margin-bottom: 10px; font-size: 14px">
                <input type="radio" name="importMode" value="replace" checked style="margin-right: 8px" />
                <span>æ›¿æ¢ç°æœ‰å¥½å‹åˆ—è¡¨</span>
              </label>
              <label style="display: flex; align-items: center; font-size: 14px">
                <input type="radio" name="importMode" value="merge" style="margin-right: 8px" />
                <span>åˆå¹¶åˆ°ç°æœ‰å¥½å‹åˆ—è¡¨ (è·³è¿‡é‡å¤)</span>
              </label>
            </div>

            <div style="margin-top: 15px">
              <button class="submit-btn" onclick="importFriends()" id="importBtn" disabled>
                ğŸš€ å¯¼å…¥å¥½å‹åˆ—è¡¨
              </button>
            </div>
          </div>

          <div class="import-export-section" id="jsonPreviewSection" style="display: none">
            <h3>ğŸ“‹ JSONé¢„è§ˆ</h3>
            <textarea
              id="jsonPreview"
              readonly
              style="
                width: 100%;
                font-family: monospace;
                font-size: 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 8px;
                background: #f9f9f9;
              "
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==================== è§’è‰²å¡ç‹¬ç«‹å­˜å‚¨ç³»ç»Ÿ (V2 - äº‹ä»¶é€šä¿¡ç‰ˆ) ====================
      
      let currentCharacterInfo = { id: 'default', name: 'é»˜è®¤è§’è‰²', source: 'default' };
      let selectedImportFile = null;

      function setupCharacterUpdateListener() {
        window.addEventListener('message', (event) => {
          if (event.source !== parent) return;

          const { type, data } = event.data;

          if (type === 'character_updated' && data) {
            console.log('ğŸ“¬ æ”¶åˆ°æ¥è‡ªSillyTavernçš„è§’è‰²æ›´æ–°äº‹ä»¶:', data);
            
            if (data.id && data.id !== currentCharacterInfo.id) {
              console.log(`ğŸ”„ è§’è‰²å·²åˆ‡æ¢: "${currentCharacterInfo.name}" -> "${data.name}"`);
              currentCharacterInfo = data;
              loadFriends();
            } else if (!currentCharacterInfo.id || currentCharacterInfo.id === 'default') {
               // å¤„ç†é¦–æ¬¡åŠ è½½çš„æƒ…å†µ
               currentCharacterInfo = data;
               loadFriends();
            }
          }
        });
        console.log('ğŸ‘‚ å¥½å‹åˆ—è¡¨å·²è®¾ç½®è§’è‰²æ›´æ–°ç›‘å¬å™¨ã€‚');
      }

      function requestCharacterInfoFromParent() {
        try {
          if (typeof parent !== 'undefined' && typeof parent.postMessage === 'function') {
            parent.postMessage({ type: 'get_character_info_request' }, '*');
            console.log('ğŸ“¤ å·²å‘SillyTavernå‘é€è§’è‰²ä¿¡æ¯è¯·æ±‚ã€‚');
          } else {
             console.warn('æ— æ³•è¿æ¥åˆ°SillyTavernï¼Œå°†ä½¿ç”¨é»˜è®¤è§’è‰²ä¿¡æ¯ã€‚');
             loadFriends();
          }
        } catch (error) {
           console.error('å‘SillyTavernè¯·æ±‚è§’è‰²ä¿¡æ¯æ—¶å‡ºé”™:', error);
           loadFriends();
        }
      }

      function getFriendsStorageKey() {
        const charId = currentCharacterInfo.id || 'default';
        return `tavern_friends_list_${charId}`;
      }

      function saveFriends(friends) {
        try {
          const storageKey = getFriendsStorageKey();
          console.log(`ä¸ºè§’è‰² "${currentCharacterInfo.name}" ä¿å­˜å¥½å‹åˆ—è¡¨ï¼Œå­˜å‚¨é”®: ${storageKey}`);
          
          if (typeof parent !== 'undefined' && parent.extension_settings) {
            parent.extension_settings[storageKey] = JSON.parse(JSON.stringify(friends));
            if (typeof parent.saveSettingsDebounced === 'function') {
              parent.saveSettingsDebounced();
            }
          }
          localStorage.setItem(storageKey, JSON.stringify(friends));
        } catch (error) {
          console.error('ä¿å­˜å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
        }
      }

      function loadFriends() {
        try {
          const storageKey = getFriendsStorageKey();
          console.log(`ä¸ºè§’è‰² "${currentCharacterInfo.name}" åŠ è½½å¥½å‹åˆ—è¡¨ï¼Œå­˜å‚¨é”®: ${storageKey}`);

          let friends = [];
          if (typeof parent !== 'undefined' && parent.extension_settings) {
            friends = parent.extension_settings[storageKey] || [];
          } else {
            friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
          }

          displayFriends(friends);
          updateHeaderWithCharacter(currentCharacterInfo);
        } catch (error) {
          console.error('åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
          displayFriends([]);
        }
      }

      function updateHeaderWithCharacter(charInfo) {
        const header = document.querySelector('.header h1');
        if (header) {
          header.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div style="font-size: 18px;">å¥½å‹åˆ—è¡¨</div>
              <div style="font-size: 12px; color: #8b7355; margin-top: 2px;">
                ${charInfo.name}
              </div>
            </div>`;
        }
      }
      
      function displayFriends(friends) {
        const friendsList = document.getElementById('friendsList');

        if (friends.length === 0) {
          friendsList.innerHTML = `
            <div class="empty-state">
                <i>ğŸ‘¥</i>
                <p>æš‚æ— å¥½å‹ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ å¥½å‹æˆ–ç¾¤èŠ</p>
            </div>`;
          return;
        }

        const sortedFriends = friends.sort((a, b) => {
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          return 0;
        });

        friendsList.innerHTML = sortedFriends
          .map(
            (friend, index) => `
                <div class="friend-item ${friend.pinned ? 'pinned' : ''}" onclick="startChat('${friend.name}', '${friend.type}', '${friend.members || ''}')">
                    <div class="friend-avatar">
                        ${friend.type === 'group' ? 'ğŸ‘¥' : (friend.name.charAt(0) || ' ')}
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">
                            ${friend.name}
                            ${friend.type === 'group' ? '<span class="group-badge">ç¾¤èŠ</span>' : ''}
                            ${friend.pinned ? '<span class="pinned-badge">ğŸ“Œ</span>' : ''}
                        </div>
                        <div class="friend-type">
                            ${friend.type === 'group' ? `æˆå‘˜: ${friend.members || ''}` : 'å¥½å‹'}
                        </div>
                    </div>
                    <div class="friend-actions">
                        <button class="action-btn pin-btn ${friend.pinned ? 'pinned' : ''}"
                                onclick="handlePinClick(event, ${index})"
                                title="${friend.pinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}">
                            ${friend.pinned ? 'ğŸ“Œ' : 'ğŸ“'}
                        </button>
                        <button class="action-btn delete-btn"
                                onclick="handleDeleteClick(event, ${index})"
                                title="åˆ é™¤å¥½å‹">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>`
          )
          .join('');
      }

      function openAddModal() {
        document.getElementById('addModal').style.display = 'flex';
        showTypeSelection();
      }

      function closeAddModal() {
        document.getElementById('addModal').style.display = 'none';
        resetForms();
      }

      function showTypeSelection() {
        document.getElementById('typeSelection').style.display = 'block';
        document.getElementById('friendForm').style.display = 'none';
        document.getElementById('groupForm').style.display = 'none';
      }

      function selectType(type) {
        document.getElementById('typeSelection').style.display = 'none';
        if (type === 'friend') {
          document.getElementById('friendForm').style.display = 'block';
          document.getElementById('friendName').focus();
        } else if (type === 'group') {
          document.getElementById('groupForm').style.display = 'block';
          document.getElementById('groupName').focus();
        }
      }

      function backToTypeSelection() {
        resetForms();
        showTypeSelection();
      }

      function resetForms() {
        document.getElementById('friendName').value = '';
        document.getElementById('groupName').value = '';
        document.getElementById('groupMembers').value = '';
      }

      function addFriend() {
        const name = document.getElementById('friendName').value.trim();
        if (!name) return alert('è¯·è¾“å…¥å¥½å‹å§“å');
        
        const storageKey = getFriendsStorageKey();
        let friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
        if (friends.some(f => f.name === name && f.type === 'friend')) return alert('è¯¥å¥½å‹å·²å­˜åœ¨');

        friends.push({ name, type: 'friend', members: null, addTime: new Date().toISOString(), pinned: false });
        saveFriends(friends);
        displayFriends(friends);
        closeAddModal();
      }

      function addGroup() {
        const name = document.getElementById('groupName').value.trim();
        const members = document.getElementById('groupMembers').value.trim();
        if (!name) return alert('è¯·è¾“å…¥ç¾¤èŠåç§°');
        if (!members) return alert('è¯·è¾“å…¥ç¾¤æˆå‘˜');

        const storageKey = getFriendsStorageKey();
        let friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
        if (friends.some(f => f.name === name && f.type === 'group')) return alert('è¯¥ç¾¤èŠå·²å­˜åœ¨');
        
        friends.push({ name, type: 'group', members, addTime: new Date().toISOString(), pinned: false });
        saveFriends(friends);
        displayFriends(friends);
        closeAddModal();
      }

      function startChat(name, type, members) {
        if (typeof parent.triggerSlash === 'function') {
          const safeMembers = (members || '').replace(/\n/g, ' ');
          const message = type === 'group' 
            ? `/send <ç¾¤æˆå‘˜ï¼š${safeMembers}>\nã€å’Œ${name}çš„èŠå¤©ã€‘\n<qunliao>\n</qunliao>`
            : `/send ã€å’Œ${name}çš„èŠå¤©ã€‘\n<shouji>\n</shouji>`;
          parent.triggerSlash(message);
        } else {
          alert(`æ— æ³•è¿æ¥åˆ°SillyTavernçš„å‘é€åŠŸèƒ½ã€‚`);
        }
      }

      function handlePinClick(event, index) {
        event.stopPropagation();
        const storageKey = getFriendsStorageKey();
        let friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
        if(friends[index]) {
            friends[index].pinned = !friends[index].pinned;
            saveFriends(friends);
            displayFriends(friends);
        }
      }

      function handleDeleteClick(event, index) {
        event.stopPropagation();
        const storageKey = getFriendsStorageKey();
        let friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
        const friendToDelete = friends[index];
        if (friendToDelete && confirm(`ç¡®å®šè¦åˆ é™¤ "${friendToDelete.name}" å—ï¼Ÿ`)) {
          friends.splice(index, 1);
          saveFriends(friends);
          displayFriends(friends);
        }
      }
      
      function showImportExportModal() { document.getElementById('importExportModal').style.display = 'flex'; }
      function closeImportExportModal() { document.getElementById('importExportModal').style.display = 'none'; }
      function exportFriends() { /* å¯¼å‡ºé€»è¾‘ */ }
      function importFriends() { /* å¯¼å…¥é€»è¾‘ */ }
      function handleFileSelect(event) { /* æ–‡ä»¶é€‰æ‹©é€»è¾‘ */ }

      function showDebugInfo() {
        // ... è°ƒè¯•ä¿¡æ¯é€»è¾‘ ...
        alert(`å½“å‰è§’è‰²: ${currentCharacterInfo.name} (ID: ${currentCharacterInfo.id})`);
      }

      // UI äº‹ä»¶ç›‘å¬
      document.getElementById('addModal').addEventListener('click', (e) => e.target === this && closeAddModal());
      document.getElementById('importExportModal').addEventListener('click', (e) => e.target === this && closeImportExportModal());
      document.getElementById('friendName').addEventListener('keypress', (e) => e.key === 'Enter' && addFriend());
      document.getElementById('groupName').addEventListener('keypress', (e) => e.key === 'Enter' && document.getElementById('groupMembers').focus());
      
      window.addEventListener('load', () => {
        console.log('ğŸš€ å¥½å‹åˆ—è¡¨é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
        setupCharacterUpdateListener();
        requestCharacterInfoFromParent();
      });
    </script>
  </body>
</html>

