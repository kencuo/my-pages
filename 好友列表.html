<!DOCTYPE html>
<html lang="zh-CN">
Â  <head>
Â  Â  <meta charset="UTF-8" />
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  Â  <title>å¥½å‹åˆ—è¡¨</title>
Â  Â  <style>
Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Ma+Shan+Zheng&display=swap');

Â  Â  Â  * {
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  }

Â  Â  Â  body {
Â  Â  Â  Â  background: #f5f3e8;
Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  font-family: 'Noto Sans JP', 'Microsoft YaHei', sans-serif;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  }

Â  Â  Â  /* å¤–æ¡†åŒ…è£¹å±‚ */
Â  Â  Â  .phone-shell {
Â  Â  Â  Â  padding: 8px;Â 
Â  Â  Â  Â  background: #e8d5a3; /* ç±³é»„è‰²å¤–å£³ */
Â  Â  Â  Â  border-radius: 40px;
Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
Â  Â  Â  Â  display: inline-block;
Â  Â  Â  }

Â  Â  Â  .container {
Â  Â  Â  Â  width: 255px; /* è°ƒæ•´ä¸º255pxå®½åº¦ */
Â  Â  Â  Â  height: 650px; /* æ‰‹æœºé«˜åº¦ */
Â  Â  Â  Â  background: #ffffff; /* æœºèº«æœ¬ä½“çº¯ç™½ */
Â  Â  Â  Â  border-radius: 38px;
Â  Â  Â  Â  box-shadow: inset 0 0 0 2px #d4c294; /* å†…æè¾¹ï¼Œå‘¼åº”å¤–å£³ */
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  animation: fadeInUp 0.8s ease-out;
Â  Â  Â  }

Â  Â  Â  @keyframes fadeInUp {
Â  Â  Â  Â  from {
Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  transform: translateY(30px);
Â  Â  Â  Â  }
Â  Â  Â  Â  to {
Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  transform: translateY(0);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  .status-bar {
Â  Â  Â  Â  height: 30px;
Â  Â  Â  Â  background: #f7f5e8;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  padding: 0 16px;
Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  color: #8b7355;
Â  Â  Â  Â  box-shadow: 0 1px 0 #e7e5d8;
Â  Â  Â  }

Â  Â  Â  .header {
Â  Â  Â  Â  background: linear-gradient(135deg, #d4c294 0%, #c9b882 100%);
Â  Â  Â  Â  color: #8b7355;
Â  Â  Â  Â  padding: 25px;
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  border-bottom: 1px solid rgba(139, 115, 85, 0.2);
Â  Â  Â  }

Â  Â  Â  .header::before {
Â  Â  Â  Â  content: '';
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
Â  Â  Â  Â  animation: shimmer 3s infinite;
Â  Â  Â  }

Â  Â  Â  @keyframes shimmer {
Â  Â  Â  Â  0% {
Â  Â  Â  Â  Â  transform: translateX(-100%);
Â  Â  Â  Â  }
Â  Â  Â  Â  100% {
Â  Â  Â  Â  Â  transform: translateX(100%);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  .header h1 {
Â  Â  Â  Â  font-family: 'Ma Shan Zheng', cursive;
Â  Â  Â  Â  font-size: clamp(24px, 4vw, 28px);
Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  letter-spacing: 2px;
Â  Â  Â  Â  text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 20px rgba(212, 194, 148, 0.5);
Â  Â  Â  Â  animation: glow 2s ease-in-out infinite alternate;
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  z-index: 1;
Â  Â  Â  }

Â  Â  Â  @keyframes glow {
Â  Â  Â  Â  from {
Â  Â  Â  Â  Â  text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 20px rgba(212, 194, 148, 0.5);
Â  Â  Â  Â  }
Â  Â  Â  Â  to {
Â  Â  Â  Â  Â  text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 30px rgba(212, 194, 148, 0.7);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  .add-btn {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  transform: translateY(-50%);
Â  Â  Â  Â  background: rgba(212, 194, 148, 0.3);
Â  Â  Â  Â  border: 1px solid rgba(212, 194, 148, 0.5);
Â  Â  Â  Â  color: #8b7355;
Â  Â  Â  Â  width: 25px;
Â  Â  Â  Â  height: 25px;
Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  font-size: 18px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  Â  z-index: 2;
Â  Â  Â  }

Â  Â  Â  .add-btn:hover {
Â  Â  Â  Â  background: rgba(212, 194, 148, 0.5);
Â  Â  Â  Â  transform: translateY(-50%) scale(1.1);
Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(212, 194, 148, 0.4);
Â  Â  Â  }

Â  Â  Â  .friends-list {
Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  background: #faf9f4;
Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  max-height: calc(650px - 36px - 95px); /* å‡å»çŠ¶æ€æ å’Œheaderé«˜åº¦ */
Â  Â  Â  }

Â  Â  Â  /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
Â  Â  Â  .friends-list::-webkit-scrollbar {
Â  Â  Â  Â  width: 6px;
Â  Â  Â  }

Â  Â  Â  .friends-list::-webkit-scrollbar-track {
Â  Â  Â  Â  background: rgba(212, 194, 148, 0.1);
Â  Â  Â  Â  border-radius: 3px;
Â  Â  Â  }

Â  Â  Â  .friends-list::-webkit-scrollbar-thumb {
Â  Â  Â  Â  background: rgba(212, 194, 148, 0.4);
Â  Â  Â  Â  border-radius: 3px;
Â  Â  Â  }

Â  Â  Â  .friends-list::-webkit-scrollbar-thumb:hover {
Â  Â  Â  Â  background: rgba(212, 194, 148, 0.6);
Â  Â  Â  }

Â  Â  Â  .friend-item {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  padding: 18px;
Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  Â  border-radius: 15px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  background: #ffffff;
Â  Â  Â  Â  border: 1px solid rgba(212, 194, 148, 0.2);
Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(212, 194, 148, 0.1);
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  }

Â  Â  Â  .friend-item::before {
Â  Â  Â  Â  content: '';
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  left: -100%;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  background: linear-gradient(90deg, transparent, rgba(212, 194, 148, 0.1), transparent);
Â  Â  Â  Â  transition: left 0.5s;
Â  Â  Â  }

Â  Â  Â  .friend-item:hover::before {
Â  Â  Â  Â  left: 100%;
Â  Â  Â  }

Â  Â  Â  .friend-item:hover {
Â  Â  Â  Â  background: #f9f7f0;
Â  Â  Â  Â  transform: translateY(-2px) scale(1.02);
Â  Â  Â  Â  box-shadow: 0 8px 25px rgba(212, 194, 148, 0.2);
Â  Â  Â  Â  border-color: rgba(212, 194, 148, 0.4);
Â  Â  Â  }

Â  Â  Â  .friend-avatar {
Â  Â  Â  Â  width: 55px;
Â  Â  Â  Â  height: 55px;
Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  background: linear-gradient(135deg, #d4c294 0%, #c9b882 100%);
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  color: #8b7355;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  margin-right: 18px;
Â  Â  Â  Â  font-size: 18px;
Â  Â  Â  Â  text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.2);
Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(212, 194, 148, 0.3);
Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  z-index: 1;
Â  Â  Â  }

Â  Â  Â  .friend-item:hover .friend-avatar {
Â  Â  Â  Â  transform: scale(1.1) rotate(5deg);
Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(212, 194, 148, 0.4);
Â  Â  Â  }

Â  Â  Â  .friend-info {
Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  z-index: 1;
Â  Â  Â  }

Â  Â  Â  .friend-name {
Â  Â  Â  Â  font-size: 17px;
Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  color: #8b7355;
Â  Â  Â  Â  margin-bottom: 6px;
Â  Â  Â  Â  text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.1);
Â  Â  Â  Â  letter-spacing: 0.5px;
Â  Â  Â  }

Â  Â  Â  .friend-type {
Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  color: rgba(139, 115, 85, 0.7);
Â  Â  Â  Â  font-weight: 300;
Â  Â  Â  }

Â  Â  Â  .group-badge {
Â  Â  Â  Â  background: rgba(212, 194, 148, 0.8);
Â  Â  Â  Â  color: #8b7355;
Â  Â  Â  Â  padding: 4px 8px;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  font-size: 11px;
Â  Â  Â  Â  margin-left: 10px;
Â  Â  Â  Â  backdrop-filter: blur(5px);
Â  Â  Â  Â  border: 1px solid rgba(212, 194, 148, 0.5);
Â  Â  Â  Â  font-weight: 400;
Â  Â  Â  Â  text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.1);
Â  Â  Â  }

Â  Â  Â  .pinned-badge {
Â  Â  Â  Â  background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  padding: 2px 6px;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  font-size: 10px;
Â  Â  Â  Â  margin-left: 8px;
Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
Â  Â  Â  }

Â  Â  Â  .friend-item.pinned {
Â  Â  Â  Â  background: linear-gradient(135deg, #fff9e6, #fff5d6);
Â  Â  Â  Â  border-color: rgba(255, 193, 7, 0.3);
Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
Â  Â  Â  }

Â  Â  Â  .friend-item.pinned:hover {
Â  Â  Â  Â  background: linear-gradient(135deg, #fff7e0, #fff2cc);
Â  Â  Â  Â  border-color: rgba(255, 193, 7, 0.5);
Â  Â  Â  }

Â  Â  Â  .friend-actions {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  margin-left: auto;
Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  transition: opacity 0.3s ease;
Â  Â  Â  }

Â  Â  Â  .friend-item:hover .friend-actions {
Â  Â  Â  Â  opacity: 1;
Â  Â  Â  }

Â  Â  Â  .action-btn {
Â  Â  Â  Â  width: 32px;
Â  Â  Â  Â  height: 32px;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  transition: all 0.2s ease;
Â  Â  Â  Â  backdrop-filter: blur(5px);
Â  Â  Â  Â  user-select: none;
Â  Â  Â  Â  -webkit-tap-highlight-color: transparent;
Â  Â  Â  }

Â  Â  Â  .action-btn:hover {
Â  Â  Â  Â  transform: scale(1.1);
Â  Â  Â  }

Â  Â  Â  .action-btn:active {
Â  Â  Â  Â  transform: scale(0.95);
Â  Â  Â  }

Â  Â  Â  /* å¯¼å…¥/å¯¼å‡ºæ¨¡æ€æ¡†æ ·å¼ */
Â  Â  Â  .import-export-section {
Â  Â  Â  Â  margin: 20px 0;
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  border: 1px solid #e0e0e0;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  background: #fafafa;
Â  Â  Â  }

Â  Â  Â  .import-export-section h3 {
Â  Â  Â  Â  margin: 0 0 10px 0;
Â  Â  Â  Â  color: #8b7355;
Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  }

Â  Â  Â  .import-export-section p {
Â  Â  Â  Â  margin: 0 0 15px 0;
Â  Â  Â  Â  color: #666;
Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  }

Â  Â  Â  .divider {
Â  Â  Â  Â  height: 1px;
Â  Â  Â  Â  background: linear-gradient(to right, transparent, #d4c294, transparent);
Â  Â  Â  Â  margin: 20px 0;
Â  Â  Â  }

Â  Â  Â  /* æ–‡ä»¶é€‰æ‹©æ ·å¼ */
Â  Â  Â  #selectedFileName {
Â  Â  Â  Â  min-height: 16px;
Â  Â  Â  Â  font-style: italic;
Â  Â  Â  }

Â  Â  Â  #selectedFileName:empty::before {
Â  Â  Â  Â  content: 'æœªé€‰æ‹©æ–‡ä»¶';
Â  Â  Â  Â  color: #999;
Â  Â  Â  }

Â  Â  Â  /* JSONé¢„è§ˆåŒºåŸŸ */
Â  Â  Â  #jsonPreview {
Â  Â  Â  Â  resize: vertical;
Â  Â  Â  Â  min-height: 100px;
Â  Â  Â  Â  max-height: 300px;
Â  Â  Â  }

Â  Â  Â  /* å•é€‰æŒ‰é’®æ ·å¼ */
Â  Â  Â  input[type='radio'] {
Â  Â  Â  Â  accent-color: #d4c294;
Â  Â  Â  }

Â  Â  Â  /* ç¦ç”¨æŒ‰é’®æ ·å¼ */
Â  Â  Â  .submit-btn:disabled {
Â  Â  Â  Â  background: #ccc;
Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  opacity: 0.6;
Â  Â  Â  }

Â  Â  Â  .submit-btn:disabled:hover {
Â  Â  Â  Â  background: #ccc;
Â  Â  Â  Â  transform: none;
Â  Â  Â  }

Â  Â  Â  .pin-btn {
Â  Â  Â  Â  background: rgba(255, 193, 7, 0.8);
Â  Â  Â  Â  color: white;
Â  Â  Â  }

Â  Â  Â  .pin-btn:hover {
Â  Â  Â  Â  background: rgba(255, 193, 7, 1);
Â  Â  Â  Â  transform: scale(1.1);
Â  Â  Â  }

Â  Â  Â  .pin-btn.pinned {
Â  Â  Â  Â  background: rgba(255, 107, 107, 0.8);
Â  Â  Â  }

Â  Â  Â  .pin-btn.pinned:hover {
Â  Â  Â  Â  background: rgba(255, 107, 107, 1);
Â  Â  Â  }

Â  Â  Â  .delete-btn {
Â  Â  Â  Â  background: rgba(255, 107, 107, 0.8);
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  transition: all 0.2s ease;
Â  Â  Â  }

Â  Â  Â  .delete-btn:hover {
Â  Â  Â  Â  background: rgba(255, 107, 107, 1);
Â  Â  Â  Â  transform: scale(1.15);
Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
Â  Â  Â  }

Â  Â  Â  .delete-btn:active {
Â  Â  Â  Â  transform: scale(0.95);
Â  Â  Â  Â  background: rgba(220, 90, 90, 1);
Â  Â  Â  }

Â  Â  Â  .modal {
Â  Â  Â  Â  display: none;
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  background: rgba(0, 0, 0, 0.5);
Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  }

Â  Â  Â  .modal-content {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  Â  background: white;
Â  Â  Â  Â  padding: 30px;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  max-width: 400px;
Â  Â  Â  }

Â  Â  Â  .modal h2 {
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  }

Â  Â  Â  .form-group {
Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  }

Â  Â  Â  .form-group label {
Â  Â  Â  Â  display: block;
Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  }

Â  Â  Â  .form-group input,
Â  Â  Â  .form-group textarea {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  border: 2px solid #e1e5e9;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  transition: border-color 0.3s;
Â  Â  Â  }

Â  Â  Â  .form-group input:focus,
Â  Â  Â  .form-group textarea:focus {
Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  border-color: #667eea;
Â  Â  Â  }

Â  Â  Â  .form-group textarea {
Â  Â  Â  Â  resize: vertical;
Â  Â  Â  Â  min-height: 80px;
Â  Â  Â  }

Â  Â  Â  .btn-group {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  }

Â  Â  Â  .btn {
Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  transition: all 0.3s;
Â  Â  Â  }

Â  Â  Â  .btn-primary {
Â  Â  Â  Â  background: #667eea;
Â  Â  Â  Â  color: white;
Â  Â  Â  }

Â  Â  Â  .btn-primary:hover {
Â  Â  Â  Â  background: #5a6fd8;
Â  Â  Â  }

Â  Â  Â  .btn-secondary {
Â  Â  Â  Â  background: #e9ecef;
Â  Â  Â  Â  color: #6c757d;
Â  Â  Â  }

Â  Â  Â  .btn-secondary:hover {
Â  Â  Â  Â  background: #dee2e6;
Â  Â  Â  }

Â  Â  Â  .empty-state {
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  padding: 60px 20px;
Â  Â  Â  Â  color: #999;
Â  Â  Â  }

Â  Â  Â  .empty-state i {
Â  Â  Â  Â  font-size: 48px;
Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  display: block;
Â  Â  Â  }
Â  Â  </style>
Â  </head>
Â  <body>
Â  Â  <div class="phone-shell">
Â  Â  Â  <div class="container">
Â  Â  Â  Â  <div class="status-bar">
Â  Â  Â  Â  Â  <div>9:41</div>
Â  Â  Â  Â  Â  <div>ğŸ“¶ ğŸ“¶ ğŸ“¶ ğŸ”‹</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="header">
Â  Â  Â  Â  Â  <h1>å¥½å‹åˆ—è¡¨</h1>
Â  Â  Â  Â  Â  <button class="add-btn" onclick="openAddModal()">+</button>
Â  Â  Â  Â  Â  <button class="add-btn" onclick="showDebugInfo()" style="right: 65px; font-size: 14px" title="è°ƒè¯•ä¿¡æ¯">
Â  Â  Â  Â  Â  Â  â„¹ï¸
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  class="add-btn"
Â  Â  Â  Â  Â  Â  onclick="showImportExportModal()"
Â  Â  Â  Â  Â  Â  style="right: 105px; font-size: 12px"
Â  Â  Â  Â  Â  Â  title="å¯¼å…¥/å¯¼å‡ºå¥½å‹"
Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  ğŸ“
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="friends-list" id="friendsList">
Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  <i>ğŸ‘¥</i>
Â  Â  Â  Â  Â  Â  <p>æš‚æ— å¥½å‹ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ å¥½å‹æˆ–ç¾¤èŠ</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- æ·»åŠ å¥½å‹/ç¾¤èŠæ¨¡æ€æ¡† -->
Â  Â  <div class="modal" id="addModal">
Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  <!-- ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©ç±»å‹ -->
Â  Â  Â  Â  <div id="typeSelection">
Â  Â  Â  Â  Â  <h2>æ·»åŠ å¥½å‹/ç¾¤èŠ</h2>
Â  Â  Â  Â  Â  <p style="text-align: center; color: #666; margin-bottom: 20px">è¯·é€‰æ‹©è¦æ·»åŠ çš„ç±»å‹</p>
Â  Â  Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="selectType('friend')">ğŸ‘¤ æ·»åŠ å¥½å‹</button>
Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="selectType('group')">ğŸ‘¥ æ·»åŠ ç¾¤èŠ</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="text-align: center; margin-top: 15px">
Â  Â  Â  Â  Â  Â  <button class="btn btn-secondary" onclick="closeAddModal()">å–æ¶ˆ</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- ç¬¬äºŒæ­¥ï¼šæ·»åŠ å¥½å‹ -->
Â  Â  Â  Â  <div id="friendForm" style="display: none">
Â  Â  Â  Â  Â  <h2>æ·»åŠ å¥½å‹</h2>
Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  <label for="friendName">å¥½å‹å§“å</label>
Â  Â  Â  Â  Â  Â  <input type="text" id="friendName" placeholder="è¯·è¾“å…¥å¥½å‹å§“å" />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  Â  Â  <button class="btn btn-secondary" onclick="backToTypeSelection()">è¿”å›</button>
Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="addFriend()">æ·»åŠ å¥½å‹</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ ç¾¤èŠ -->
Â  Â  Â  Â  <div id="groupForm" style="display: none">
Â  Â  Â  Â  Â  <h2>æ·»åŠ ç¾¤èŠ</h2>
Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  <label for="groupName">ç¾¤èŠåç§°</label>
Â  Â  Â  Â  Â  Â  <input type="text" id="groupName" placeholder="è¯·è¾“å…¥ç¾¤èŠåç§°" />
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  <label for="groupMembers">ç¾¤æˆå‘˜</label>
Â  Â  Â  Â  Â  Â  <textarea id="groupMembers" placeholder="è¯·è¾“å…¥ç¾¤æˆå‘˜ï¼Œç”¨é€—å·éš”å¼€&#10;ä¾‹å¦‚ï¼šå¼ ä¸‰,æå››,ç‹äº”"></textarea>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  Â  Â  <button class="btn btn-secondary" onclick="backToTypeSelection()">è¿”å›</button>
Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="addGroup()">æ·»åŠ ç¾¤èŠ</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- å¯¼å…¥/å¯¼å‡ºæ¨¡æ€æ¡† -->
Â  Â  <div class="modal-overlay" id="importExportOverlay" style="display: none">
Â  Â  Â  <div class="modal">
Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  <h2>ğŸ“ å¯¼å…¥/å¯¼å‡ºå¥½å‹åˆ—è¡¨</h2>
Â  Â  Â  Â  Â  <button class="close-btn" onclick="closeImportExportModal()">Ã—</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  <!-- å¯¼å‡ºåŒºåŸŸ -->
Â  Â  Â  Â  Â  <div class="import-export-section">
Â  Â  Â  Â  Â  Â  <h3>ğŸ“¤ å¯¼å‡ºå¥½å‹åˆ—è¡¨</h3>
Â  Â  Â  Â  Â  Â  <p>å°†å½“å‰è§’è‰²çš„å¥½å‹åˆ—è¡¨å¯¼å‡ºä¸ºJSONæ–‡ä»¶</p>
Â  Â  Â  Â  Â  Â  <div style="margin: 15px 0">
Â  Â  Â  Â  Â  Â  Â  <button class="submit-btn" onclick="exportFriends()" style="width: 100%">ğŸ“¥ å¯¼å‡ºä¸ºJSONæ–‡ä»¶</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="divider"></div>

Â  Â  Â  Â  Â  <!-- å¯¼å…¥åŒºåŸŸ -->
Â  Â  Â  Â  Â  <div class="import-export-section">
Â  Â  Â  Â  Â  Â  <h3>ğŸ“¤ å¯¼å…¥å¥½å‹åˆ—è¡¨</h3>
Â  Â  Â  Â  Â  Â  <p>ä»JSONæ–‡ä»¶å¯¼å…¥å¥½å‹åˆ—è¡¨åˆ°å½“å‰è§’è‰²</p>

Â  Â  Â  Â  Â  Â  <!-- æ–‡ä»¶é€‰æ‹© -->
Â  Â  Â  Â  Â  Â  <div style="margin: 15px 0">
Â  Â  Â  Â  Â  Â  Â  <input
Â  Â  Â  Â  Â  Â  Â  Â  type="file"
Â  Â  Â  Â  Â  Â  Â  Â  id="importFileInput"
Â  Â  Â  Â  Â  Â  Â  Â  accept=".json"
Â  Â  Â  Â  Â  Â  Â  Â  style="display: none"
Â  Â  Â  Â  Â  Â  Â  Â  onchange="handleFileSelect(event)"
Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  class="submit-btn"
Â  Â  Â  Â  Â  Â  Â  Â  onclick="document.getElementById('importFileInput').click()"
Â  Â  Â  Â  Â  Â  Â  Â  style="width: 100%; margin-bottom: 10px"
Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“ é€‰æ‹©JSONæ–‡ä»¶
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  <div id="selectedFileName" style="font-size: 12px; color: #666; text-align: center"></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- å¯¼å…¥é€‰é¡¹ -->
Â  Â  Â  Â  Â  Â  <div style="margin: 15px 0">
Â  Â  Â  Â  Â  Â  Â  <label style="display: flex; align-items: center; margin-bottom: 10px">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="importMode" value="replace" checked style="margin-right: 8px" />
Â  Â  Â  Â  Â  Â  Â  Â  <span>æ›¿æ¢ç°æœ‰å¥½å‹åˆ—è¡¨</span>
Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  <label style="display: flex; align-items: center">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="importMode" value="merge" style="margin-right: 8px" />
Â  Â  Â  Â  Â  Â  Â  Â  <span>åˆå¹¶åˆ°ç°æœ‰å¥½å‹åˆ—è¡¨ï¼ˆè·³è¿‡é‡å¤ï¼‰</span>
Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- å¯¼å…¥æŒ‰é’® -->
Â  Â  Â  Â  Â  Â  <div style="margin: 15px 0">
Â  Â  Â  Â  Â  Â  Â  <button class="submit-btn" onclick="importFriends()" style="width: 100%" id="importBtn" disabled>
Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“¥ å¯¼å…¥å¥½å‹åˆ—è¡¨
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <!-- JSONé¢„è§ˆåŒºåŸŸ -->
Â  Â  Â  Â  Â  <div class="import-export-section" id="jsonPreviewSection" style="display: none">
Â  Â  Â  Â  Â  Â  <h3>ğŸ“‹ JSONé¢„è§ˆ</h3>
Â  Â  Â  Â  Â  Â  <textarea
Â  Â  Â  Â  Â  Â  Â  id="jsonPreview"
Â  Â  Â  Â  Â  Â  Â  readonly
Â  Â  Â  Â  Â  Â  Â  style="
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  Â  Â  height: 150px;
Â  Â  Â  Â  Â  Â  Â  Â  font-family: monospace;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  Â  Â  Â  Â  background: #f9f9f9;
Â  Â  Â  Â  Â  Â  Â  "
Â  Â  Â  Â  Â  Â  ></textarea>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  // ==================== è§’è‰²å¡ç‹¬ç«‹å­˜å‚¨ç³»ç»Ÿ ====================

Â  Â  Â  // è·å–å½“å‰è§’è‰²ä¿¡æ¯ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
Â  Â  Â  function getCurrentCharacterInfo() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  // æ–¹æ³•1: ä»SillyTavernçš„å…¨å±€å˜é‡è·å–å½“å‰è§’è‰²ID
Â  Â  Â  Â  Â  if (typeof parent !== 'undefined' && parent.this_chid !== undefined) {
Â  Â  Â  Â  Â  Â  const charId = parent.this_chid;
Â  Â  Â  Â  Â  Â  let charName = 'æœªçŸ¥è§’è‰²';

Â  Â  Â  Â  Â  Â  // å°è¯•è·å–è§’è‰²åç§°
Â  Â  Â  Â  Â  Â  if (parent.characters && parent.characters[charId]) {
Â  Â  Â  Â  Â  Â  Â  charName = parent.characters[charId].name || parent.characters[charId].data?.name || `è§’è‰²${charId}`;
Â  Â  Â  Â  Â  Â  } else if (parent.name1) {
Â  Â  Â  Â  Â  Â  Â  charName = parent.name1; // å½“å‰èŠå¤©ä¸­çš„è§’è‰²å
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  console.log('ä»SillyTavernè·å–è§’è‰²ä¿¡æ¯:', { id: charId, name: charName });
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  id: charId.toString(),
Â  Â  Â  Â  Â  Â  Â  name: charName,
Â  Â  Â  Â  Â  Â  Â  source: 'sillytavern_chid',
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // æ–¹æ³•2: ä»SillyTavernçš„context APIè·å–
Â  Â  Â  Â  Â  if (typeof parent !== 'undefined' && parent.getContext) {
Â  Â  Â  Â  Â  Â  const context = parent.getContext();
Â  Â  Â  Â  Â  Â  if (context && context.characterId) {
Â  Â  Â  Â  Â  Â  Â  console.log('ä»context APIè·å–è§’è‰²ä¿¡æ¯:', context);
Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  id: context.characterId.toString(),
Â  Â  Â  Â  Â  Â  Â  Â  name: context.name || context.characterId,
Â  Â  Â  Â  Â  Â  Â  Â  source: 'sillytavern_context',
Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // æ–¹æ³•3: ä»URLå‚æ•°è·å–è§’è‰²ä¿¡æ¯
Â  Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  Â  const charId = urlParams.get('character') || urlParams.get('char') || urlParams.get('id');
Â  Â  Â  Â  Â  if (charId) {
Â  Â  Â  Â  Â  Â  console.log('ä»URLå‚æ•°è·å–è§’è‰²ä¿¡æ¯:', charId);
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  id: charId,
Â  Â  Â  Â  Â  Â  Â  name: charId,
Â  Â  Â  Â  Â  Â  Â  source: 'url',
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // æ–¹æ³•4: ä»localStorageè·å–æœ€åä½¿ç”¨çš„è§’è‰²
Â  Â  Â  Â  Â  const lastCharId = localStorage.getItem('lastUsedCharacter');
Â  Â  Â  Â  Â  if (lastCharId) {
Â  Â  Â  Â  Â  Â  console.log('ä»localStorageè·å–æœ€åä½¿ç”¨çš„è§’è‰²:', lastCharId);
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  id: lastCharId,
Â  Â  Â  Â  Â  Â  Â  name: `è§’è‰²${lastCharId}`,
Â  Â  Â  Â  Â  Â  Â  source: 'localStorage',
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // é»˜è®¤è§’è‰²
Â  Â  Â  Â  Â  console.log('ä½¿ç”¨é»˜è®¤è§’è‰²');
Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  id: 'default',
Â  Â  Â  Â  Â  Â  name: 'é»˜è®¤è§’è‰²',
Â  Â  Â  Â  Â  Â  source: 'default',
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.warn('è·å–è§’è‰²ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è§’è‰²:', error);
Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  id: 'default',
Â  Â  Â  Â  Â  Â  name: 'é»˜è®¤è§’è‰²',
Â  Â  Â  Â  Â  Â  source: 'default',
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // ç”Ÿæˆè§’è‰²ä¸“ç”¨çš„å­˜å‚¨é”®å
Â  Â  Â  function getFriendsStorageKey() {
Â  Â  Â  Â  const charInfo = getCurrentCharacterInfo();
Â  Â  Â  Â  // ä½¿ç”¨æ›´å…·ä½“çš„é”®åæ ¼å¼ï¼Œç¡®ä¿ä¸åŒè§’è‰²å®Œå…¨éš”ç¦»
Â  Â  Â  Â  return `tavern_friends_${charInfo.source}_${charInfo.id}`;
Â  Â  Â  }

Â  Â  Â  // ä¿å­˜å½“å‰è§’è‰²IDåˆ°localStorageï¼Œç”¨äºè§’è‰²åˆ‡æ¢æ£€æµ‹
Â  Â  Â  function saveCurrentCharacterId() {
Â  Â  Â  Â  const charInfo = getCurrentCharacterInfo();
Â  Â  Â  Â  localStorage.setItem('lastUsedCharacter', charInfo.id);
Â  Â  Â  Â  console.log('ä¿å­˜å½“å‰è§’è‰²ID:', charInfo.id);
Â  Â  Â  }

Â  Â  Â  // ä»è§’è‰²ä¸“ç”¨å­˜å‚¨åŠ è½½å¥½å‹åˆ—è¡¨
Â  Â  Â  function loadFriends() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const storageKey = getFriendsStorageKey();
Â  Â  Â  Â  Â  const charInfo = getCurrentCharacterInfo();

Â  Â  Â  Â  Â  console.log(`ä¸ºè§’è‰² "${charInfo.name}" åŠ è½½å¥½å‹åˆ—è¡¨ï¼Œå­˜å‚¨é”®: ${storageKey}`);

Â  Â  Â  Â  Â  // ä¼˜å…ˆä»SillyTavern extension_settingsè¯»å–
Â  Â  Â  Â  Â  let friends = [];
Â  Â  Â  Â  Â  if (typeof parent !== 'undefined' && parent.extension_settings) {
Â  Â  Â  Â  Â  Â  friends = parent.extension_settings[storageKey] || [];
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // å›é€€åˆ°localStorage
Â  Â  Â  Â  Â  Â  friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // å¦‚æœå½“å‰è§’è‰²æ²¡æœ‰å¥½å‹æ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦è¿ç§»æ—§æ•°æ®
Â  Â  Â  Â  Â  if (friends.length === 0) {
Â  Â  Â  Â  Â  Â  const migrated = migrateOldFriendsData();
Â  Â  Â  Â  Â  Â  if (migrated) {
Â  Â  Â  Â  Â  Â  Â  // é‡æ–°åŠ è½½è¿ç§»åçš„æ•°æ®
Â  Â  Â  Â  Â  Â  Â  if (typeof parent !== 'undefined' && parent.extension_settings) {
Â  Â  Â  Â  Â  Â  Â  Â  friends = parent.extension_settings[storageKey] || [];
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  displayFriends(friends);

Â  Â  Â  Â  Â  // åœ¨æ ‡é¢˜ä¸­æ˜¾ç¤ºå½“å‰è§’è‰²
Â  Â  Â  Â  Â  updateHeaderWithCharacter(charInfo);
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error('åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
Â  Â  Â  Â  Â  displayFriends([]);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // ä¿å­˜å¥½å‹åˆ—è¡¨åˆ°è§’è‰²ä¸“ç”¨å­˜å‚¨
Â  Â  Â  function saveFriends(friends) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const storageKey = getFriendsStorageKey();
Â  Â  Â  Â  Â  const charInfo = getCurrentCharacterInfo();

Â  Â  Â  Â  Â  console.log(`ä¸ºè§’è‰² "${charInfo.name}" ä¿å­˜å¥½å‹åˆ—è¡¨ï¼Œå­˜å‚¨é”®: ${storageKey}ï¼Œå¥½å‹æ•°é‡: ${friends.length}`);

Â  Â  Â  Â  Â  // ä¼˜å…ˆä¿å­˜åˆ°SillyTavern extension_settings
Â  Â  Â  Â  Â  if (typeof parent !== 'undefined' && parent.extension_settings) {
Â  Â  Â  Â  Â  Â  parent.extension_settings[storageKey] = JSON.parse(JSON.stringify(friends));
Â  Â  Â  Â  Â  Â  // è§¦å‘SillyTavernçš„è®¾ç½®ä¿å­˜
Â  Â  Â  Â  Â  Â  if (typeof parent.saveSettingsDebounced === 'function') {
Â  Â  Â  Â  Â  Â  Â  parent.saveSettingsDebounced();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
Â  Â  Â  Â  Â  localStorage.setItem(storageKey, JSON.stringify(friends));
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error('ä¿å­˜å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºå½“å‰è§’è‰²
Â  Â  Â  function updateHeaderWithCharacter(charInfo) {
Â  Â  Â  Â  const header = document.querySelector('.header h1');
Â  Â  Â  Â  if (header) {
Â  Â  Â  Â  Â  header.innerHTML = `
Â  Â  Â  Â  Â  Â  <div style="display: flex; flex-direction: column; align-items: center;">
Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 18px;">å¥½å‹åˆ—è¡¨</div>
Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: #8b7355; margin-top: 2px;">
Â  Â  Â  Â  Â  Â  Â  Â  ${charInfo.name}
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // æ•°æ®è¿ç§»ï¼šå°†æ—§çš„å…¨å±€å¥½å‹åˆ—è¡¨è¿ç§»åˆ°å½“å‰è§’è‰²
Â  Â  Â  function migrateOldFriendsData() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const oldFriends = JSON.parse(localStorage.getItem('friendsList') || '[]');
Â  Â  Â  Â  Â  if (oldFriends.length > 0) {
Â  Â  Â  Â  Â  Â  const charInfo = getCurrentCharacterInfo();
Â  Â  Â  Â  Â  Â  const storageKey = getFriendsStorageKey();

Â  Â  Â  Â  Â  Â  // æ£€æŸ¥å½“å‰è§’è‰²æ˜¯å¦å·²æœ‰å¥½å‹æ•°æ®
Â  Â  Â  Â  Â  Â  let currentFriends = [];
Â  Â  Â  Â  Â  Â  if (typeof parent !== 'undefined' && parent.extension_settings) {
Â  Â  Â  Â  Â  Â  Â  currentFriends = parent.extension_settings[storageKey] || [];
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  currentFriends = JSON.parse(localStorage.getItem(storageKey) || '[]');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // å¦‚æœå½“å‰è§’è‰²æ²¡æœ‰å¥½å‹æ•°æ®ï¼Œè¯¢é—®æ˜¯å¦è¿ç§»
Â  Â  Â  Â  Â  Â  if (currentFriends.length === 0) {
Â  Â  Â  Â  Â  Â  Â  const shouldMigrate = confirm(
Â  Â  Â  Â  Â  Â  Â  Â  `æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬çš„å¥½å‹åˆ—è¡¨æ•°æ®ï¼ˆ${oldFriends.length}ä¸ªå¥½å‹ï¼‰ã€‚\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  `æ˜¯å¦è¦å°†è¿™äº›å¥½å‹è¿ç§»åˆ°å½“å‰è§’è‰² "${charInfo.name}" çš„å¥½å‹åˆ—è¡¨ä¸­ï¼Ÿ\n\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  `ç‚¹å‡»"ç¡®å®š"è¿ç§»ï¼Œç‚¹å‡»"å–æ¶ˆ"ä¿æŒå½“å‰çŠ¶æ€ã€‚`,
Â  Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  Â  if (shouldMigrate) {
Â  Â  Â  Â  Â  Â  Â  Â  saveFriends(oldFriends);
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`å·²å°† ${oldFriends.length} ä¸ªå¥½å‹è¿ç§»åˆ°è§’è‰² "${charInfo.name}"`);

Â  Â  Â  Â  Â  Â  Â  Â  // è¯¢é—®æ˜¯å¦æ¸…é™¤æ—§æ•°æ®
Â  Â  Â  Â  Â  Â  Â  Â  const shouldClearOld = confirm(
Â  Â  Â  Â  Â  Â  Â  Â  Â  `å¥½å‹æ•°æ®è¿ç§»å®Œæˆï¼\n\n` + `æ˜¯å¦è¦æ¸…é™¤æ—§ç‰ˆæœ¬çš„å…¨å±€å¥½å‹åˆ—è¡¨æ•°æ®ï¼Ÿ\n` + `ï¼ˆå»ºè®®æ¸…é™¤ï¼Œé¿å…æ•°æ®æ··ä¹±ï¼‰`,
Â  Â  Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  Â  Â  if (shouldClearOld) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('friendsList');
Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('å·²æ¸…é™¤æ—§ç‰ˆæœ¬çš„å…¨å±€å¥½å‹åˆ—è¡¨æ•°æ®');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  return true; // è¡¨ç¤ºè¿›è¡Œäº†è¿ç§»
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error('æ•°æ®è¿ç§»å¤±è´¥:', error);
Â  Â  Â  Â  }
Â  Â  Â  Â  return false; // è¡¨ç¤ºæ²¡æœ‰è¿›è¡Œè¿ç§»
Â  Â  Â  }

Â  Â  Â  // æ˜¾ç¤ºå¥½å‹åˆ—è¡¨
Â  Â  Â  function displayFriends(friends) {
Â  Â  Â  Â  const friendsList = document.getElementById('friendsList');

Â  Â  Â  Â  if (friends.length === 0) {
Â  Â  Â  Â  Â  friendsList.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i>ğŸ‘¥</i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>æš‚æ— å¥½å‹ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ å¥½å‹æˆ–ç¾¤èŠ</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // æŒ‰ç½®é¡¶çŠ¶æ€æ’åºï¼Œç½®é¡¶çš„åœ¨å‰é¢
Â  Â  Â  Â  const sortedFriends = friends.sort((a, b) => {
Â  Â  Â  Â  Â  if (a.pinned && !b.pinned) return -1;
Â  Â  Â  Â  Â  if (!a.pinned && b.pinned) return 1;
Â  Â  Â  Â  Â  return 0;
Â  Â  Â  Â  });

Â  Â  Â  Â  friendsList.innerHTML = sortedFriends
Â  Â  Â  Â  Â  .map(
Â  Â  Â  Â  Â  Â  (friend, index) => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="friend-item ${friend.pinned ? 'pinned' : ''}" onclick="startChat('${friend.name}', '${
Â  Â  Â  Â  Â  Â  Â  friend.type
Â  Â  Â  Â  Â  Â  }', '${friend.members || ''}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="friend-avatar">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${friend.type === 'group' ? 'ğŸ‘¥' : friend.name.charAt(0)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="friend-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="friend-name">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${friend.name}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${friend.type === 'group' ? '<span class="group-badge">ç¾¤èŠ</span>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${friend.pinned ? '<span class="pinned-badge">ğŸ“Œ</span>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="friend-type">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${friend.type === 'group' ? `æˆå‘˜: ${friend.members}` : 'å¥½å‹'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="friend-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn pin-btn ${friend.pinned ? 'pinned' : ''}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onclick="handlePinClick(event, ${index})"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title="${friend.pinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${friend.pinned ? 'ğŸ“Œ' : 'ğŸ“'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn delete-btn"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onclick="handleDeleteClick(event, ${index})"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title="åˆ é™¤å¥½å‹">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ—‘ï¸
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `,
Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  .join('');
Â  Â  Â  }

Â  Â  Â  // æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
Â  Â  Â  function openAddModal() {
Â  Â  Â  Â  document.getElementById('addModal').style.display = 'block';
Â  Â  Â  Â  showTypeSelection();
Â  Â  Â  }

Â  Â  Â  // å…³é—­æ·»åŠ æ¨¡æ€æ¡†
Â  Â  Â  function closeAddModal() {
Â  Â  Â  Â  document.getElementById('addModal').style.display = 'none';
Â  Â  Â  Â  resetForms();
Â  Â  Â  }

Â  Â  Â  // æ˜¾ç¤ºç±»å‹é€‰æ‹©ç•Œé¢
Â  Â  Â  function showTypeSelection() {
Â  Â  Â  Â  document.getElementById('typeSelection').style.display = 'block';
Â  Â  Â  Â  document.getElementById('friendForm').style.display = 'none';
Â  Â  Â  Â  document.getElementById('groupForm').style.display = 'none';
Â  Â  Â  }

Â  Â  Â  // é€‰æ‹©ç±»å‹ï¼ˆå¥½å‹æˆ–ç¾¤èŠï¼‰
Â  Â  Â  function selectType(type) {
Â  Â  Â  Â  document.getElementById('typeSelection').style.display = 'none';

Â  Â  Â  Â  if (type === 'friend') {
Â  Â  Â  Â  Â  document.getElementById('friendForm').style.display = 'block';
Â  Â  Â  Â  Â  document.getElementById('friendName').focus();
Â  Â  Â  Â  } else if (type === 'group') {
Â  Â  Â  Â  Â  document.getElementById('groupForm').style.display = 'block';
Â  Â  Â  Â  Â  document.getElementById('groupName').focus();
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // è¿”å›ç±»å‹é€‰æ‹©
Â  Â  Â  function backToTypeSelection() {
Â  Â  Â  Â  resetForms();
Â  Â  Â  Â  showTypeSelection();
Â  Â  Â  }

Â  Â  Â  // é‡ç½®è¡¨å•
Â  Â  Â  function resetForms() {
Â  Â  Â  Â  document.getElementById('friendName').value = '';
Â  Â  Â  Â  document.getElementById('groupName').value = '';
Â  Â  Â  Â  document.getElementById('groupMembers').value = '';
Â  Â  Â  }

Â  Â  Â  // æ·»åŠ å¥½å‹
Â  Â  Â  function addFriend() {
Â  Â  Â  Â  const name = document.getElementById('friendName').value.trim();

Â  Â  Â  Â  if (!name) {
Â  Â  Â  Â  Â  alert('è¯·è¾“å…¥å¥½å‹å§“å');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // ä½¿ç”¨è§’è‰²ä¸“ç”¨å­˜å‚¨åŠ è½½å¥½å‹åˆ—è¡¨
Â  Â  Â  Â  const storageKey = getFriendsStorageKey();
Â  Â  Â  Â  let friends = [];
Â  Â  Â  Â  if (typeof parent !== 'undefined' && parent.extension_settings) {
Â  Â  Â  Â  Â  friends = parent.extension_settings[storageKey] || [];
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
Â  Â  Â  Â  }

Â  Â  Â  Â  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
Â  Â  Â  Â  if (friends.some(friend => friend.name === name)) {
Â  Â  Â  Â  Â  alert('è¯¥å¥½å‹å·²å­˜åœ¨');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const newFriend = {
Â  Â  Â  Â  Â  name: name,
Â  Â  Â  Â  Â  type: 'friend',
Â  Â  Â  Â  Â  members: null,
Â  Â  Â  Â  Â  addTime: new Date().toISOString(),
Â  Â  Â  Â  };

Â  Â  Â  Â  friends.push(newFriend);
Â  Â  Â  Â  saveFriends(friends); // ä½¿ç”¨æ–°çš„ä¿å­˜å‡½æ•°

Â  Â  Â  Â  displayFriends(friends);
Â  Â  Â  Â  closeAddModal();

Â  Â  Â  Â  const charInfo = getCurrentCharacterInfo();
Â  Â  Â  Â  alert(`å¥½å‹ "${name}" å·²æ·»åŠ åˆ° "${charInfo.name}" çš„å¥½å‹åˆ—è¡¨ï¼`);
Â  Â  Â  }

Â  Â  Â  // æ·»åŠ ç¾¤èŠ
Â  Â  Â  function addGroup() {
Â  Â  Â  Â  const name = document.getElementById('groupName').value.trim();
Â  Â  Â  Â  const members = document.getElementById('groupMembers').value.trim();

Â  Â  Â  Â  if (!name) {
Â  Â  Â  Â  Â  alert('è¯·è¾“å…¥ç¾¤èŠåç§°');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (!members) {
Â  Â  Â  Â  Â  alert('è¯·è¾“å…¥ç¾¤æˆå‘˜');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // ä½¿ç”¨è§’è‰²ä¸“ç”¨å­˜å‚¨åŠ è½½å¥½å‹åˆ—è¡¨
Â  Â  Â  Â  const storageKey = getFriendsStorageKey();
Â  Â  Â  Â  let friends = [];
Â  Â  Â  Â  if (typeof parent !== 'undefined' && parent.extension_settings) {
Â  Â  Â  Â  Â  friends = parent.extension_settings[storageKey] || [];
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
Â  Â  Â  Â  }

Â  Â  Â  Â  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
Â  Â  Â  Â  if (friends.some(friend => friend.name === name)) {
Â  Â  Â  Â  Â  alert('è¯¥ç¾¤èŠå·²å­˜åœ¨');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const newGroup = {
Â  Â  Â  Â  Â  name: name,
Â  Â  Â  Â  Â  type: 'group',
Â  Â  Â  Â  Â  members: members,
Â  Â  Â  Â  Â  addTime: new Date().toISOString(),
Â  Â  Â  Â  };

Â  Â  Â  Â  friends.push(newGroup);
Â  Â  Â  Â  saveFriends(friends); // ä½¿ç”¨æ–°çš„ä¿å­˜å‡½æ•°

Â  Â  Â  Â  displayFriends(friends);
Â  Â  Â  Â  closeAddModal();

Â  Â  Â  Â  const charInfo = getCurrentCharacterInfo();
Â  Â  Â  Â  alert(`ç¾¤èŠ "${name}" å·²æ·»åŠ åˆ° "${charInfo.name}" çš„å¥½å‹åˆ—è¡¨ï¼`);
Â  Â  Â  }

Â  Â  Â  // å¼€å§‹èŠå¤©
Â  Â  Â  function startChat(name, type, members) {
Â  Â  Â  Â  if (typeof triggerSlash === 'function') {
Â  Â  Â  Â  Â  if (type === 'group') {
Â  Â  Â  Â  Â  Â  const message = `/send <ç¾¤æˆå‘˜ï¼š${members}>
ã€å’Œ${name}çš„èŠå¤©ã€‘
<qunliao>
</qunliao>`;
Â  Â  Â  Â  Â  Â  triggerSlash(message);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const message = `/send ã€å’Œ${name}çš„èŠå¤©ã€‘
<shouji>
</shouji>`;
Â  Â  Â  Â  Â  Â  triggerSlash(message);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // å¦‚æœtriggerSlashä¸å¯ç”¨ï¼Œæ˜¾ç¤ºæ¶ˆæ¯å†…å®¹
Â  Â  Â  Â  Â  if (type === 'group') {
Â  Â  Â  Â  Â  Â  console.log(`<ç¾¤æˆå‘˜ï¼š${members}>
ã€å’Œ${name}çš„èŠå¤©ã€‘
<qunliao>
</qunliao>`);
Â  Â  Â  Â  Â  Â  alert(`ç¾¤èŠæ¶ˆæ¯ï¼š<ç¾¤æˆå‘˜ï¼š${members}>
ã€å’Œ${name}çš„èŠå¤©ã€‘
<qunliao>
</qunliao>`);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.log(`ã€å’Œ${name}çš„èŠå¤©ã€‘
<shouji>
</shouji>`);
Â  Â  Â  Â  Â  Â  alert(`å¥½å‹æ¶ˆæ¯ï¼šã€å’Œ${name}çš„èŠå¤©ã€‘
<shouji>
</shouji>`);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
Â  Â  Â  document.getElementById('addModal').addEventListener('click', function (e) {
Â  Â  Â  Â  if (e.target === this) {
Â  Â  Â  Â  Â  closeAddModal();
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // å›è½¦é”®æ·»åŠ å¥½å‹
Â  Â  Â  document.getElementById('friendName').addEventListener('keypress', function (e) {
Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  addFriend();
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // å›è½¦é”®æ·»åŠ ç¾¤èŠï¼ˆç¾¤èŠåç§°è¾“å…¥æ¡†ï¼‰
Â  Â  Â  document.getElementById('groupName').addEventListener('keypress', function (e) {
Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  document.getElementById('groupMembers').focus();
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  // åˆ‡æ¢ç½®é¡¶çŠ¶æ€
Â  Â  Â  function togglePin(index) {
Â  Â  Â  Â  // ä½¿ç”¨è§’è‰²ä¸“ç”¨å­˜å‚¨åŠ è½½å¥½å‹åˆ—è¡¨
Â  Â  Â  Â  const storageKey = getFriendsStorageKey();
Â  Â  Â  Â  let friends = [];
Â  Â  Â  Â  if (typeof parent !== 'undefined' && parent.extension_settings) {
Â  Â  Â  Â  Â  friends = parent.extension_settings[storageKey] || [];
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
Â  Â  Â  Â  }

Â  Â  Â  Â  friends[index].pinned = !friends[index].pinned;
Â  Â  Â  Â  saveFriends(friends); // ä½¿ç”¨æ–°çš„ä¿å­˜å‡½æ•°
Â  Â  Â  Â  displayFriends(friends);
Â  Â  Â  }

Â  Â  Â  // å¤„ç†ç½®é¡¶æŒ‰é’®ç‚¹å‡»
Â  Â  Â  function handlePinClick(event, index) {
Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  event.stopImmediatePropagation();

Â  Â  Â  Â  console.log('ç½®é¡¶æŒ‰é’®è¢«ç‚¹å‡»ï¼Œç´¢å¼•:', index);
Â  Â  Â  Â  togglePin(index);
Â  Â  Â  }

Â  Â  Â  // å¤„ç†åˆ é™¤æŒ‰é’®ç‚¹å‡»
Â  Â  Â  function handleDeleteClick(event, index) {
Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  event.stopImmediatePropagation();

Â  Â  Â  Â  console.log('åˆ é™¤æŒ‰é’®è¢«ç‚¹å‡»ï¼Œç´¢å¼•:', index);
Â  Â  Â  Â  deleteFriend(index);
Â  Â  Â  }

Â  Â  Â  // åˆ é™¤å¥½å‹ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
Â  Â  Â  function deleteFriend(index) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  // è·å–å½“å‰å¥½å‹åˆ—è¡¨
Â  Â  Â  Â  Â  const storageKey = getFriendsStorageKey();
Â  Â  Â  Â  Â  let friends = [];
Â  Â  Â  Â  Â  if (typeof parent !== 'undefined' && parent.extension_settings) {
Â  Â  Â  Â  Â  Â  friends = parent.extension_settings[storageKey] || [];
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // æ£€æŸ¥ç´¢å¼•æ˜¯å¦æœ‰æ•ˆ
Â  Â  Â  Â  Â  if (index < 0 || index >= friends.length) {
Â  Â  Â  Â  Â  Â  console.error('åˆ é™¤å¤±è´¥ï¼šæ— æ•ˆçš„ç´¢å¼•', index);
Â  Â  Â  Â  Â  Â  alert('åˆ é™¤å¤±è´¥ï¼šå¥½å‹ä¸å­˜åœ¨');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const friendToDelete = friends[index];
Â  Â  Â  Â  Â  const charInfo = getCurrentCharacterInfo();

Â  Â  Â  Â  Â  // ç¡®è®¤åˆ é™¤
Â  Â  Â  Â  Â  const confirmMessage = `ç¡®å®šè¦åˆ é™¤${friendToDelete.type === 'group' ? 'ç¾¤èŠ' : 'å¥½å‹'} "${
Â  Â  Â  Â  Â  Â  friendToDelete.name
Â  Â  Â  Â  Â  }" å—ï¼Ÿ\n\nè¿™å°†ä» "${charInfo.name}" çš„å¥½å‹åˆ—è¡¨ä¸­æ°¸ä¹…ç§»é™¤ã€‚`;

Â  Â  Â  Â  Â  if (confirm(confirmMessage)) {
Â  Â  Â  Â  Â  Â  console.log(`åˆ é™¤${friendToDelete.type === 'group' ? 'ç¾¤èŠ' : 'å¥½å‹'}:`, friendToDelete.name);

Â  Â  Â  Â  Â  Â  // ä»æ•°ç»„ä¸­åˆ é™¤
Â  Â  Â  Â  Â  Â  friends.splice(index, 1);

Â  Â  Â  Â  Â  Â  // ä¿å­˜æ›´æ–°åçš„åˆ—è¡¨
Â  Â  Â  Â  Â  Â  saveFriends(friends);

Â  Â  Â  Â  Â  Â  // é‡æ–°æ˜¾ç¤ºåˆ—è¡¨
Â  Â  Â  Â  Â  Â  displayFriends(friends);

Â  Â  Â  Â  Â  Â  // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
Â  Â  Â  Â  Â  Â  alert(
Â  Â  Â  Â  Â  Â  Â  `å·²ä» "${charInfo.name}" çš„å¥½å‹åˆ—è¡¨ä¸­åˆ é™¤${friendToDelete.type === 'group' ? 'ç¾¤èŠ' : 'å¥½å‹'} "${
Â  Â  Â  Â  Â  Â  Â  Â  friendToDelete.name
Â  Â  Â  Â  Â  Â  Â  }"`,
Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  console.log('åˆ é™¤æˆåŠŸï¼Œå‰©ä½™å¥½å‹æ•°é‡:', friends.length);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error('åˆ é™¤å¥½å‹æ—¶å‘ç”Ÿé”™è¯¯:', error);
Â  Â  Â  Â  Â  alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // è§’è‰²åˆ‡æ¢æ£€æµ‹ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
Â  Â  Â  let currentCharacterId = null;
Â  Â  Â  let lastCheckTime = 0;

Â  Â  Â  function checkCharacterChange() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  Â  // é¿å…è¿‡äºé¢‘ç¹çš„æ£€æŸ¥
Â  Â  Â  Â  Â  if (now - lastCheckTime < 1000) return;
Â  Â  Â  Â  Â  lastCheckTime = now;

Â  Â  Â  Â  Â  const charInfo = getCurrentCharacterInfo();
Â  Â  Â  Â  Â  const newCharId = charInfo.id;

Â  Â  Â  Â  Â  if (currentCharacterId !== newCharId) {
Â  Â  Â  Â  Â  Â  console.log(`ğŸ”„ è§’è‰²åˆ‡æ¢æ£€æµ‹: "${currentCharacterId}" -> "${newCharId}"`);
Â  Â  Â  Â  Â  Â  console.log('æ–°è§’è‰²ä¿¡æ¯:', charInfo);

Â  Â  Â  Â  Â  Â  currentCharacterId = newCharId;
Â  Â  Â  Â  Â  Â  saveCurrentCharacterId(); // ä¿å­˜æ–°çš„è§’è‰²ID

Â  Â  Â  Â  Â  Â  // é‡æ–°åŠ è½½å¥½å‹åˆ—è¡¨
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  loadFriends();
Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error('è§’è‰²åˆ‡æ¢æ£€æµ‹å¤±è´¥:', error);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // å®šæœŸæ£€æŸ¥è§’è‰²æ˜¯å¦åˆ‡æ¢ï¼ˆæ¯1.5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
Â  Â  Â  setInterval(checkCharacterChange, 1500);

Â  Â  Â  // ç›‘å¬SillyTavernçš„å„ç§è§’è‰²åˆ‡æ¢äº‹ä»¶
Â  Â  Â  if (typeof parent !== 'undefined') {
Â  Â  Â  Â  // æ–¹æ³•1: ç›‘å¬eventSourceäº‹ä»¶
Â  Â  Â  Â  if (parent.eventSource && typeof parent.eventSource.on === 'function') {
Â  Â  Â  Â  Â  parent.eventSource.on('character_selected', () => {
Â  Â  Â  Â  Â  Â  console.log('ğŸ“¡ æ”¶åˆ°character_selectedäº‹ä»¶');
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  checkCharacterChange();
Â  Â  Â  Â  Â  Â  Â  loadFriends();
Â  Â  Â  Â  Â  Â  }, 200);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // æ–¹æ³•2: ç›‘å¬DOMå˜åŒ–ï¼ˆè§’è‰²åç§°å˜åŒ–ï¼‰
Â  Â  Â  Â  if (parent.document) {
Â  Â  Â  Â  Â  const observer = new MutationObserver(() => {
Â  Â  Â  Â  Â  Â  checkCharacterChange();
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  // è§‚å¯Ÿå¯èƒ½åŒ…å«è§’è‰²ä¿¡æ¯çš„å…ƒç´ 
Â  Â  Â  Â  Â  const targetSelectors = ['#character_name', '.character-name', '#name1'];
Â  Â  Â  Â  Â  targetSelectors.forEach(selector => {
Â  Â  Â  Â  Â  Â  const element = parent.document.querySelector(selector);
Â  Â  Â  Â  Â  Â  if (element) {
Â  Â  Â  Â  Â  Â  Â  observer.observe(element, { childList: true, subtree: true, characterData: true });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // æ–¹æ³•3: ç›‘å¬this_chidå˜åŒ–
Â  Â  Â  Â  let lastThisChid = parent.this_chid;
Â  Â  Â  Â  setInterval(() => {
Â  Â  Â  Â  Â  if (parent.this_chid !== lastThisChid) {
Â  Â  Â  Â  Â  Â  console.log('ğŸ“¡ æ£€æµ‹åˆ°this_chidå˜åŒ–:', lastThisChid, '->', parent.this_chid);
Â  Â  Â  Â  Â  Â  lastThisChid = parent.this_chid;
Â  Â  Â  Â  Â  Â  checkCharacterChange();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 500);
Â  Â  Â  }

Â  Â  Â  // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
Â  Â  Â  function showDebugInfo() {
Â  Â  Â  Â  const charInfo = getCurrentCharacterInfo();
Â  Â  Â  Â  const storageKey = getFriendsStorageKey();

Â  Â  Â  Â  let friends = [];
Â  Â  Â  Â  let storageSource = '';

Â  Â  Â  Â  if (typeof parent !== 'undefined' && parent.extension_settings) {
Â  Â  Â  Â  Â  friends = parent.extension_settings[storageKey] || [];
Â  Â  Â  Â  Â  storageSource = 'SillyTavern extension_settings';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
Â  Â  Â  Â  Â  storageSource = 'localStorage';
Â  Â  Â  Â  }

Â  Â  Â  Â  const oldFriends = JSON.parse(localStorage.getItem('friendsList') || '[]');

Â  Â  Â  Â  // è·å–SillyTavernçš„è¯¦ç»†ä¿¡æ¯
Â  Â  Â  Â  let sillyTavernInfo = 'æœªè¿æ¥åˆ°SillyTavern';
Â  Â  Â  Â  if (typeof parent !== 'undefined') {
Â  Â  Â  Â  Â  sillyTavernInfo = `
â€¢ this_chid: ${parent.this_chid}
â€¢ name1: ${parent.name1 || 'æœªè®¾ç½®'}
â€¢ charactersæ•°é‡: ${parent.characters ? Object.keys(parent.characters).length : 0}
â€¢ extension_settingså¯ç”¨: ${parent.extension_settings ? 'æ˜¯' : 'å¦'}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  const debugInfo = `
=== å¥½å‹åˆ—è¡¨è°ƒè¯•ä¿¡æ¯ ===

å½“å‰è§’è‰²ä¿¡æ¯:
â€¢ ID: ${charInfo.id}
â€¢ åç§°: ${charInfo.name}
â€¢ æ¥æº: ${charInfo.source}

SillyTavernè¿æ¥çŠ¶æ€:
${sillyTavernInfo}

å­˜å‚¨ä¿¡æ¯:
â€¢ å­˜å‚¨é”®: ${storageKey}
â€¢ å­˜å‚¨ä½ç½®: ${storageSource}
â€¢ å½“å‰å¥½å‹æ•°é‡: ${friends.length}

è§’è‰²åˆ‡æ¢ç›‘æ§:
â€¢ å½“å‰ç›‘æ§çš„è§’è‰²ID: ${currentCharacterId}
â€¢ æœ€åæ£€æŸ¥æ—¶é—´: ${new Date(lastCheckTime).toLocaleTimeString()}

æ—§ç‰ˆæœ¬æ•°æ®:
â€¢ å…¨å±€å¥½å‹åˆ—è¡¨: ${oldFriends.length} ä¸ªå¥½å‹

å½“å‰è§’è‰²å¥½å‹åˆ—è¡¨:
${
Â  friends.length > 0
Â  Â  ? friends.map((f, i) => `${i + 1}. ${f.name} (${f.type === 'group' ? 'ç¾¤èŠ' : 'å¥½å‹'})`).join('\n')
Â  Â  : '(æ— å¥½å‹)'
}

${
Â  oldFriends.length > 0
Â  Â  ? `\næ—§ç‰ˆæœ¬å¥½å‹åˆ—è¡¨:\n${oldFriends
Â  Â  Â  Â  .map((f, i) => `${i + 1}. ${f.name} (${f.type === 'group' ? 'ç¾¤èŠ' : 'å¥½å‹'})`)
Â  Â  Â  Â  .join('\n')}`
Â  Â  : ''
}

å­˜å‚¨é”®åç¤ºä¾‹:
â€¢ å½“å‰è§’è‰²: ${storageKey}
â€¢ å…¶ä»–è§’è‰²: tavern_friends_sillytavern_chid_123
â€¢ é»˜è®¤è§’è‰²: tavern_friends_default_default
Â  Â  Â  Â  `.trim();

Â  Â  Â  Â  alert(debugInfo);
Â  Â  Â  }

Â  Â  Â  // ==================== å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½ ====================

Â  Â  Â  let selectedImportFile = null;

Â  Â  Â  // æ˜¾ç¤ºå¯¼å…¥/å¯¼å‡ºæ¨¡æ€æ¡†
Â  Â  Â  function showImportExportModal() {
Â  Â  Â  Â  document.getElementById('importExportOverlay').style.display = 'flex';

Â  Â  Â  Â  // é‡ç½®çŠ¶æ€
Â  Â  Â  Â  selectedImportFile = null;
Â  Â  Â  Â  document.getElementById('selectedFileName').textContent = '';
Â  Â  Â  Â  document.getElementById('importBtn').disabled = true;
Â  Â  Â  Â  document.getElementById('jsonPreviewSection').style.display = 'none';

Â  Â  Â  Â  // é‡ç½®å•é€‰æŒ‰é’®
Â  Â  Â  Â  document.querySelector('input[name="importMode"][value="replace"]').checked = true;
Â  Â  Â  }

Â  Â  Â  // å…³é—­å¯¼å…¥/å¯¼å‡ºæ¨¡æ€æ¡†
Â  Â  Â  function closeImportExportModal() {
Â  Â  Â  Â  document.getElementById('importExportOverlay').style.display = 'none';
Â  Â  Â  }

Â  Â  Â  // å¯¼å‡ºå¥½å‹åˆ—è¡¨
Â  Â  Â  function exportFriends() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const charInfo = getCurrentCharacterInfo();
Â  Â  Â  Â  Â  const storageKey = getFriendsStorageKey();

Â  Â  Â  Â  Â  // è·å–å½“å‰å¥½å‹åˆ—è¡¨
Â  Â  Â  Â  Â  let friends = [];
Â  Â  Â  Â  Â  if (typeof parent !== 'undefined' && parent.extension_settings) {
Â  Â  Â  Â  Â  Â  friends = parent.extension_settings[storageKey] || [];
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // åˆ›å»ºå¯¼å‡ºæ•°æ®
Â  Â  Â  Â  Â  const exportData = {
Â  Â  Â  Â  Â  Â  version: '1.0',
Â  Â  Â  Â  Â  Â  exportTime: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  character: {
Â  Â  Â  Â  Â  Â  Â  id: charInfo.id,
Â  Â  Â  Â  Â  Â  Â  name: charInfo.name,
Â  Â  Â  Â  Â  Â  Â  source: charInfo.source,
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  friendsCount: friends.length,
Â  Â  Â  Â  Â  Â  friends: friends,
Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  // åˆ›å»ºJSONå­—ç¬¦ä¸²
Â  Â  Â  Â  Â  const jsonString = JSON.stringify(exportData, null, 2);

Â  Â  Â  Â  Â  // åˆ›å»ºä¸‹è½½é“¾æ¥
Â  Â  Â  Â  Â  const blob = new Blob([jsonString], { type: 'application/json' });
Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);

Â  Â  Â  Â  Â  // ç”Ÿæˆæ–‡ä»¶å
Â  Â  Â  Â  Â  const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
Â  Â  Â  Â  Â  const fileName = `å¥½å‹åˆ—è¡¨_${charInfo.name}_${timestamp}.json`;

Â  Â  Â  Â  Â  // ä¸‹è½½æ–‡ä»¶
Â  Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  Â  a.download = fileName;
Â  Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  Â  a.click();
Â  Â  Â  Â  Â  document.body.removeChild(a);
Â  Â  Â  Â  Â  URL.revokeObjectURL(url);

Â  Â  Â  Â  Â  alert(`âœ… å¯¼å‡ºæˆåŠŸï¼\n\næ–‡ä»¶å: ${fileName}\nå¥½å‹æ•°é‡: ${friends.length}\nè§’è‰²: ${charInfo.name}`);

Â  Â  Â  Â  Â  console.log('å¯¼å‡ºå¥½å‹åˆ—è¡¨æˆåŠŸ:', {
Â  Â  Â  Â  Â  Â  fileName,
Â  Â  Â  Â  Â  Â  friendsCount: friends.length,
Â  Â  Â  Â  Â  Â  character: charInfo.name,
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error('å¯¼å‡ºå¥½å‹åˆ—è¡¨å¤±è´¥:', error);
Â  Â  Â  Â  Â  alert('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // å¤„ç†æ–‡ä»¶é€‰æ‹©
Â  Â  Â  function handleFileSelect(event) {
Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  if (!file) {
Â  Â  Â  Â  Â  selectedImportFile = null;
Â  Â  Â  Â  Â  document.getElementById('selectedFileName').textContent = '';
Â  Â  Â  Â  Â  document.getElementById('importBtn').disabled = true;
Â  Â  Â  Â  Â  document.getElementById('jsonPreviewSection').style.display = 'none';
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (!file.name.toLowerCase().endsWith('.json')) {
Â  Â  Â  Â  Â  alert('è¯·é€‰æ‹©JSONæ ¼å¼çš„æ–‡ä»¶');
Â  Â  Â  Â  Â  event.target.value = '';
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  selectedImportFile = file;
Â  Â  Â  Â  document.getElementById('selectedFileName').textContent = file.name;
Â  Â  Â  Â  document.getElementById('importBtn').disabled = false;

Â  Â  Â  Â  // è¯»å–å¹¶é¢„è§ˆæ–‡ä»¶å†…å®¹
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = function (e) {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const jsonData = JSON.parse(e.target.result);
Â  Â  Â  Â  Â  Â  document.getElementById('jsonPreview').value = JSON.stringify(jsonData, null, 2);
Â  Â  Â  Â  Â  Â  document.getElementById('jsonPreviewSection').style.display = 'block';
Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('JSONè§£æå¤±è´¥:', error);
Â  Â  Â  Â  Â  Â  document.getElementById('jsonPreview').value = 'æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæ— æ³•é¢„è§ˆ';
Â  Â  Â  Â  Â  Â  document.getElementById('jsonPreviewSection').style.display = 'block';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsText(file);
Â  Â  Â  }

Â  Â  Â  // å¯¼å…¥å¥½å‹åˆ—è¡¨
Â  Â  Â  function importFriends() {
Â  Â  Â  Â  if (!selectedImportFile) {
Â  Â  Â  Â  Â  alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥çš„JSONæ–‡ä»¶');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = function (e) {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // è§£æJSONæ•°æ®
Â  Â  Â  Â  Â  Â  const importData = JSON.parse(e.target.result);

Â  Â  Â  Â  Â  Â  // éªŒè¯æ•°æ®æ ¼å¼
Â  Â  Â  Â  Â  Â  if (!validateImportData(importData)) {
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const importFriends = importData.friends || [];
Â  Â  Â  Â  Â  Â  if (importFriends.length === 0) {
Â  Â  Â  Â  Â  Â  Â  alert('âŒ å¯¼å…¥å¤±è´¥: æ–‡ä»¶ä¸­æ²¡æœ‰å¥½å‹æ•°æ®');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // è·å–å¯¼å…¥æ¨¡å¼
Â  Â  Â  Â  Â  Â  const importMode = document.querySelector('input[name="importMode"]:checked').value;
Â  Â  Â  Â  Â  Â  const charInfo = getCurrentCharacterInfo();

Â  Â  Â  Â  Â  Â  // è·å–å½“å‰å¥½å‹åˆ—è¡¨
Â  Â  Â  Â  Â  Â  const storageKey = getFriendsStorageKey();
Â  Â  Â  Â  Â  Â  let currentFriends = [];
Â  Â  Â  Â  Â  Â  if (typeof parent !== 'undefined' && parent.extension_settings) {
Â  Â  Â  Â  Â  Â  Â  currentFriends = parent.extension_settings[storageKey] || [];
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  currentFriends = JSON.parse(localStorage.getItem(storageKey) || '[]');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let finalFriends = [];
Â  Â  Â  Â  Â  Â  let importedCount = 0;
Â  Â  Â  Â  Â  Â  let skippedCount = 0;

Â  Â  Â  Â  Â  Â  if (importMode === 'replace') {
Â  Â  Â  Â  Â  Â  Â  // æ›¿æ¢æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨å¯¼å…¥çš„å¥½å‹åˆ—è¡¨
Â  Â  Â  Â  Â  Â  Â  finalFriends = importFriends.map(friend => ({
Â  Â  Â  Â  Â  Â  Â  Â  ...friend,
Â  Â  Â  Â  Â  Â  Â  Â  addTime: friend.addTime || new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  importedCount = finalFriends.length;
Â  Â  Â  Â  Â  Â  } else if (importMode === 'merge') {
Â  Â  Â  Â  Â  Â  Â  // åˆå¹¶æ¨¡å¼ï¼šåˆå¹¶åˆ°ç°æœ‰åˆ—è¡¨ï¼Œè·³è¿‡é‡å¤
Â  Â  Â  Â  Â  Â  Â  finalFriends = [...currentFriends];

Â  Â  Â  Â  Â  Â  Â  for (const importFriend of importFriends) {
Â  Â  Â  Â  Â  Â  Â  Â  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆæŒ‰åç§°å’Œç±»å‹ï¼‰
Â  Â  Â  Â  Â  Â  Â  Â  const exists = finalFriends.some(
Â  Â  Â  Â  Â  Â  Â  Â  Â  existing => existing.name === importFriend.name && existing.type === importFriend.type,
Â  Â  Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  Â  Â  if (!exists) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  finalFriends.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...importFriend,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addTime: importFriend.addTime || new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  importedCount++;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  skippedCount++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // ä¿å­˜æ›´æ–°åçš„å¥½å‹åˆ—è¡¨
Â  Â  Â  Â  Â  Â  saveFriends(finalFriends);

Â  Â  Â  Â  Â  Â  // åˆ·æ–°æ˜¾ç¤º
Â  Â  Â  Â  Â  Â  displayFriends(finalFriends);

Â  Â  Â  Â  Â  Â  // å…³é—­æ¨¡æ€æ¡†
Â  Â  Â  Â  Â  Â  closeImportExportModal();

Â  Â  Â  Â  Â  Â  // æ˜¾ç¤ºå¯¼å…¥ç»“æœ
Â  Â  Â  Â  Â  Â  let resultMessage = `âœ… å¯¼å…¥å®Œæˆï¼\n\n`;
Â  Â  Â  Â  Â  Â  resultMessage += `è§’è‰²: ${charInfo.name}\n`;
Â  Â  Â  Â  Â  Â  resultMessage += `å¯¼å…¥æ¨¡å¼: ${importMode === 'replace' ? 'æ›¿æ¢' : 'åˆå¹¶'}\n`;
Â  Â  Â  Â  Â  Â  resultMessage += `æˆåŠŸå¯¼å…¥: ${importedCount} ä¸ªå¥½å‹\n`;
Â  Â  Â  Â  Â  Â  if (skippedCount > 0) {
Â  Â  Â  Â  Â  Â  Â  resultMessage += `è·³è¿‡é‡å¤: ${skippedCount} ä¸ªå¥½å‹\n`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  resultMessage += `å½“å‰æ€»æ•°: ${finalFriends.length} ä¸ªå¥½å‹`;

Â  Â  Â  Â  Â  Â  alert(resultMessage);

Â  Â  Â  Â  Â  Â  console.log('å¯¼å…¥å¥½å‹åˆ—è¡¨æˆåŠŸ:', {
Â  Â  Â  Â  Â  Â  Â  importMode,
Â  Â  Â  Â  Â  Â  Â  importedCount,
Â  Â  Â  Â  Â  Â  Â  skippedCount,
Â  Â  Â  Â  Â  Â  Â  totalCount: finalFriends.length,
Â  Â  Â  Â  Â  Â  Â  character: charInfo.name,
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('å¯¼å…¥å¥½å‹åˆ—è¡¨å¤±è´¥:', error);
Â  Â  Â  Â  Â  Â  alert('âŒ å¯¼å…¥å¤±è´¥: ' + error.message);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  reader.readAsText(selectedImportFile);
Â  Â  Â  }

Â  Â  Â  // éªŒè¯å¯¼å…¥æ•°æ®æ ¼å¼
Â  Â  Â  function validateImportData(data) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  // æ£€æŸ¥åŸºæœ¬ç»“æ„
Â  Â  Â  Â  Â  if (!data || typeof data !== 'object') {
Â  Â  Â  Â  Â  Â  alert('âŒ å¯¼å…¥å¤±è´¥: æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // æ£€æŸ¥æ˜¯å¦æœ‰friendsæ•°ç»„
Â  Â  Â  Â  Â  if (!Array.isArray(data.friends)) {
Â  Â  Â  Â  Â  Â  alert('âŒ å¯¼å…¥å¤±è´¥: æ–‡ä»¶ä¸­ç¼ºå°‘å¥½å‹æ•°æ®');
Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // éªŒè¯æ¯ä¸ªå¥½å‹çš„æ•°æ®æ ¼å¼
Â  Â  Â  Â  Â  for (let i = 0; i < data.friends.length; i++) {
Â  Â  Â  Â  Â  Â  const friend = data.friends[i];

Â  Â  Â  Â  Â  Â  if (!friend.name || typeof friend.name !== 'string') {
Â  Â  Â  Â  Â  Â  Â  alert(`âŒ å¯¼å…¥å¤±è´¥: ç¬¬${i + 1}ä¸ªå¥½å‹ç¼ºå°‘æœ‰æ•ˆçš„åç§°`);
Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!friend.type || !['friend', 'group'].includes(friend.type)) {
Â  Â  Â  Â  Â  Â  Â  alert(`âŒ å¯¼å…¥å¤±è´¥: ç¬¬${i + 1}ä¸ªå¥½å‹çš„ç±»å‹æ— æ•ˆ`);
Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // æ˜¾ç¤ºå¯¼å…¥é¢„è§ˆä¿¡æ¯
Â  Â  Â  Â  Â  const friendCount = data.friends.filter(f => f.type === 'friend').length;
Â  Â  Â  Â  Â  const groupCount = data.friends.filter(f => f.type === 'group').length;

Â  Â  Â  Â  Â  const previewMessage =
Â  Â  Â  Â  Â  Â  `ğŸ“‹ å¯¼å…¥é¢„è§ˆ\n\n` +
Â  Â  Â  Â  Â  Â  `æ–‡ä»¶ç‰ˆæœ¬: ${data.version || 'æœªçŸ¥'}\n` +
Â  Â  Â  Â  Â  Â  `å¯¼å‡ºæ—¶é—´: ${data.exportTime ? new Date(data.exportTime).toLocaleString('zh-CN') : 'æœªçŸ¥'}\n` +
Â  Â  Â  Â  Â  Â  `åŸè§’è‰²: ${data.character?.name || 'æœªçŸ¥'}\n` +
Â  Â  Â  Â  Â  Â  `å¥½å‹æ•°é‡: ${friendCount} ä¸ª\n` +
Â  Â  Â  Â  Â  Â  `ç¾¤èŠæ•°é‡: ${groupCount} ä¸ª\n` +
Â  Â  Â  Â  Â  Â  `æ€»è®¡: ${data.friends.length} ä¸ª\n\n` +
Â  Â  Â  Â  Â  Â  `ç¡®å®šè¦å¯¼å…¥è¿™äº›æ•°æ®å—ï¼Ÿ`;

Â  Â  Â  Â  Â  return confirm(previewMessage);
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error('éªŒè¯å¯¼å…¥æ•°æ®å¤±è´¥:', error);
Â  Â  Â  Â  Â  alert('âŒ å¯¼å…¥å¤±è´¥: æ•°æ®éªŒè¯å‡ºé”™');
Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
Â  Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  console.log('ğŸš€ å¥½å‹åˆ—è¡¨é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

Â  Â  Â  Â  // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿SillyTavernå®Œå…¨åŠ è½½
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  const charInfo = getCurrentCharacterInfo();
Â  Â  Â  Â  Â  console.log('ğŸ“‹ åˆå§‹åŒ–è§’è‰²ä¿¡æ¯:', charInfo);

Â  Â  Â  Â  Â  currentCharacterId = charInfo.id;
Â  Â  Â  Â  Â  saveCurrentCharacterId();

Â  Â  Â  Â  Â  // åŠ è½½å¥½å‹åˆ—è¡¨
Â  Â  Â  Â  Â  loadFriends();

Â  Â  Â  Â  Â  // å¼€å§‹è§’è‰²åˆ‡æ¢ç›‘æ§
Â  Â  Â  Â  Â  console.log('ğŸ” å¼€å§‹è§’è‰²åˆ‡æ¢ç›‘æ§...');
Â  Â  Â  Â  }, 500);
Â  Â  Â  });

Â  Â  Â  // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶é‡æ–°æ£€æŸ¥è§’è‰²
Â  Â  Â  document.addEventListener('visibilitychange', () => {
Â  Â  Â  Â  if (!document.hidden) {
Â  Â  Â  Â  Â  console.log('ğŸ“± é¡µé¢é‡æ–°å¯è§ï¼Œæ£€æŸ¥è§’è‰²æ˜¯å¦åˆ‡æ¢...');
Â  Â  Â  Â  Â  setTimeout(checkCharacterChange, 100);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  </script>
Â  </body>
</html>
