<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¥½å‹åˆ—è¡¨</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Ma+Shan+Zheng&display=swap');

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #f5f3e8;
        min-height: 100vh;
        font-family: 'Noto Sans JP', 'Microsoft YaHei', sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      /* å¤–æ¡†åŒ…è£¹å±‚ */
      .phone-shell {
        padding: 18px; /* å£³åšåº¦ */
        background: #e8d5a3; /* ç±³é»„è‰²å¤–å£³ */
        border-radius: 48px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        display: inline-block;
      }

      .container {
        width: 255px; /* æ‰‹æœºå®½åº¦ */
        height: 650px; /* æ‰‹æœºé«˜åº¦ */
        background: #ffffff; /* æœºèº«æœ¬ä½“çº¯ç™½ */
        border-radius: 38px;
        box-shadow: inset 0 0 0 2px #d4c294; /* å†…æè¾¹ï¼Œå‘¼åº”å¤–å£³ */
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: fadeInUp 0.8s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .status-bar {
        height: 36px;
        background: #f7f5e8;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        font-size: 13px;
        color: #8b7355;
        box-shadow: 0 1px 0 #e7e5d8;
      }

      .header {
        background: linear-gradient(135deg, #d4c294 0%, #c9b882 100%);
        color: #8b7355;
        padding: 25px;
        position: relative;
        text-align: center;
        border-bottom: 1px solid rgba(139, 115, 85, 0.2);
      }

      .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .header h1 {
        font-family: 'Ma Shan Zheng', cursive;
        font-size: clamp(24px, 4vw, 28px);
        font-weight: 700;
        letter-spacing: 2px;
        text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 20px rgba(212, 194, 148, 0.5);
        animation: glow 2s ease-in-out infinite alternate;
        position: relative;
        z-index: 1;
      }

      @keyframes glow {
        from {
          text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 20px rgba(212, 194, 148, 0.5);
        }
        to {
          text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 30px rgba(212, 194, 148, 0.7);
        }
      }

      .add-btn {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(212, 194, 148, 0.3);
        border: 1px solid rgba(212, 194, 148, 0.5);
        color: #8b7355;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        z-index: 2;
      }

      .add-btn:hover {
        background: rgba(212, 194, 148, 0.5);
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 15px rgba(212, 194, 148, 0.4);
      }

      .friends-list {
        padding: 20px;
        background: #faf9f4;
        flex: 1;
        overflow-y: auto;
        max-height: calc(650px - 36px - 95px); /* å‡å»çŠ¶æ€æ å’Œheaderé«˜åº¦ */
      }

      /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
      .friends-list::-webkit-scrollbar {
        width: 6px;
      }

      .friends-list::-webkit-scrollbar-track {
        background: rgba(212, 194, 148, 0.1);
        border-radius: 3px;
      }

      .friends-list::-webkit-scrollbar-thumb {
        background: rgba(212, 194, 148, 0.4);
        border-radius: 3px;
      }

      .friends-list::-webkit-scrollbar-thumb:hover {
        background: rgba(212, 194, 148, 0.6);
      }

      .friend-item {
        display: flex;
        align-items: center;
        padding: 18px;
        margin-bottom: 12px;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #ffffff;
        border: 1px solid rgba(212, 194, 148, 0.2);
        box-shadow: 0 2px 8px rgba(212, 194, 148, 0.1);
        position: relative;
        overflow: hidden;
      }

      .friend-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(212, 194, 148, 0.1), transparent);
        transition: left 0.5s;
      }

      .friend-item:hover::before {
        left: 100%;
      }

      .friend-item:hover {
        background: #f9f7f0;
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 8px 25px rgba(212, 194, 148, 0.2);
        border-color: rgba(212, 194, 148, 0.4);
      }

      .friend-avatar {
        width: 55px;
        height: 55px;
        border-radius: 50%;
        background: linear-gradient(135deg, #d4c294 0%, #c9b882 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #8b7355;
        font-weight: bold;
        margin-right: 18px;
        font-size: 18px;
        text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.2);
        box-shadow: 0 4px 15px rgba(212, 194, 148, 0.3);
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
      }

      .friend-item:hover .friend-avatar {
        transform: scale(1.1) rotate(5deg);
        box-shadow: 0 6px 20px rgba(212, 194, 148, 0.4);
      }

      .friend-info {
        flex: 1;
        position: relative;
        z-index: 1;
      }

      .friend-name {
        font-size: 17px;
        font-weight: 500;
        color: #8b7355;
        margin-bottom: 6px;
        text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.1);
        letter-spacing: 0.5px;
      }

      .friend-type {
        font-size: 13px;
        color: rgba(139, 115, 85, 0.7);
        font-weight: 300;
      }

      .group-badge {
        background: rgba(212, 194, 148, 0.8);
        color: #8b7355;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        margin-left: 10px;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(212, 194, 148, 0.5);
        font-weight: 400;
        text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.1);
      }

      .pinned-badge {
        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        color: white;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 10px;
        margin-left: 8px;
        font-weight: 500;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
      }

      .friend-item.pinned {
        background: linear-gradient(135deg, #fff9e6, #fff5d6);
        border-color: rgba(255, 193, 7, 0.3);
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
      }

      .friend-item.pinned:hover {
        background: linear-gradient(135deg, #fff7e0, #fff2cc);
        border-color: rgba(255, 193, 7, 0.5);
      }

      .friend-actions {
        display: flex;
        gap: 8px;
        margin-left: auto;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .friend-item:hover .friend-actions {
        opacity: 1;
      }

      .action-btn {
        width: 28px;
        height: 28px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
      }

      .pin-btn {
        background: rgba(255, 193, 7, 0.8);
        color: white;
      }

      .pin-btn:hover {
        background: rgba(255, 193, 7, 1);
        transform: scale(1.1);
      }

      .pin-btn.pinned {
        background: rgba(255, 107, 107, 0.8);
      }

      .pin-btn.pinned:hover {
        background: rgba(255, 107, 107, 1);
      }

      .delete-btn {
        background: rgba(255, 107, 107, 0.8);
        color: white;
      }

      .delete-btn:hover {
        background: rgba(255, 107, 107, 1);
        transform: scale(1.1);
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
      }

      .modal h2 {
        margin-bottom: 20px;
        color: #333;
        text-align: center;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: 500;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5a6fd8;
      }

      .btn-secondary {
        background: #e9ecef;
        color: #6c757d;
      }

      .btn-secondary:hover {
        background: #dee2e6;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
      }

      /* ==================== å¢å¼ºçš„åŠ¨ç”»æ•ˆæœ ==================== */

      /* ç½®é¡¶åŠ¨ç”»æ•ˆæœ */
      @keyframes pinGlow {
        0% {
          transform: scale(1);
          box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
        }
        50% {
          transform: scale(1.02);
          box-shadow: 0 4px 20px rgba(255, 193, 7, 0.4);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
        }
      }

      .friend-item.pinned {
        animation: pinGlow 0.5s ease-out;
      }

      /* ç½®é¡¶å¾½ç« åŠ¨ç”» */
      @keyframes bounce {
        0%,
        20%,
        50%,
        80%,
        100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-3px);
        }
        60% {
          transform: translateY(-2px);
        }
      }

      .pinned-badge {
        animation: bounce 0.5s ease-out;
      }

      /* Toast æç¤ºåŠ¨ç”» */
      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
        20% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
        80% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
      }

      /* æŒ‰é’®æ‚¬åœæ•ˆæœå¢å¼º */
      .action-btn:hover {
        transform: scale(1.1);
        transition: all 0.2s ease;
      }

      .pin-btn.pinned {
        background: #ffc107;
        color: white;
        box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
      }

      .delete-btn:hover {
        background: #ff7675;
        color: white;
        transform: scale(1.1);
      }

      /* å¥½å‹é¡¹æ‚¬åœæ•ˆæœ */
      .friend-item:hover .friend-actions {
        opacity: 1;
        transform: translateX(0);
      }

      .friend-actions {
        opacity: 0.7;
        transform: translateX(5px);
        transition: all 0.2s ease;
      }
    </style>
  </head>
  <body>
    <div class="phone-shell">
      <div class="container">
        <div class="status-bar">
          <div>9:41</div>
          <div>ğŸ“¶ ğŸ“¶ ğŸ“¶ ğŸ”‹</div>
        </div>
        <div class="header">
          <h1>å¥½å‹åˆ—è¡¨</h1>
          <button class="add-btn" onclick="openAddModal()">+</button>
        </div>

        <div class="friends-list" id="friendsList">
          <div class="empty-state">
            <i>ğŸ‘¥</i>
            <p>æš‚æ— å¥½å‹ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ å¥½å‹æˆ–ç¾¤èŠ</p>
          </div>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ å¥½å‹/ç¾¤èŠæ¨¡æ€æ¡† -->
    <div class="modal" id="addModal">
      <div class="modal-content">
        <!-- ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©ç±»å‹ -->
        <div id="typeSelection">
          <h2>æ·»åŠ å¥½å‹/ç¾¤èŠ</h2>
          <p style="text-align: center; color: #666; margin-bottom: 20px">è¯·é€‰æ‹©è¦æ·»åŠ çš„ç±»å‹</p>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="selectType('friend')">ğŸ‘¤ æ·»åŠ å¥½å‹</button>
            <button class="btn btn-primary" onclick="selectType('group')">ğŸ‘¥ æ·»åŠ ç¾¤èŠ</button>
          </div>
          <div style="text-align: center; margin-top: 15px">
            <button class="btn btn-secondary" onclick="closeAddModal()">å–æ¶ˆ</button>
          </div>
        </div>

        <!-- ç¬¬äºŒæ­¥ï¼šæ·»åŠ å¥½å‹ -->
        <div id="friendForm" style="display: none">
          <h2>æ·»åŠ å¥½å‹</h2>
          <div class="form-group">
            <label for="friendName">å¥½å‹å§“å</label>
            <input type="text" id="friendName" placeholder="è¯·è¾“å…¥å¥½å‹å§“å" />
          </div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="backToTypeSelection()">è¿”å›</button>
            <button class="btn btn-primary" onclick="addFriend()">æ·»åŠ å¥½å‹</button>
          </div>
        </div>

        <!-- ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ ç¾¤èŠ -->
        <div id="groupForm" style="display: none">
          <h2>æ·»åŠ ç¾¤èŠ</h2>
          <div class="form-group">
            <label for="groupName">ç¾¤èŠåç§°</label>
            <input type="text" id="groupName" placeholder="è¯·è¾“å…¥ç¾¤èŠåç§°" />
          </div>
          <div class="form-group">
            <label for="groupMembers">ç¾¤æˆå‘˜</label>
            <textarea id="groupMembers" placeholder="è¯·è¾“å…¥ç¾¤æˆå‘˜ï¼Œç”¨é€—å·éš”å¼€&#10;ä¾‹å¦‚ï¼šå¼ ä¸‰,æå››,ç‹äº”"></textarea>
          </div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="backToTypeSelection()">è¿”å›</button>
            <button class="btn btn-primary" onclick="addGroup()">æ·»åŠ ç¾¤èŠ</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==================== è§’è‰²ä¸“å±å¥½å‹åˆ—è¡¨ç³»ç»Ÿ ====================

      let currentCharacterInfo = null;
      let isCharacterSystemReady = false;

      // è·å–å½“å‰è§’è‰²ä¿¡æ¯
      function getCurrentCharacterInfo() {
        try {
          // å°è¯•ä»SillyTavernè·å–å½“å‰è§’è‰²
          if (typeof parent !== 'undefined' && parent.characters && parent.this_chid !== undefined) {
            const currentChar = parent.characters[parent.this_chid];
            if (currentChar) {
              return {
                id: parent.this_chid,
                name: currentChar.name,
                description: currentChar.description || '',
                personality: currentChar.personality || '',
                scenario: currentChar.scenario || '',
                first_mes: currentChar.first_mes,
                tags: currentChar.tags || [],
                avatar: currentChar.avatar || '',
                filename: currentChar.avatar, // ä½¿ç”¨avatarä½œä¸ºå”¯ä¸€æ ‡è¯†
              };
            }
          }

          // å›é€€æ–¹æ¡ˆï¼šä»localStorageè·å–
          const savedChar = localStorage.getItem('currentCharacter');
          if (savedChar) {
            return JSON.parse(savedChar);
          }

          return null;
        } catch (error) {
          console.error('è·å–è§’è‰²ä¿¡æ¯å¤±è´¥:', error);
          return null;
        }
      }

      // è·å–è§’è‰²ä¸“å±çš„å­˜å‚¨é”®å
      function getCharacterFriendsKey(characterInfo) {
        if (!characterInfo) return 'friendsList'; // é»˜è®¤é”®å

        // ä½¿ç”¨è§’è‰²æ–‡ä»¶åä½œä¸ºå”¯ä¸€æ ‡è¯†
        const charId = characterInfo.filename || characterInfo.name || 'default';
        return `friendsList_${charId}`;
      }

      // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è§’è‰²ä¸“å±å¥½å‹åˆ—è¡¨
      function loadFriends() {
        currentCharacterInfo = getCurrentCharacterInfo();
        const storageKey = getCharacterFriendsKey(currentCharacterInfo);
        const friends = JSON.parse(localStorage.getItem(storageKey) || '[]');

        console.log('åŠ è½½å¥½å‹åˆ—è¡¨:', {
          character: currentCharacterInfo?.name || 'æœªçŸ¥è§’è‰²',
          storageKey: storageKey,
          friendsCount: friends.length,
        });

        displayFriends(friends);
        updateCharacterDisplay();
      }

      // ä¿å­˜è§’è‰²ä¸“å±å¥½å‹åˆ—è¡¨
      function saveFriends(friends) {
        const storageKey = getCharacterFriendsKey(currentCharacterInfo);
        localStorage.setItem(storageKey, JSON.stringify(friends));

        console.log('ä¿å­˜å¥½å‹åˆ—è¡¨:', {
          character: currentCharacterInfo?.name || 'æœªçŸ¥è§’è‰²',
          storageKey: storageKey,
          friendsCount: friends.length,
        });
      }

      // æ›´æ–°è§’è‰²æ˜¾ç¤ºä¿¡æ¯
      function updateCharacterDisplay() {
        const headerTitle = document.querySelector('.header h1');
        if (currentCharacterInfo && headerTitle) {
          headerTitle.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
              <span>${currentCharacterInfo.name}</span>
              <span style="font-size: 14px; opacity: 0.7;">çš„å¥½å‹</span>
            </div>
          `;

          // æ·»åŠ è§’è‰²ä¿¡æ¯å¡ç‰‡
          addCharacterInfoCard();
        } else if (headerTitle) {
          headerTitle.textContent = 'å¥½å‹åˆ—è¡¨';
        }
      }

      // æ·»åŠ è§’è‰²ä¿¡æ¯å¡ç‰‡
      function addCharacterInfoCard() {
        const friendsList = document.getElementById('friendsList');
        const existingCard = friendsList.querySelector('.character-info-card');

        if (existingCard) {
          existingCard.remove();
        }

        if (!currentCharacterInfo) return;

        const cardHtml = `
          <div class="character-info-card" style="
            margin: 0 0 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
          ">
            <div style="display: flex; align-items: center; gap: 12px;">
              ${
                currentCharacterInfo.avatar
                  ? `
                <img src="${currentCharacterInfo.avatar}" style="
                  width: 40px;
                  height: 40px;
                  border-radius: 50%;
                  object-fit: cover;
                  border: 2px solid rgba(255,255,255,0.3);
                " alt="${currentCharacterInfo.name}">
              `
                  : `
                <div style="
                  width: 40px;
                  height: 40px;
                  border-radius: 50%;
                  background: rgba(255,255,255,0.2);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 18px;
                ">ğŸ‘¤</div>
              `
              }
              <div style="flex: 1;">
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">
                  ${currentCharacterInfo.name}
                </div>
                <div style="font-size: 12px; opacity: 0.9; line-height: 1.3;">
                  ${
                    currentCharacterInfo.description
                      ? currentCharacterInfo.description.length > 60
                        ? currentCharacterInfo.description.substring(0, 60) + '...'
                        : currentCharacterInfo.description
                      : 'è¿™ä¸ªè§’è‰²è¿˜æ²¡æœ‰æè¿°'
                  }
                </div>
              </div>
            </div>
          </div>
        `;

        friendsList.insertAdjacentHTML('afterbegin', cardHtml);
      }

      // æ˜¾ç¤ºå¥½å‹åˆ—è¡¨
      function displayFriends(friends) {
        const friendsList = document.getElementById('friendsList');

        if (friends.length === 0) {
          friendsList.innerHTML = `
                    <div class="empty-state">
                        <i>ğŸ‘¥</i>
                        <p>${currentCharacterInfo ? `${currentCharacterInfo.name} è¿˜æ²¡æœ‰å¥½å‹` : 'æš‚æ— å¥½å‹'}</p>
                        <p style="font-size: 14px; opacity: 0.7; margin-top: 8px;">ç‚¹å‡»å³ä¸Šè§’æ·»åŠ å¥½å‹æˆ–ç¾¤èŠ</p>
                    </div>
                `;

          // å³ä½¿æ²¡æœ‰å¥½å‹ä¹Ÿæ˜¾ç¤ºæ¨è
          setTimeout(() => {
            if (currentCharacterInfo) {
              showRecommendations();
            }
          }, 100);
          return;
        }

        // å…ˆæ’åºï¼šç½®é¡¶çš„åœ¨å‰é¢ï¼Œç„¶åæŒ‰æ·»åŠ æ—¶é—´æ’åº
        const sortedFriends = [...friends].sort((a, b) => {
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          if (a.pinned && b.pinned) {
            return new Date(b.pinnedTime || b.addTime) - new Date(a.pinnedTime || a.addTime);
          }
          return new Date(b.addTime) - new Date(a.addTime);
        });

        friendsList.innerHTML = sortedFriends
          .map((friend, displayIndex) => {
            // æ‰¾åˆ°åŸå§‹æ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œç”¨äºåˆ é™¤å’Œç½®é¡¶æ“ä½œ
            const originalIndex = friends.findIndex(f => f.name === friend.name && f.addTime === friend.addTime);

            return `
                <div class="friend-item ${friend.pinned ? 'pinned' : ''}" onclick="startChat('${friend.name}', '${
              friend.type
            }', '${friend.members || ''}')">
                    <div class="friend-avatar">
                        ${friend.type === 'group' ? 'ğŸ‘¥' : friend.name.charAt(0)}
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">
                            ${friend.name}
                            ${friend.type === 'group' ? '<span class="group-badge">ç¾¤èŠ</span>' : ''}
                            ${friend.pinned ? '<span class="pinned-badge">ğŸ“Œ</span>' : ''}
                        </div>
                        <div class="friend-type">
                            ${friend.type === 'group' ? `æˆå‘˜: ${friend.members}` : 'å¥½å‹'}
                        </div>
                    </div>
                    <div class="friend-actions">
                        <button class="action-btn pin-btn ${friend.pinned ? 'pinned' : ''}"
                                onclick="event.stopPropagation(); togglePin(${originalIndex})"
                                title="${friend.pinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}">
                            ${friend.pinned ? 'ğŸ“Œ' : 'ğŸ“'}
                        </button>
                        <button class="action-btn delete-btn"
                                onclick="event.stopPropagation(); deleteFriend(${originalIndex})"
                                title="åˆ é™¤">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `;
          })
          .join('');
      }

      // æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
      function openAddModal() {
        document.getElementById('addModal').style.display = 'block';
        showTypeSelection();
      }

      // å…³é—­æ·»åŠ æ¨¡æ€æ¡†
      function closeAddModal() {
        document.getElementById('addModal').style.display = 'none';
        resetForms();
      }

      // æ˜¾ç¤ºç±»å‹é€‰æ‹©ç•Œé¢
      function showTypeSelection() {
        document.getElementById('typeSelection').style.display = 'block';
        document.getElementById('friendForm').style.display = 'none';
        document.getElementById('groupForm').style.display = 'none';
      }

      // é€‰æ‹©ç±»å‹ï¼ˆå¥½å‹æˆ–ç¾¤èŠï¼‰
      function selectType(type) {
        document.getElementById('typeSelection').style.display = 'none';

        if (type === 'friend') {
          document.getElementById('friendForm').style.display = 'block';
          document.getElementById('friendName').focus();
        } else if (type === 'group') {
          document.getElementById('groupForm').style.display = 'block';
          document.getElementById('groupName').focus();
        }
      }

      // è¿”å›ç±»å‹é€‰æ‹©
      function backToTypeSelection() {
        resetForms();
        showTypeSelection();
      }

      // é‡ç½®è¡¨å•
      function resetForms() {
        document.getElementById('friendName').value = '';
        document.getElementById('groupName').value = '';
        document.getElementById('groupMembers').value = '';
      }

      // æ·»åŠ å¥½å‹
      function addFriend() {
        const name = document.getElementById('friendName').value.trim();

        if (!name) {
          alert('è¯·è¾“å…¥å¥½å‹å§“å');
          return;
        }

        const storageKey = getCharacterFriendsKey(currentCharacterInfo);
        const friends = JSON.parse(localStorage.getItem(storageKey) || '[]');

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        if (friends.some(friend => friend.name === name)) {
          alert('è¯¥å¥½å‹å·²å­˜åœ¨');
          return;
        }

        const newFriend = {
          name: name,
          type: 'friend',
          members: null,
          addTime: new Date().toISOString(),
          characterId: currentCharacterInfo?.filename || 'default', // è®°å½•æ‰€å±è§’è‰²
          characterName: currentCharacterInfo?.name || 'æœªçŸ¥è§’è‰²', // è®°å½•è§’è‰²åç§°
        };

        friends.push(newFriend);
        saveFriends(friends);

        displayFriends(friends);
        closeAddModal();

        alert(`ä¸º ${currentCharacterInfo?.name || 'å½“å‰è§’è‰²'} æ·»åŠ å¥½å‹ "${name}" æˆåŠŸï¼`);
        console.log(`ä¸ºè§’è‰² ${currentCharacterInfo?.name || 'æœªçŸ¥'} æ·»åŠ å¥½å‹: ${name}`);
      }

      // æ·»åŠ ç¾¤èŠ
      function addGroup() {
        const name = document.getElementById('groupName').value.trim();
        const members = document.getElementById('groupMembers').value.trim();

        if (!name) {
          alert('è¯·è¾“å…¥ç¾¤èŠåç§°');
          return;
        }

        if (!members) {
          alert('è¯·è¾“å…¥ç¾¤æˆå‘˜');
          return;
        }

        const storageKey = getCharacterFriendsKey(currentCharacterInfo);
        const friends = JSON.parse(localStorage.getItem(storageKey) || '[]');

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        if (friends.some(friend => friend.name === name)) {
          alert('è¯¥ç¾¤èŠå·²å­˜åœ¨');
          return;
        }

        const newGroup = {
          name: name,
          type: 'group',
          members: members,
          addTime: new Date().toISOString(),
          characterId: currentCharacterInfo?.filename || 'default', // è®°å½•æ‰€å±è§’è‰²
          characterName: currentCharacterInfo?.name || 'æœªçŸ¥è§’è‰²', // è®°å½•è§’è‰²åç§°
        };

        friends.push(newGroup);
        saveFriends(friends);

        displayFriends(friends);
        closeAddModal();

        alert(`ç¾¤èŠ "${name}" æ·»åŠ æˆåŠŸï¼`);
      }

      // å¼€å§‹èŠå¤©
      function startChat(name, type, members) {
        if (typeof triggerSlash === 'function') {
          if (type === 'group') {
            const message = `/send <ç¾¤æˆå‘˜ï¼š${members}>
ã€å’Œ${name}çš„èŠå¤©ã€‘
<qunliao>
</qunliao>`;
            triggerSlash(message);
          } else {
            const message = `/send ã€å’Œ${name}çš„èŠå¤©ã€‘
<shouji>
</shouji>`;
            triggerSlash(message);
          }
        } else {
          // å¦‚æœtriggerSlashä¸å¯ç”¨ï¼Œæ˜¾ç¤ºæ¶ˆæ¯å†…å®¹
          if (type === 'group') {
            console.log(`<ç¾¤æˆå‘˜ï¼š${members}>
ã€å’Œ${name}çš„èŠå¤©ã€‘
<qunliao>
</qunliao>`);
            alert(`ç¾¤èŠæ¶ˆæ¯ï¼š<ç¾¤æˆå‘˜ï¼š${members}>
ã€å’Œ${name}çš„èŠå¤©ã€‘
<qunliao>
</qunliao>`);
          } else {
            console.log(`ã€å’Œ${name}çš„èŠå¤©ã€‘
<shouji>
</shouji>`);
            alert(`å¥½å‹æ¶ˆæ¯ï¼šã€å’Œ${name}çš„èŠå¤©ã€‘
<shouji>
</shouji>`);
          }
        }
      }

      // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
      document.getElementById('addModal').addEventListener('click', function (e) {
        if (e.target === this) {
          closeAddModal();
        }
      });

      // å›è½¦é”®æ·»åŠ å¥½å‹
      document.getElementById('friendName').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          addFriend();
        }
      });

      // å›è½¦é”®æ·»åŠ ç¾¤èŠï¼ˆç¾¤èŠåç§°è¾“å…¥æ¡†ï¼‰
      document.getElementById('groupName').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          document.getElementById('groupMembers').focus();
        }
      });

      // ==================== è§’è‰²åˆ‡æ¢ç›‘å¬å’Œæ™ºèƒ½æ¨è ====================

      // ç›‘å¬SillyTavernçš„è§’è‰²åˆ‡æ¢äº‹ä»¶
      function setupCharacterChangeListener() {
        try {
          if (typeof parent !== 'undefined' && parent.eventSource) {
            // ç›‘å¬èŠå¤©å˜æ›´äº‹ä»¶ï¼ˆåŒ…å«è§’è‰²åˆ‡æ¢ï¼‰
            parent.eventSource.on('CHAT_CHANGED', () => {
              console.log('æ£€æµ‹åˆ°è§’è‰²åˆ‡æ¢ï¼Œé‡æ–°åŠ è½½å¥½å‹åˆ—è¡¨');
              setTimeout(() => {
                loadFriends();
              }, 100);
            });

            // ç›‘å¬è§’è‰²é€‰æ‹©äº‹ä»¶
            parent.eventSource.on('CHARACTER_SELECTED', () => {
              console.log('æ£€æµ‹åˆ°è§’è‰²é€‰æ‹©ï¼Œé‡æ–°åŠ è½½å¥½å‹åˆ—è¡¨');
              setTimeout(() => {
                loadFriends();
              }, 100);
            });

            console.log('âœ… è§’è‰²åˆ‡æ¢ç›‘å¬å™¨è®¾ç½®æˆåŠŸ');
            isCharacterSystemReady = true;
          } else {
            console.warn('âš ï¸ æ— æ³•è®¿é—®SillyTavernäº‹ä»¶ç³»ç»Ÿï¼Œä½¿ç”¨è½®è¯¢æ¨¡å¼');
            setupPollingMode();
          }
        } catch (error) {
          console.error('è®¾ç½®è§’è‰²åˆ‡æ¢ç›‘å¬å™¨å¤±è´¥:', error);
          setupPollingMode();
        }
      }

      // è½®è¯¢æ¨¡å¼ï¼šå®šæœŸæ£€æŸ¥è§’è‰²å˜åŒ–
      function setupPollingMode() {
        let lastCharacterId = null;

        setInterval(() => {
          const currentChar = getCurrentCharacterInfo();
          const currentId = currentChar?.filename || currentChar?.name;

          if (currentId && currentId !== lastCharacterId) {
            console.log('è½®è¯¢æ£€æµ‹åˆ°è§’è‰²å˜åŒ–:', lastCharacterId, '->', currentId);
            lastCharacterId = currentId;
            loadFriends();
          }
        }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
      }

      // æ™ºèƒ½æ¨èå¥½å‹åŠŸèƒ½
      function getRecommendedFriends(characterInfo) {
        if (!characterInfo) return [];

        const recommendations = [];
        const charName = characterInfo.name.toLowerCase();
        const description = (characterInfo.description || '').toLowerCase();
        const personality = (characterInfo.personality || '').toLowerCase();
        const scenario = (characterInfo.scenario || '').toLowerCase();
        const tags = characterInfo.tags || [];

        // åŸºäºè§’è‰²åç§°çš„æ¨è
        if (charName.includes('å“ˆåˆ©') || charName.includes('harry')) {
          recommendations.push(
            { name: 'èµ«æ•Â·æ ¼å…°æ°', reason: 'éœæ ¼æ²ƒèŒ¨åŒå­¦' },
            { name: 'ç½—æ©Â·éŸ¦æ–¯è±', reason: 'æœ€å¥½çš„æœ‹å‹' },
            { name: 'é‚“å¸ƒåˆ©å¤š', reason: 'æ ¡é•¿' },
          );
        } else if (charName.includes('é’¢é“ä¾ ') || charName.includes('æ‰˜å°¼') || charName.includes('stark')) {
          recommendations.push(
            { name: 'ç¾å›½é˜Ÿé•¿', reason: 'å¤ä»‡è€…è”ç›Ÿ' },
            { name: 'é»‘å¯¡å¦‡', reason: 'å¤ä»‡è€…è”ç›Ÿ' },
            { name: 'å°è¾£æ¤’', reason: 'æ‹äºº' },
          );
        } else if (charName.includes('å°çº¢å¸½')) {
          recommendations.push(
            { name: 'å¤§ç°ç‹¼', reason: 'æ•…äº‹è§’è‰²' },
            { name: 'å¥¶å¥¶', reason: 'äº²äºº' },
            { name: 'çŒäºº', reason: 'æ•‘å‘½æ©äºº' },
          );
        }

        // åŸºäºæ ‡ç­¾çš„æ¨è
        if (tags.includes('å­¦ç”Ÿ') || tags.includes('student')) {
          recommendations.push({ name: 'åŒç­åŒå­¦', reason: 'å­¦æ ¡å…³ç³»' }, { name: 'è€å¸ˆ', reason: 'å¸ˆç”Ÿå…³ç³»' });
        }

        if (tags.includes('é­”æ³•') || tags.includes('magic')) {
          recommendations.push({ name: 'é­”æ³•å¯¼å¸ˆ', reason: 'é­”æ³•æŒ‡å¯¼' }, { name: 'é­”æ³•å•†äºº', reason: 'é“å…·è´­ä¹°' });
        }

        // åŸºäºæ€§æ ¼çš„æ¨è
        if (personality.includes('å¼€æœ—') || personality.includes('æ´»æ³¼')) {
          recommendations.push({ name: 'è¿åŠ¨ä¼™ä¼´', reason: 'æ€§æ ¼åŒ¹é…' }, { name: 'èšä¼šæœ‹å‹', reason: 'ç¤¾äº¤éœ€æ±‚' });
        }

        if (personality.includes('å†…å‘') || personality.includes('å®‰é™')) {
          recommendations.push({ name: 'å›¾ä¹¦ç®¡ç†å‘˜', reason: 'å®‰é™ç¯å¢ƒ' }, { name: 'çŸ¥å¿ƒæœ‹å‹', reason: 'æ·±åº¦äº¤æµ' });
        }

        return recommendations.slice(0, 5); // æœ€å¤šè¿”å›5ä¸ªæ¨è
      }

      // æ˜¾ç¤ºæ¨èå¥½å‹
      function showRecommendations() {
        if (!currentCharacterInfo) return;

        const recommendations = getRecommendedFriends(currentCharacterInfo);
        if (recommendations.length === 0) return;

        const friendsList = document.getElementById('friendsList');
        const existingRecommendations = friendsList.querySelector('.recommendations-section');

        if (existingRecommendations) {
          existingRecommendations.remove();
        }

        const recommendationsHtml = `
          <div class="recommendations-section" style="
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
          ">
            <h3 style="margin: 0 0 12px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
              âœ¨ ä¸º ${currentCharacterInfo.name} æ¨èçš„å¥½å‹
            </h3>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              ${recommendations
                .map(
                  rec => `
                <div style="
                  background: rgba(255,255,255,0.1);
                  padding: 8px 12px;
                  border-radius: 8px;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  cursor: pointer;
                  transition: background 0.2s;
                " onclick="quickAddFriend('${rec.name}')">
                  <div>
                    <div style="font-weight: 500;">${rec.name}</div>
                    <div style="font-size: 12px; opacity: 0.8;">${rec.reason}</div>
                  </div>
                  <div style="font-size: 20px;">+</div>
                </div>
              `,
                )
                .join('')}
            </div>
          </div>
        `;

        friendsList.insertAdjacentHTML('afterbegin', recommendationsHtml);
      }

      // å¿«é€Ÿæ·»åŠ æ¨èå¥½å‹
      function quickAddFriend(name) {
        const storageKey = getCharacterFriendsKey(currentCharacterInfo);
        const friends = JSON.parse(localStorage.getItem(storageKey) || '[]');

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        if (friends.some(friend => friend.name === name)) {
          alert('è¯¥å¥½å‹å·²å­˜åœ¨');
          return;
        }

        const newFriend = {
          name: name,
          type: 'friend',
          members: null,
          addTime: new Date().toISOString(),
          characterId: currentCharacterInfo?.filename || 'default',
          characterName: currentCharacterInfo?.name || 'æœªçŸ¥è§’è‰²',
          isRecommended: true, // æ ‡è®°ä¸ºæ¨èæ·»åŠ 
        };

        friends.push(newFriend);
        saveFriends(friends);
        loadFriends(); // é‡æ–°åŠ è½½ä»¥ç§»é™¤æ¨èåŒºåŸŸ

        alert(`ä¸º ${currentCharacterInfo?.name || 'å½“å‰è§’è‰²'} æ·»åŠ æ¨èå¥½å‹ "${name}" æˆåŠŸï¼`);
      }

      // ==================== å¥½å‹ç®¡ç†åŠŸèƒ½ ====================

      // åˆ é™¤å¥½å‹
      function deleteFriend(index) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥½å‹å—ï¼Ÿ')) {
          const storageKey = getCharacterFriendsKey(currentCharacterInfo);
          const friends = JSON.parse(localStorage.getItem(storageKey) || '[]');

          if (index >= 0 && index < friends.length) {
            const deletedFriend = friends[index];
            friends.splice(index, 1);
            saveFriends(friends);
            displayFriends(friends);

            console.log(`åˆ é™¤å¥½å‹: ${deletedFriend.name}`);
            alert(`å·²åˆ é™¤å¥½å‹ "${deletedFriend.name}"`);
          }
        }
      }

      // ç½®é¡¶/å–æ¶ˆç½®é¡¶å¥½å‹
      function togglePin(index) {
        const storageKey = getCharacterFriendsKey(currentCharacterInfo);
        const friends = JSON.parse(localStorage.getItem(storageKey) || '[]');

        if (index >= 0 && index < friends.length) {
          const friend = friends[index];
          const wasPin = friend.pinned;

          friend.pinned = !friend.pinned;
          friend.pinnedTime = friend.pinned ? new Date().toISOString() : null;

          saveFriends(friends);
          displayFriends(friends);

          const action = friend.pinned ? 'ç½®é¡¶' : 'å–æ¶ˆç½®é¡¶';
          console.log(`${action}å¥½å‹: ${friend.name}`);

          // æ˜¾ç¤ºæ“ä½œæç¤º
          const message = friend.pinned ? `"${friend.name}" å·²ç½®é¡¶` : `"${friend.name}" å·²å–æ¶ˆç½®é¡¶`;
          showToast(message);
        }
      }

      // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
      function showToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-size: 14px;
          z-index: 10000;
          animation: fadeInOut 2s ease-in-out;
        `;
        toast.textContent = message;

        document.body.appendChild(toast);

        setTimeout(() => {
          if (toast.parentNode) {
            document.body.removeChild(toast);
          }
        }, 2000);
      }

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.addEventListener('load', () => {
        loadFriends();
        setupCharacterChangeListener();

        // å»¶è¿Ÿæ˜¾ç¤ºæ¨èï¼Œè®©å¥½å‹åˆ—è¡¨å…ˆåŠ è½½
        setTimeout(() => {
          if (currentCharacterInfo) {
            showRecommendations();
          }
        }, 500);
      });
    </script>
  </body>
</html>
