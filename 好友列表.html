<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>好友列表</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Ma+Shan+Zheng&display=swap');

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #f5f3e8;
        min-height: 100vh;
        font-family: 'Noto Sans JP', 'Microsoft YaHei', sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      /* 外框包裹层 */
      .phone-shell {
        padding: 18px; /* 壳厚度 */
        background: #e8d5a3; /* 米黄色外壳 */
        border-radius: 48px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        display: inline-block;
      }

      .container {
        width: 255px; /* 手机宽度 */
        height: 650px; /* 手机高度 */
        background: #ffffff; /* 机身本体纯白 */
        border-radius: 38px;
        box-shadow: inset 0 0 0 2px #d4c294; /* 内描边，呼应外壳 */
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: fadeInUp 0.8s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .status-bar {
        height: 36px;
        background: #f7f5e8;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        font-size: 13px;
        color: #8b7355;
        box-shadow: 0 1px 0 #e7e5d8;
      }

      .header {
        background: linear-gradient(135deg, #d4c294 0%, #c9b882 100%);
        color: #8b7355;
        padding: 25px;
        position: relative;
        text-align: center;
        border-bottom: 1px solid rgba(139, 115, 85, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
        animation: shimmer 3s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .header h1 {
        font-family: 'Ma Shan Zheng', cursive;
        font-size: clamp(24px, 4vw, 28px);
        font-weight: 700;
        letter-spacing: 2px;
        text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 20px rgba(212, 194, 148, 0.5);
        animation: glow 2s ease-in-out infinite alternate;
        position: relative;
        z-index: 1;
        margin: 0;
        flex: 1;
      }

      .header-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        position: relative;
        z-index: 2;
      }

      .settings-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(139, 115, 85, 0.2);
        color: #8b7355;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        position: relative;
        z-index: 2;
      }

      .settings-btn:hover {
        background: rgba(139, 115, 85, 0.3);
        transform: scale(1.05);
      }

      /* 设置菜单样式 */
      .settings-menu {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .settings-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 300px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .settings-header {
        background: linear-gradient(135deg, #d4c294 0%, #c9b882 100%);
        color: #8b7355;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .settings-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
      }

      .close-settings {
        background: none;
        border: none;
        color: #8b7355;
        font-size: 20px;
        cursor: pointer;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background 0.2s;
      }

      .close-settings:hover {
        background: rgba(139, 115, 85, 0.2);
      }

      .settings-body {
        padding: 15px 20px;
      }

      .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        font-size: 14px;
      }

      .setting-item.clickable {
        cursor: pointer;
        border-radius: 6px;
        padding: 10px;
        margin: 5px -10px;
        transition: background 0.2s;
      }

      .setting-item.clickable:hover {
        background: #f8f9fa;
      }

      .settings-body hr {
        border: none;
        height: 1px;
        background: #e0e0e0;
        margin: 10px 0;
      }

      @keyframes glow {
        from {
          text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 20px rgba(212, 194, 148, 0.5);
        }
        to {
          text-shadow: 2px 2px 4px rgba(139, 115, 85, 0.3), 0 0 30px rgba(212, 194, 148, 0.7);
        }
      }

      .add-btn {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(212, 194, 148, 0.3);
        border: 1px solid rgba(212, 194, 148, 0.5);
        color: #8b7355;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        z-index: 2;
      }

      .add-btn:hover {
        background: rgba(212, 194, 148, 0.5);
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 15px rgba(212, 194, 148, 0.4);
      }

      .friends-list {
        padding: 20px;
        background: #faf9f4;
        flex: 1;
        overflow-y: auto;
        max-height: calc(650px - 36px - 95px); /* 减去状态栏和header高度 */
      }

      /* 自定义滚动条样式 */
      .friends-list::-webkit-scrollbar {
        width: 6px;
      }

      .friends-list::-webkit-scrollbar-track {
        background: rgba(212, 194, 148, 0.1);
        border-radius: 3px;
      }

      .friends-list::-webkit-scrollbar-thumb {
        background: rgba(212, 194, 148, 0.4);
        border-radius: 3px;
      }

      .friends-list::-webkit-scrollbar-thumb:hover {
        background: rgba(212, 194, 148, 0.6);
      }

      .friend-item {
        display: flex;
        align-items: center;
        padding: 18px;
        margin-bottom: 12px;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #ffffff;
        border: 1px solid rgba(212, 194, 148, 0.2);
        box-shadow: 0 2px 8px rgba(212, 194, 148, 0.1);
        position: relative;
        overflow: hidden;
      }

      .friend-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(212, 194, 148, 0.1), transparent);
        transition: left 0.5s;
      }

      .friend-item:hover::before {
        left: 100%;
      }

      .friend-item:hover {
        background: #f9f7f0;
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 8px 25px rgba(212, 194, 148, 0.2);
        border-color: rgba(212, 194, 148, 0.4);
      }

      .friend-avatar {
        width: 55px;
        height: 55px;
        border-radius: 50%;
        background: linear-gradient(135deg, #d4c294 0%, #c9b882 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #8b7355;
        font-weight: bold;
        margin-right: 18px;
        font-size: 18px;
        text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.2);
        box-shadow: 0 4px 15px rgba(212, 194, 148, 0.3);
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
      }

      .friend-item:hover .friend-avatar {
        transform: scale(1.1) rotate(5deg);
        box-shadow: 0 6px 20px rgba(212, 194, 148, 0.4);
      }

      .friend-info {
        flex: 1;
        position: relative;
        z-index: 1;
      }

      .friend-name {
        font-size: 17px;
        font-weight: 500;
        color: #8b7355;
        margin-bottom: 6px;
        text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.1);
        letter-spacing: 0.5px;
      }

      .friend-type {
        font-size: 13px;
        color: rgba(139, 115, 85, 0.7);
        font-weight: 300;
      }

      .group-badge {
        background: rgba(212, 194, 148, 0.8);
        color: #8b7355;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        margin-left: 10px;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(212, 194, 148, 0.5);
        font-weight: 400;
        text-shadow: 1px 1px 2px rgba(139, 115, 85, 0.1);
      }

      .pinned-badge {
        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        color: white;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 10px;
        margin-left: 8px;
        font-weight: 500;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
      }

      .friend-item.pinned {
        background: linear-gradient(135deg, #fff9e6, #fff5d6);
        border-color: rgba(255, 193, 7, 0.3);
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
      }

      .friend-item.pinned:hover {
        background: linear-gradient(135deg, #fff7e0, #fff2cc);
        border-color: rgba(255, 193, 7, 0.5);
      }

      .friend-actions {
        display: flex;
        gap: 8px;
        margin-left: auto;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .friend-item:hover .friend-actions {
        opacity: 1;
      }

      .action-btn {
        width: 28px;
        height: 28px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
      }

      .pin-btn {
        background: rgba(255, 193, 7, 0.8);
        color: white;
      }

      .pin-btn:hover {
        background: rgba(255, 193, 7, 1);
        transform: scale(1.1);
      }

      .pin-btn.pinned {
        background: rgba(255, 107, 107, 0.8);
      }

      .pin-btn.pinned:hover {
        background: rgba(255, 107, 107, 1);
      }

      .delete-btn {
        background: rgba(255, 107, 107, 0.8);
        color: white;
      }

      .delete-btn:hover {
        background: rgba(255, 107, 107, 1);
        transform: scale(1.1);
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
      }

      .modal h2 {
        margin-bottom: 20px;
        color: #333;
        text-align: center;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: 500;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5a6fd8;
      }

      .btn-secondary {
        background: #e9ecef;
        color: #6c757d;
      }

      .btn-secondary:hover {
        background: #dee2e6;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="phone-shell">
      <div class="container">
        <div class="status-bar">
          <div>9:41</div>
          <div>📶 📶 📶 🔋</div>
        </div>
        <div class="header">
          <h1>好友列表</h1>
          <div class="header-actions">
            <button class="settings-btn" onclick="showSettingsMenu()" title="设置">⚙️</button>
            <button class="add-btn" onclick="openAddModal()">+</button>
          </div>
        </div>

        <div class="friends-list" id="friendsList">
          <div class="empty-state">
            <i>👥</i>
            <p>暂无好友，点击右上角添加好友或群聊</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 设置菜单 -->
    <div class="settings-menu" id="settingsMenu" style="display: none">
      <div class="settings-content">
        <div class="settings-header">
          <h3>好友列表设置</h3>
          <button class="close-settings" onclick="hideSettingsMenu()">×</button>
        </div>
        <div class="settings-body">
          <div class="setting-item">
            <span>当前角色</span>
            <span id="currentCharacterName">加载中...</span>
          </div>
          <div class="setting-item">
            <span>好友数量</span>
            <span id="friendsCount">0</span>
          </div>
          <hr />
          <div class="setting-item clickable" onclick="exportFriends()">
            <span>📤 导出好友列表</span>
          </div>
          <div class="setting-item clickable" onclick="document.getElementById('importFile').click()">
            <span>📥 导入好友列表</span>
          </div>
          <input type="file" id="importFile" accept=".json" style="display: none" onchange="importFriends(event)" />
          <hr />
          <div class="setting-item clickable" onclick="clearAllFriends()">
            <span style="color: #ff4757">🗑️ 清空好友列表</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 添加好友/群聊模态框 -->
    <div class="modal" id="addModal">
      <div class="modal-content">
        <!-- 第一步：选择类型 -->
        <div id="typeSelection">
          <h2>添加好友/群聊</h2>
          <p style="text-align: center; color: #666; margin-bottom: 20px">请选择要添加的类型</p>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="selectType('friend')">👤 添加好友</button>
            <button class="btn btn-primary" onclick="selectType('group')">👥 添加群聊</button>
          </div>
          <div style="text-align: center; margin-top: 15px">
            <button class="btn btn-secondary" onclick="closeAddModal()">取消</button>
          </div>
        </div>

        <!-- 第二步：添加好友 -->
        <div id="friendForm" style="display: none">
          <h2>添加好友</h2>
          <div class="form-group">
            <label for="friendName">好友姓名</label>
            <input type="text" id="friendName" placeholder="请输入好友姓名" />
          </div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="backToTypeSelection()">返回</button>
            <button class="btn btn-primary" onclick="addFriend()">添加好友</button>
          </div>
        </div>

        <!-- 第三步：添加群聊 -->
        <div id="groupForm" style="display: none">
          <h2>添加群聊</h2>
          <div class="form-group">
            <label for="groupName">群聊名称</label>
            <input type="text" id="groupName" placeholder="请输入群聊名称" />
          </div>
          <div class="form-group">
            <label for="groupMembers">群成员</label>
            <textarea id="groupMembers" placeholder="请输入群成员，用逗号隔开&#10;例如：张三,李四,王五"></textarea>
          </div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="backToTypeSelection()">返回</button>
            <button class="btn btn-primary" onclick="addGroup()">添加群聊</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==================== 角色卡相关功能 ====================

      // 获取当前活跃角色信息
      function getCurrentCharacterInfo() {
        try {
          // 尝试从SillyTavern获取当前角色信息
          if (typeof parent !== 'undefined' && parent.characters && parent.this_chid !== undefined) {
            const currentChar = parent.characters[parent.this_chid];
            if (currentChar) {
              return {
                id: currentChar.avatar || currentChar.name,
                name: currentChar.name,
                avatar: currentChar.avatar,
              };
            }
          }

          // 尝试从URL参数获取角色信息
          const urlParams = new URLSearchParams(window.location.search);
          const charName = urlParams.get('char') || urlParams.get('character');
          if (charName) {
            return {
              id: charName,
              name: charName,
              avatar: charName,
            };
          }

          // 尝试从localStorage获取最后使用的角色
          const lastChar = localStorage.getItem('lastActiveCharacter');
          if (lastChar) {
            const charInfo = JSON.parse(lastChar);
            return charInfo;
          }

          // 默认返回通用角色
          return {
            id: 'default',
            name: '默认角色',
            avatar: 'default',
          };
        } catch (error) {
          console.warn('获取角色信息失败，使用默认角色:', error);
          return {
            id: 'default',
            name: '默认角色',
            avatar: 'default',
          };
        }
      }

      // 保存当前角色信息到localStorage
      function saveCurrentCharacterInfo(charInfo) {
        try {
          localStorage.setItem('lastActiveCharacter', JSON.stringify(charInfo));
        } catch (error) {
          console.warn('保存角色信息失败:', error);
        }
      }

      // 获取角色专属的好友存储键名
      function getFriendsStorageKey(characterId) {
        return `friendsList_${characterId}`;
      }

      // 从本地存储加载好友列表（角色专属）
      function loadFriends() {
        const currentChar = getCurrentCharacterInfo();
        const storageKey = getFriendsStorageKey(currentChar.id);
        const friends = JSON.parse(localStorage.getItem(storageKey) || '[]');

        // 保存当前角色信息
        saveCurrentCharacterInfo(currentChar);

        // 更新界面显示当前角色
        updateCharacterDisplay(currentChar);

        displayFriends(friends);

        console.log(`已加载角色 "${currentChar.name}" 的好友列表:`, friends.length, '个好友');
      }

      // 更新界面显示当前角色信息
      function updateCharacterDisplay(charInfo) {
        // 更新设置菜单中的角色信息
        const charNameElement = document.getElementById('currentCharacterName');
        if (charNameElement) {
          charNameElement.textContent = charInfo.name;
        }

        // 可以在这里添加更多的界面更新逻辑
      }

      // 更新好友数量显示
      function updateFriendsCount(count) {
        const countElement = document.getElementById('friendsCount');
        if (countElement) {
          countElement.textContent = count;
        }
      }

      // 显示好友列表
      function displayFriends(friends) {
        const friendsList = document.getElementById('friendsList');

        // 更新好友数量显示
        updateFriendsCount(friends.length);

        if (friends.length === 0) {
          friendsList.innerHTML = `
                    <div class="empty-state">
                        <i>👥</i>
                        <p>暂无好友，点击右上角添加好友或群聊</p>
                    </div>
                `;
          return;
        }

        // 按置顶状态排序，置顶的在前面，但保留原始索引
        const sortedFriends = friends
          .map((friend, originalIndex) => ({ ...friend, originalIndex }))
          .sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return 0;
          });

        friendsList.innerHTML = sortedFriends
          .map(
            (friend, displayIndex) => `
                <div class="friend-item ${friend.pinned ? 'pinned' : ''}" onclick="startChat('${friend.name}', '${
              friend.type
            }', '${friend.members || ''}')">
                    <div class="friend-avatar">
                        ${friend.type === 'group' ? '👥' : friend.name.charAt(0)}
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">
                            ${friend.name}
                            ${friend.type === 'group' ? '<span class="group-badge">群聊</span>' : ''}
                            ${friend.pinned ? '<span class="pinned-badge">📌</span>' : ''}
                        </div>
                        <div class="friend-type">
                            ${friend.type === 'group' ? `成员: ${friend.members}` : '好友'}
                        </div>
                    </div>
                    <div class="friend-actions">
                        <button class="action-btn pin-btn ${friend.pinned ? 'pinned' : ''}"
                                onclick="event.stopPropagation(); togglePin(${friend.originalIndex})"
                                title="${friend.pinned ? '取消置顶' : '置顶'}">
                            ${friend.pinned ? '📌' : '📍'}
                        </button>
                        <button class="action-btn delete-btn"
                                onclick="event.stopPropagation(); deleteFriend(${friend.originalIndex})"
                                title="删除">
                            🗑️
                        </button>
                    </div>
                </div>
            `,
          )
          .join('');
      }

      // 打开添加模态框
      function openAddModal() {
        document.getElementById('addModal').style.display = 'block';
        showTypeSelection();
      }

      // 关闭添加模态框
      function closeAddModal() {
        document.getElementById('addModal').style.display = 'none';
        resetForms();
      }

      // 显示类型选择界面
      function showTypeSelection() {
        document.getElementById('typeSelection').style.display = 'block';
        document.getElementById('friendForm').style.display = 'none';
        document.getElementById('groupForm').style.display = 'none';
      }

      // 选择类型（好友或群聊）
      function selectType(type) {
        document.getElementById('typeSelection').style.display = 'none';

        if (type === 'friend') {
          document.getElementById('friendForm').style.display = 'block';
          document.getElementById('friendName').focus();
        } else if (type === 'group') {
          document.getElementById('groupForm').style.display = 'block';
          document.getElementById('groupName').focus();
        }
      }

      // 返回类型选择
      function backToTypeSelection() {
        resetForms();
        showTypeSelection();
      }

      // 重置表单
      function resetForms() {
        document.getElementById('friendName').value = '';
        document.getElementById('groupName').value = '';
        document.getElementById('groupMembers').value = '';
      }

      // 添加好友
      function addFriend() {
        const name = document.getElementById('friendName').value.trim();

        if (!name) {
          alert('请输入好友姓名');
          return;
        }

        const friends = JSON.parse(localStorage.getItem('friendsList') || '[]');

        // 检查是否已存在
        if (friends.some(friend => friend.name === name)) {
          alert('该好友已存在');
          return;
        }

        const newFriend = {
          name: name,
          type: 'friend',
          members: null,
          addTime: new Date().toISOString(),
        };

        friends.push(newFriend);

        // 保存到角色专属的存储空间
        const currentChar = getCurrentCharacterInfo();
        const storageKey = getFriendsStorageKey(currentChar.id);
        localStorage.setItem(storageKey, JSON.stringify(friends));

        displayFriends(friends);
        closeAddModal();

        alert(`好友 "${name}" 已添加到角色 "${currentChar.name}" 的好友列表！`);
      }

      // 添加群聊
      function addGroup() {
        const name = document.getElementById('groupName').value.trim();
        const members = document.getElementById('groupMembers').value.trim();

        if (!name) {
          alert('请输入群聊名称');
          return;
        }

        if (!members) {
          alert('请输入群成员');
          return;
        }

        const friends = JSON.parse(localStorage.getItem('friendsList') || '[]');

        // 检查是否已存在
        if (friends.some(friend => friend.name === name)) {
          alert('该群聊已存在');
          return;
        }

        const newGroup = {
          name: name,
          type: 'group',
          members: members,
          addTime: new Date().toISOString(),
        };

        friends.push(newGroup);

        // 保存到角色专属的存储空间
        const currentChar = getCurrentCharacterInfo();
        const storageKey = getFriendsStorageKey(currentChar.id);
        localStorage.setItem(storageKey, JSON.stringify(friends));

        displayFriends(friends);
        closeAddModal();

        alert(`群聊 "${name}" 已添加到角色 "${currentChar.name}" 的好友列表！`);
      }

      // 开始聊天
      function startChat(name, type, members) {
        if (typeof triggerSlash === 'function') {
          if (type === 'group') {
            const message = `/send <群成员：${members}>
【和${name}的聊天】
<qunliao>
</qunliao>`;
            triggerSlash(message);
          } else {
            const message = `/send 【和${name}的聊天】
<shouji>
</shouji>`;
            triggerSlash(message);
          }
        } else {
          // 如果triggerSlash不可用，显示消息内容
          if (type === 'group') {
            console.log(`<群成员：${members}>
【和${name}的聊天】
<qunliao>
</qunliao>`);
            alert(`群聊消息：<群成员：${members}>
【和${name}的聊天】
<qunliao>
</qunliao>`);
          } else {
            console.log(`【和${name}的聊天】
<shouji>
</shouji>`);
            alert(`好友消息：【和${name}的聊天】
<shouji>
</shouji>`);
          }
        }
      }

      // 点击模态框外部关闭
      document.getElementById('addModal').addEventListener('click', function (e) {
        if (e.target === this) {
          closeAddModal();
        }
      });

      // 回车键添加好友
      document.getElementById('friendName').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          addFriend();
        }
      });

      // 回车键添加群聊（群聊名称输入框）
      document.getElementById('groupName').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          document.getElementById('groupMembers').focus();
        }
      });

      // ==================== 好友管理功能 ====================

      // 显示提示消息
      function showToast(message) {
        // 创建提示元素
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 12px 20px;
          border-radius: 6px;
          font-size: 14px;
          z-index: 10000;
          animation: slideIn 0.3s ease-out;
        `;
        toast.textContent = message;

        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
          }
        `;
        document.head.appendChild(style);

        // 显示提示
        document.body.appendChild(toast);

        // 3秒后自动消失
        setTimeout(() => {
          toast.style.animation = 'slideOut 0.3s ease-out';
          setTimeout(() => {
            if (toast.parentNode) {
              document.body.removeChild(toast);
            }
            if (style.parentNode) {
              document.head.removeChild(style);
            }
          }, 300);
        }, 3000);
      }

      // 置顶/取消置顶好友
      function togglePin(index) {
        console.log('togglePin 被调用，索引:', index);

        const currentChar = getCurrentCharacterInfo();
        const storageKey = getFriendsStorageKey(currentChar.id);
        const friends = JSON.parse(localStorage.getItem(storageKey) || '[]');

        if (friends[index]) {
          const friendName = friends[index].name;
          const wasPin = friends[index].pinned;
          friends[index].pinned = !friends[index].pinned;

          localStorage.setItem(storageKey, JSON.stringify(friends));
          displayFriends(friends);

          const action = friends[index].pinned ? '置顶' : '取消置顶';
          console.log(`✅ ${action}好友: ${friendName}`);
          showToast(`${friendName} 已${action}`);
        } else {
          console.error('❌ 置顶失败：找不到指定索引的好友', index);
          showToast('操作失败：找不到指定的好友');
        }
      }

      // 删除好友
      function deleteFriend(index) {
        console.log('deleteFriend 被调用，索引:', index);

        const currentChar = getCurrentCharacterInfo();
        const storageKey = getFriendsStorageKey(currentChar.id);
        const friends = JSON.parse(localStorage.getItem(storageKey) || '[]');

        console.log('当前好友列表:', friends);
        console.log('要删除的索引:', index, '对应的好友:', friends[index]);

        if (friends[index]) {
          const friendName = friends[index].name;
          const friendType = friends[index].type === 'group' ? '群聊' : '好友';

          console.log(`准备删除${friendType}: ${friendName}`);

          if (confirm(`确定要删除${friendType} "${friendName}" 吗？`)) {
            console.log('用户确认删除');

            // 删除指定索引的好友
            friends.splice(index, 1);

            console.log('删除后的好友列表:', friends);

            // 保存更新后的好友列表
            localStorage.setItem(storageKey, JSON.stringify(friends));

            // 重新显示好友列表
            displayFriends(friends);

            console.log(`✅ 已删除${friendType}: ${friendName}`);

            // 显示删除成功的提示
            showToast(`${friendType} "${friendName}" 已删除`);
          } else {
            console.log('用户取消删除');
          }
        } else {
          console.error('❌ 删除失败：找不到指定索引的好友', index, '好友列表长度:', friends.length);
          showToast('删除失败：找不到指定的好友');
        }
      }

      // 切换角色时重新加载好友列表
      function switchCharacter(newCharInfo) {
        saveCurrentCharacterInfo(newCharInfo);
        loadFriends();
        console.log(`已切换到角色: ${newCharInfo.name}`);
      }

      // 导出当前角色的好友列表
      function exportFriends() {
        const currentChar = getCurrentCharacterInfo();
        const storageKey = getFriendsStorageKey(currentChar.id);
        const friends = JSON.parse(localStorage.getItem(storageKey) || '[]');

        const exportData = {
          character: currentChar,
          friends: friends,
          exportTime: new Date().toISOString(),
          version: '1.0',
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `好友列表_${currentChar.name}_${new Date().toISOString().slice(0, 10)}.json`;
        link.click();

        console.log(`已导出角色 "${currentChar.name}" 的好友列表`);
      }

      // 导入好友列表
      function importFriends(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const importData = JSON.parse(e.target.result);

            if (importData.friends && Array.isArray(importData.friends)) {
              const currentChar = getCurrentCharacterInfo();
              const storageKey = getFriendsStorageKey(currentChar.id);

              if (
                confirm(
                  `确定要导入 ${importData.friends.length} 个好友到角色 "${currentChar.name}" 吗？这将覆盖现有的好友列表。`,
                )
              ) {
                localStorage.setItem(storageKey, JSON.stringify(importData.friends));
                displayFriends(importData.friends);

                console.log(`已导入 ${importData.friends.length} 个好友到角色 "${currentChar.name}"`);
                alert(`成功导入 ${importData.friends.length} 个好友！`);
              }
            } else {
              alert('导入文件格式不正确！');
            }
          } catch (error) {
            console.error('导入失败:', error);
            alert('导入失败，请检查文件格式！');
          }
        };
        reader.readAsText(file);
      }

      // ==================== 设置菜单功能 ====================

      // 显示设置菜单
      function showSettingsMenu() {
        const menu = document.getElementById('settingsMenu');
        menu.style.display = 'flex';

        // 更新当前信息
        const currentChar = getCurrentCharacterInfo();
        updateCharacterDisplay(currentChar);

        const storageKey = getFriendsStorageKey(currentChar.id);
        const friends = JSON.parse(localStorage.getItem(storageKey) || '[]');
        updateFriendsCount(friends.length);
      }

      // 隐藏设置菜单
      function hideSettingsMenu() {
        const menu = document.getElementById('settingsMenu');
        menu.style.display = 'none';
      }

      // 清空当前角色的好友列表
      function clearAllFriends() {
        const currentChar = getCurrentCharacterInfo();

        if (confirm(`确定要清空角色 "${currentChar.name}" 的所有好友吗？此操作不可撤销！`)) {
          const storageKey = getFriendsStorageKey(currentChar.id);
          localStorage.removeItem(storageKey);

          displayFriends([]);
          hideSettingsMenu();

          console.log(`已清空角色 "${currentChar.name}" 的好友列表`);
          alert('好友列表已清空！');
        }
      }

      // 点击设置菜单外部关闭
      document.getElementById('settingsMenu').addEventListener('click', function (e) {
        if (e.target === this) {
          hideSettingsMenu();
        }
      });

      // 页面加载时加载好友列表
      window.addEventListener('load', loadFriends);

      // 监听SillyTavern的角色切换事件（如果可用）
      if (typeof parent !== 'undefined') {
        // 定期检查角色是否切换
        let lastCharId = null;
        setInterval(() => {
          const currentChar = getCurrentCharacterInfo();
          if (currentChar.id !== lastCharId) {
            lastCharId = currentChar.id;
            loadFriends();
          }
        }, 2000); // 每2秒检查一次
      }
    </script>
  </body>
</html>
